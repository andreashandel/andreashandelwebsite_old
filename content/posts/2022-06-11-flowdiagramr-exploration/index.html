---
title: Exploring the `flowdiagramr` R package  
summary: A brief post showing how to use the `flowdiagramr` R package to make flowcharts.
author: Andreas Handel
date: '2022-06-11'
lastMod: "2022-06-1"
slug: flowdiagramr-R-package
categories: 
- R
- Visualization
tags: 
- R
- Visualization
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
---



<div id="motivation" class="section level1">
<h1>Motivation</h1>
<p>For a while now, we‚Äôve been working on an R package called <a href="https://andreashandel.github.io/flowdiagramr/"><code>flowdiagramr</code></a> which lets you create flow diagrams in <code>R</code>. The main reason we wrote this package is because while there are other <code>R</code> packages that can generate diagrams, I couldn‚Äôt find one that allowed me to create flow diagrams for the kind of compartmental simulation models that I often use in research and teaching. For instance right now, all model diagrams in my population-level and within-host modeling packages <a href="https://ahgroup.github.io/DSAIDE/">DSAIDE</a> and <a href="https://ahgroup.github.io/DSAIRM/">DSAIRM</a> are drawn by hand.</p>
<p>While the main focus of <code>flowdiagramr</code> is to produce diagrams for those kind of dynamical process models with feedback loops, it can also be used to create other flow diagrams.</p>
<p>As of this writing, we are preparing for an initial CRAN submission. I‚Äôve been updating the package vignettes with hopefully useful examples. By chance, I recently came across a tweet by <a href="https://nrennie.rbind.io/">Nicola Rennie</a> pointing to <a href="https://nrennie.rbind.io/blog/2022-06-06-creating-flowcharts-with-ggplot2/">this blog post</a> she wrote. The blog post shows how to make a nice flow diagram using <code>ggplot2()</code>.</p>
<p>I figured it would be fun to try and redo this using <code>flowdiagramr</code>. The following post shows that attempt.</p>
</div>
<div id="who-this-is-not-for" class="section level1">
<h1>Who this is (not) for</h1>
<p>If you are interested in making diagrams using R and are looking for an option that might do things that current packages such as <code>diagrammR</code> or others can‚Äôt do, you might want to follow along.</p>
<p>The <a href="https://andreashandel.github.io/flowdiagramr/"><code>flowdiagramr</code> package</a> has (in my biased opinion) fairly decent documentation and vignettes. I‚Äôm not going to repeat all that here. I basically assume that if you want to try this out, you go to the package website and skim through the first few vignettes to get an idea of how things work. Then come back here. Or first skim through this post, then if you want, go and explore the package vignettes more.</p>
</div>
<div id="general-setup" class="section level1">
<h1>General setup</h1>
<p>The following shows code and my comments mixed together. It‚Äôs often useful to go slow and type your own code, or copy and paste the code chunks below and execute one at a time. However, if you are in a hurry, you can find all the code shown below in <a href="/posts/flowdiagramr-R-package/flowdiagramr-exploration.R">this file</a>.</p>
<p>First we load all needed packages.</p>
<pre class="r"><code>library(&#39;ggplot2&#39;)
library(&#39;flowdiagramr&#39;)
library(&#39;sysfonts&#39;) #for extra fonts
library(&#39;showtext&#39;) #for extra fonts</code></pre>
</div>
<div id="diagram-setup" class="section level1">
<h1>Diagram setup</h1>
<p>Now we specify the model. Generally, a model consists of variables/compartments/boxes and flows/arrows connecting the boxes.
This code chunk defines the variables/boxes, gives them names (used later), and provides the box grid layout as a matrix.</p>
<pre class="r"><code># the unique internal labels, just abbreviations of the full names
variables = c(&quot;GL&quot;,&quot;P&quot;,&quot;PTH&quot;,&quot;PTC&quot;,&quot;PJR&quot;,
              &quot;C&quot;,&quot;CTB&quot;,&quot;CTS&quot;,&quot;CJR&quot;,
              &quot;B&quot;,&quot;BTH&quot;,&quot;BTS&quot;,&quot;BJR&quot;,
              &quot;BE&quot;)
# the eventual names for all boxes
# we&#39;ll use that later to label the boxes
varnames = c(&quot;Goldilocks&quot;,
             &quot;Porridge&quot;,
             &quot;Too hot&quot;,&quot;Too cold&quot;,&quot;Just right&quot;,
             &quot;Chairs&quot;,
             &quot;Too big&quot;, &quot;Too small&quot;, &quot;Just right&quot;,
             &quot;Beds&quot;,
             &quot;Too hard&quot;,&quot;Too soft&quot;,&quot;Just right&quot;,
             &quot;Bears!&quot;)
# assigning the varnames the variable labels
# needed later
names(varnames) &lt;- variables
# a matrix specifying the locations on a matrix grid layout
# this mimics the look of the original blog post
varlocations = matrix(data = c(&quot;&quot;,&quot;GL&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;,
                               &quot;&quot;,&quot;P&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;,
                               &quot;PTH&quot;,&quot;PTC&quot;, &quot;PJR&quot;, &quot;&quot;, &quot;&quot;,
                               &quot;&quot;,   &quot;&quot;,    &quot;C&quot;, &quot;&quot;, &quot;&quot;,
                               &quot;&quot;,&quot;CTB&quot;,  &quot;CTS&quot;, &quot;CJR&quot;, &quot;&quot;,
                               &quot;&quot;,   &quot;&quot;,   &quot;&quot;,   &quot;B&quot;, &quot;&quot;,
                               &quot;&quot;,   &quot;&quot;, &quot;BTH&quot;, &quot;BTS&quot;, &quot;BJR&quot;,
                               &quot;&quot;,   &quot;&quot;, &quot;&quot;,     &quot;&quot;, &quot;BE&quot;
                      ), ncol = 5, byrow = TRUE)</code></pre>
<p>The second component of every model are the flows between compartments/variables/boxes. Since <code>flowdiagramr</code> has as underlying logic the idea that flows occur between compartments, one needs to set up things as processes in such a way.</p>
<pre class="r"><code># setting up the inflows and outflows (arrows) for each box
flows = list( GL_flows = c(&quot;-k1*GL&quot;),
              P_flows = c(&quot;k1*GL&quot;,&quot;-k2*P&quot;,&quot;-k3*P&quot;,&quot;-k4*P&quot;),
              PTH_flows = c(&quot;k2*P&quot;),
              PTC_flows = c(&quot;k3*P&quot;),
              PJR_flows = c(&quot;k4*P&quot;,&quot;-k5*PJR&quot;),
              C_flows = c(&quot;k5*PJR&quot;,&quot;-k6*C&quot;,&quot;-k7*C&quot;,&quot;-k8*C&quot;),
              CTB_flows = c(&quot;k6*C&quot;),
              CTS_flows = c(&quot;k7*C&quot;),
              CJR_flows = c(&quot;k8*C&quot;,&quot;-k9*CJR&quot;),
              B_flows = c(&quot;k9*CJR&quot;,&quot;-k10*B&quot;,&quot;-k11*B&quot;,&quot;-k12*B&quot;),
              BTH_flows = c(&quot;k10*B&quot;),
              BTS_flows = c(&quot;k11*B&quot;),
              BJR_flows = c(&quot;k12*B&quot;,&quot;-k13*BJR&quot;),
              BE_flows = c(&quot;k13*BJR&quot;)
)</code></pre>
</div>
<div id="diagram-preparation" class="section level1">
<h1>Diagram preparation</h1>
<p>The first step for each <code>flowdiagramr</code> diagram is the preparation stage using the <code>prepare_diagram()</code> function. For that, one needs to supply the model as a list of variables and flows (boxes and arrows) and optional layout specifications.</p>
<pre class="r"><code># model object
gl_model = list(variables = variables, flows = flows)
# model layout
model_settings = list(varlocations=varlocations,
                      varbox_x_size = 3)
# prepare model
gl_list = flowdiagramr::prepare_diagram(gl_model, model_settings)</code></pre>
</div>
<div id="diagram-styling" class="section level1">
<h1>Diagram styling</h1>
<p>The return from <code>prepare_diagram</code> is a list of data frames containing information about the variables and flows needed for plotting. One could go straight to making the diagram with <code>make_diagram</code>. But we already know the default doesn‚Äôt look like the blog post, therefore we apply some styling, which is done with the <code>update_diagram</code> function.</p>
<pre class="r"><code>#set colors that are similar to original blog post
varcolors = c(&quot;#b59dac&quot;, rep(c(&quot;#D9AF6B&quot;, &quot;#ACACAC&quot;,&quot;#ACACAC&quot;,&quot;#ACACAC&quot;),3), &quot;#b59dac&quot;)
# make them a named vector since that&#39;s required by update_diagram
names(varcolors) = variables
# list of all style updates we want
diagram_settings = list(var_fill_color = varcolors,
                        var_label_text = varnames,
                        var_label_color = c(all =  &quot;#585c45&quot;),
                        flow_show_label = c(all = FALSE),
                        var_label_size = c(all = 4))

# update the look
gl_list2 &lt;- flowdiagramr::update_diagram(gl_list,diagram_settings)</code></pre>
</div>
<div id="diagram-generation" class="section level1">
<h1>Diagram generation</h1>
<p>Now we can make and plot the diagram</p>
<pre class="r"><code># create and plot diagram
gl_diag &lt;- flowdiagramr::make_diagram(gl_list2)
plot(gl_diag)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/makediag-1.png" width="672" /></p>
<p>The result looks somewhat similar to the original, but not quite yet.</p>
</div>
<div id="more-diagram-styling" class="section level1">
<h1>More diagram styling</h1>
<p>The above is as far as we can get with <code>flowdiagramr</code>. The good news is that the created object is a a regular <code>ggplot</code> object and thus we can modify it further using <code>ggplot2</code> code. A lot of this follows the original blog post, see there for details.</p>
<pre class="r"><code># get different fonts
sysfonts::font_add_google(name = &quot;Henny Penny&quot;, family = &quot;henny&quot;)
showtext::showtext_auto()

# update the plot by adding ggplot2 commands
gl_diag2 &lt;- gl_diag  +
       labs(title = &quot;The Goldilocks Decision Tree&quot;,
            caption = &quot;Made with flowdiagramr:\n https://andreashandel.github.io/flowdiagramr/&quot;) +
       theme_void() +
        theme(plot.margin = unit(c(1, 1, 0.5, 1), &quot;cm&quot;),
        legend.position = &quot;none&quot;,
        plot.background = element_rect(colour = &quot;#f2e4c1&quot;, fill = &quot;#f2e4c1&quot;),
        panel.background = element_rect(colour = &quot;#f2e4c1&quot;, fill = &quot;#f2e4c1&quot;),
        plot.title = element_text(family = &quot;henny&quot;, hjust = 0, face = &quot;bold&quot;,
                                  size = 45, color = &quot;#585c45&quot;,
                                  margin = margin(t = 10, r = 0, b = 10, l = 0)),
        plot.caption = element_text(family = &quot;henny&quot;, hjust = 0,
                                    size = 16, color = &quot;#585c45&quot;,
                                    margin = margin(t = 10)),
       text = element_text(family = &quot;henny&quot;)
       )</code></pre>
<p>Now we can plot it again</p>
<pre class="r"><code>plot(gl_diag2)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/plotupdate-1.png" width="672" /></p>
<p>This plot is fairly close. I‚Äôm skipping the addition of the image since that was done manually.</p>
<p>One aspect that isn‚Äôt working is having the font in the boxes be the the <code>henry</code> style. I did try to supply it by setting <code>text = element_text(family = "henny")</code>, but it seems that doesn‚Äôt work after one has already written the text. I‚Äôm not aware of a way to update text in an ggplot once it‚Äôs already placed (I wouldn‚Äôt be surprised if that‚Äôs possible, I just don‚Äôt know how.) Fortunately, we can fix that in a different way.</p>
</div>
<div id="even-more-diagram-styling" class="section level1">
<h1>Even more diagram styling</h1>
<p>Let‚Äôs see if we can fix the font issue. While setting the font through <code>update_diagram</code> is on the to-do list, as of this writing, this feature does not yet exist (contributions welcome üòÅ).</p>
<p>We can however ask <code>flowdiagramr</code> to write all the <code>ggplot2</code> code that produces the diagram into a file, then modify ourselves.</p>
<p>This writes the full ggplot code to an R script file:</p>
<pre class="r"><code>write_diagram(gl_list2,filename = &quot;gl_diag.R&quot;, always_overwrite = TRUE)</code></pre>
<pre><code>## [1] &quot;Your file was saved here: D:/GitHub/andreashandel/andreashandelwebsite/content/posts/2022-06-11-flowdiagramr-exploration/gl_diag.R&quot;</code></pre>
<p>Now we can open that file, find the part that creates the text for the boxes (that part starts with ‚Äúadd label text‚Äù) and simply add this part <code>family = "henny"</code> into the <code>geom_text()</code> statement. We‚Äôll also copy the commands from above to the end of the script to update the <code>diagram_plot</code> object. Then we‚Äôll save the updated file, source it, and thus have an updated diagram. <a href="/posts/flowdiagramr-R-package/gl_diag_mod.R">Here</a> is the updated script if it‚Äôs not clear what I‚Äôm doing.</p>
<pre class="r"><code>source(&quot;gl_diag_mod.R&quot;)
# plot new diagram
plot(diagram_plot)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/newdiagcode-1.png" width="672" /></p>
<p>So that worked, very close to the original!</p>
</div>
<div id="a-bit-more-exploration" class="section level1">
<h1>A bit more exploration</h1>
<p>For this specific diagram, using <code>flowdiagramr</code> is maybe not that much better than the original version. However, once one wants to include further features, including loops, <code>flowdiagramr</code> shows its strength. To illustrate this, let‚Äôs add a flows that shows that after Goldilock sits in the right chair, it induces hunger and she eats more porridge. (Yes, it‚Äôs silly, but I want to show how that can easily be implemented with <code>flowdiagramr</code>).</p>
<p>To show that, we update the flows as follows</p>
<pre class="r"><code># need to define again since the above file overwrote it
variables = c(&quot;GL&quot;,&quot;P&quot;,&quot;PTH&quot;,&quot;PTC&quot;,&quot;PJR&quot;,
              &quot;C&quot;,&quot;CTB&quot;,&quot;CTS&quot;,&quot;CJR&quot;,
              &quot;B&quot;,&quot;BTH&quot;,&quot;BTS&quot;,&quot;BJR&quot;,
              &quot;BE&quot;)

# more complex flows
flowsnew = list( GL_flows = c(&quot;-k1*GL&quot;),
              P_flows = c(&quot;k1*GL&quot;,&quot;-k2*P&quot;,&quot;-k3*P&quot;,&quot;-k4*P&quot;,&quot;-kk1*P*CJR&quot;),
              PTH_flows = c(&quot;k2*P&quot;,&quot;k3a*PTC&quot;),
              PTC_flows = c(&quot;k3*P&quot;,&quot;-k3a*PTC&quot;),
              PJR_flows = c(&quot;k4*P&quot;,&quot;-k5*PJR&quot;,&quot;kk1*P*CJR&quot;),
              C_flows = c(&quot;k5*PJR&quot;,&quot;-k6*C&quot;,&quot;-k7*C&quot;,&quot;-k8*C&quot;),
              CTB_flows = c(&quot;k6*C&quot;),
              CTS_flows = c(&quot;k7*C&quot;),
              CJR_flows = c(&quot;k8*C&quot;,&quot;-k9*CJR&quot;),
              B_flows = c(&quot;k9*CJR&quot;,&quot;-k10*B&quot;,&quot;-k11*B&quot;,&quot;-k12*B&quot;),
              BTH_flows = c(&quot;k10*B&quot;),
              BTS_flows = c(&quot;k11*B&quot;),
              BJR_flows = c(&quot;k12*B&quot;,&quot;-k13*BJR&quot;),
              BE_flows = c(&quot;k13*BJR&quot;)
)</code></pre>
<p>Then we do the above steps to create the diagram:</p>
<pre class="r"><code># model object
gl_model_new = list(variables = variables, flows = flowsnew)
# model layout
model_settings = list(varlocations=varlocations,
                      varbox_x_size = 3)
# prepare model
gl_list_new = flowdiagramr::prepare_diagram(gl_model_new, model_settings)
# update the look
gl_list_new2 &lt;- flowdiagramr::update_diagram(gl_list_new,diagram_settings)
# create and plot diagram
gl_diag_new &lt;- flowdiagramr::make_diagram(gl_list_new2)
plot(gl_diag_new)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/preparemakenew-1.png" width="672" /></p>
<pre class="r"><code>ggsave(&#39;featured.png&#39;,diagram_plot)</code></pre>
<pre><code>## Saving 7 x 5 in image</code></pre>
<p>I‚Äôm skipping the font adjustment and other parts, but of course you can apply that again. This ability to create feedback loops - which are very common in scientific process/simulation/mechanistic models - is the reason we built <code>flowdiagramr</code>. But as you saw, it can be used for all kinds of diagrams.</p>
</div>
<div id="further-resources" class="section level1">
<h1>Further resources</h1>
<p>The <a href="https://andreashandel.github.io/flowdiagramr/"><code>flowdiagramr</code> website</a> has a bunch of vignettes/tutorials with lots of examples and further use cases. If you are intrigued by this post, go check it out üòÑ.</p>
</div>
<div id="acknowledgments" class="section level1">
<h1>Acknowledgments</h1>
<p>Development of <code>flowdiagramr</code> is a joint effort between myself and <a href="https://atredennick.github.io/">Andrew Tredennick</a>, who did the majority of the actual coding work.</p>
</div>
