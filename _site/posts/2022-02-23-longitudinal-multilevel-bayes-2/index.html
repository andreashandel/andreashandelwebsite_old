<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andreas Handel">
<meta name="dcterms.date" content="2022-02-23">
<meta name="description" content="Andreas Handel’s personal website.">

<title>Andreas Handel - Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../..//files/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script type="text/plain" cookie-consent="tracking">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-48442618-4', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script> 
  

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../customstyle.css">
<meta name="twitter:title" content="Andreas Handel - Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 2">
<meta name="twitter:description" content="Part 2 of a tutorial showing how to fit Bayesian models using the `rethinking` package.">
<meta name="twitter:image" content="https://www.andreashandel.com/posts\2022-02-23-longitudinal-multilevel-bayes-2\featured.png">
<meta name="twitter:creator" content="@andreashandel">
<meta name="twitter:image-height" content="1800">
<meta name="twitter:image-width" content="1800">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../files/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Andreas Handel</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html">
 <span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../presentations.html">
 <span class="menu-text">Presentations</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html">
 <span class="menu-text">Projects</span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 2</h1>
                  <div>
        <div class="description">
          Part 2 of a tutorial showing how to fit Bayesian models using the <code>rethinking</code> package.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">Data Analysis</div>
                <div class="quarto-category">Bayesian</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Andreas Handel </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 23, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#r-setup" id="toc-r-setup" class="nav-link" data-scroll-target="#r-setup">R Setup</a></li>
  <li><a href="#data-loading" id="toc-data-loading" class="nav-link" data-scroll-target="#data-loading">Data loading</a></li>
  <li><a href="#fitting-with-rethinking" id="toc-fitting-with-rethinking" class="nav-link" data-scroll-target="#fitting-with-rethinking">Fitting with rethinking</a>
  <ul class="collapse">
  <li><a href="#model-1" id="toc-model-1" class="nav-link" data-scroll-target="#model-1">Model 1</a></li>
  <li><a href="#model-2" id="toc-model-2" class="nav-link" data-scroll-target="#model-2">Model 2</a></li>
  <li><a href="#model-3" id="toc-model-3" class="nav-link" data-scroll-target="#model-3">Model 3</a></li>
  <li><a href="#model-4" id="toc-model-4" class="nav-link" data-scroll-target="#model-4">Model 4</a></li>
  <li><a href="#a-few-model-alternatives" id="toc-a-few-model-alternatives" class="nav-link" data-scroll-target="#a-few-model-alternatives">A few model alternatives</a>
  <ul class="collapse">
  <li><a href="#model-2a" id="toc-model-2a" class="nav-link" data-scroll-target="#model-2a">Model 2a</a></li>
  <li><a href="#model-4a" id="toc-model-4a" class="nav-link" data-scroll-target="#model-4a">Model 4a</a></li>
  <li><a href="#model-5" id="toc-model-5" class="nav-link" data-scroll-target="#model-5">Model 5</a></li>
  </ul></li>
  <li><a href="#setting-starting-values" id="toc-setting-starting-values" class="nav-link" data-scroll-target="#setting-starting-values">Setting starting values</a></li>
  <li><a href="#model-fitting" id="toc-model-fitting" class="nav-link" data-scroll-target="#model-fitting">Model fitting</a></li>
  </ul></li>
  <li><a href="#explore-model-fits" id="toc-explore-model-fits" class="nav-link" data-scroll-target="#explore-model-fits">Explore model fits</a>
  <ul class="collapse">
  <li><a href="#models-1-and-3" id="toc-models-1-and-3" class="nav-link" data-scroll-target="#models-1-and-3">Models 1 and 3</a></li>
  <li><a href="#comparing-model-estimates-with-the-truth" id="toc-comparing-model-estimates-with-the-truth" class="nav-link" data-scroll-target="#comparing-model-estimates-with-the-truth">Comparing model estimates with the truth</a></li>
  <li><a href="#models-2-and-2a" id="toc-models-2-and-2a" class="nav-link" data-scroll-target="#models-2-and-2a">Models 2 and 2a</a></li>
  <li><a href="#models-4-and-4a" id="toc-models-4-and-4a" class="nav-link" data-scroll-target="#models-4-and-4a">Models 4 and 4a</a></li>
  <li><a href="#model-5-1" id="toc-model-5-1" class="nav-link" data-scroll-target="#model-5-1">Model 5</a></li>
  </ul></li>
  <li><a href="#computing-predictions" id="toc-computing-predictions" class="nav-link" data-scroll-target="#computing-predictions">Computing predictions</a></li>
  <li><a href="#creating-plots-of-the-results" id="toc-creating-plots-of-the-results" class="nav-link" data-scroll-target="#creating-plots-of-the-results">Creating plots of the results</a></li>
  <li><a href="#showing-the-plots" id="toc-showing-the-plots" class="nav-link" data-scroll-target="#showing-the-plots">Showing the plots</a>
  <ul class="collapse">
  <li><a href="#models-1-and-3-1" id="toc-models-1-and-3-1" class="nav-link" data-scroll-target="#models-1-and-3-1">Models 1 and 3</a></li>
  <li><a href="#models-2-and-2a-1" id="toc-models-2-and-2a-1" class="nav-link" data-scroll-target="#models-2-and-2a-1">Models 2 and 2a</a></li>
  <li><a href="#models-4-and-4a-1" id="toc-models-4-and-4a-1" class="nav-link" data-scroll-target="#models-4-and-4a-1">Models 4 and 4a</a></li>
  <li><a href="#model-5-2" id="toc-model-5-2" class="nav-link" data-scroll-target="#model-5-2">Model 5</a></li>
  </ul></li>
  <li><a href="#summary-and-continuation" id="toc-summary-and-continuation" class="nav-link" data-scroll-target="#summary-and-continuation">Summary and continuation</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>This is part two of a tutorial illustrating how to perform a Bayesian analysis of longitudinal data using a multilevel/hierarchical/mixed-effects setup. In this part, we’ll fit the simulated data using the <code>rethinking</code> package.</p>
<p>I assume you’ve read <a href="../../posts/longitudinal-multilevel-bayesian-analysis-1/">part 1</a>, otherwise this post won’t make much sense. You might even want to open that first part in a separate tab for quick comparison.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In the previous post, I showed a setup where some continuous outcome data (in our case, virus load) was collected over time for several individuals. Those individuals differed by some characteristic (in our case, dose at which they got infected). I specified several models that are useful for both fitting the data, and creating simulations. We’ve done the simulating part, now we’ll start fitting models to that data.</p>
<p>The advantage of fitting to simulated data is that we know exactly what model and what parameters produced the data, so we can compare our model estimates to the truth (i.e.&nbsp;the parameter and model settings that were used to generate the data) to see how our models perform. It is always good to do that to get some confidence that your models make sense, before you apply them to real data. For the latter, you don’t know what the “truth” is, so you have to trust whatever your model tells you.</p>
<p>Fitting Bayesian models can take a good bit of time (hours, depending on the settings for the fitting routine). It is generally advisable to place code that takes a while to run into its own <code>R</code> script, run that script and then save the results for further processing. This is in fact what I did here. I wrote 2 separate R scripts, one that does the fitting and one that does the exploration of the model fits. The code shown below comes from those 2 scripts. There is some value in re-coding yourself by copying and pasting the code chunks from this tutorial, but if you just want to get all the code from this post you can find it <a href="ulamfitmodels.R">here</a> and <a href="ulamexploremodels.R">here</a>.</p>
</section>
<section id="r-setup" class="level1">
<h1>R Setup</h1>
<p>We’ll start with loading needed packages. Make sure these packages are installed. Since <code>rethinking</code> uses the <a href="https://mc-stan.org/">Stan Bayesian modeling engine</a>, you need to install it too. It is in my experience mostly seamless, but at times it seems to be tricky. I generally follow the instructions on the <a href="https://github.com/rmcelreath/rethinking"><code>rethinking</code> website</a> and it has so far always worked for me. It might need some fiddling, but you should be able to get them all to work.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'dplyr'</span>) <span class="co"># for data manipulation</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'ggplot2'</span>) <span class="co"># for plotting</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'cmdstanr'</span>) <span class="co">#for model fitting</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'rethinking'</span>) <span class="co">#for model fitting</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'fs'</span>) <span class="co">#for file path</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-loading" class="level1">
<h1>Data loading</h1>
<p>We’ll jump right in and load the data we generated in the previous tutorial. In this example, I’m fitting the data that was generated by model 3 since it shows the most realistic pattern. You can try to fit to the other 2 datasets and see what you find (I’ll show an example in <a href="https://www.andreashandel.com/posts/longitudinal-multilevel-bayesian-analysis-4/">this part of the tutorial</a>. It is not necessarily the case that the model that produced a certain dataset is also the one that fits it best.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>simdat <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"simdat.Rds"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#using dataset 3 for fitting</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#also removing anything in the dataframe that's not used for fitting</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#makes the ulam/Stan code more robust</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>fitdat<span class="ot">=</span><span class="fu">list</span>(<span class="at">id=</span>simdat[[<span class="dv">3</span>]]<span class="sc">$</span>id,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">outcome =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>outcome,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose_adj =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose_adj,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">time =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>time)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#pulling out number of observations</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>Ntot <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(simdat<span class="sc">$</span>m3<span class="sc">$</span>id))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fitting-with-rethinking" class="level1">
<h1>Fitting with rethinking</h1>
<p>We’ll start by fitting the different models we discussed in <a href="../../posts/longitudinal-multilevel-bayesian-analysis-1/">part 1</a> using the <code>rethinking</code> package. The main function in that package, which does the fitting using <a href="https://mc-stan.org/">Stan</a>, is <code>ulam</code>.</p>
<p>First, we’ll specify each model, then we’ll run them all in a single loop.</p>
<section id="model-1" class="level2">
<h2 class="anchored" data-anchor-id="model-1">Model 1</h2>
<p>These lines of code specify the full set of equations for our model 1. Note how closely the R code resembles the mathematical notation. That close match between math and code is one of the nice features of <code>rethinking</code>/<code>ulam</code>. Also note the indexing of the parameters <code>a0</code> and <code>b0</code> by <code>id</code>, which indicates that each individual has their own values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#wide-prior, no-pooling model</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#separate intercept for each individual/id</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#2x(N+1)+1 parameters</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># distribution of outcome</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># main equation for time-series trajectory</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#equations for alpha and beta</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span>  a0[id] <span class="sc">+</span> a1<span class="sc">*</span>dose_adj,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span>  b0[id] <span class="sc">+</span> b1<span class="sc">*</span>dose_adj,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#priors</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  a0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">2</span>,  <span class="dv">10</span>),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  b0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">10</span>),</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  a1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  b1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You might have noticed that I chose some of the values in the priors to be different than the values we used to generate the simulated data. I don’t want to make things too easy for the fitting routine 😁. We want to have the fitting routine “find” the right answer (parameter estimates). Hopefully, even if we don’t start at the right values, we’ll end up there.</p>
</section>
<section id="model-2" class="level2">
<h2 class="anchored" data-anchor-id="model-2">Model 2</h2>
<p>Now we’ll set up model 2 exactly as for model 1 but with some of the priors changed as discussed previously. Specifically, the priors now force the individual-level parameters to be essentially all the same. Note that - as you will see below - this model is not a good model, and if one wanted to not allow the <span class="math inline">\(a_0\)</span> and <span class="math inline">\(b_0\)</span> parameters to have any individual level variation, one should just implement and run the model 2 alternative I describe below. We’ll run this model anyway, to just illustration and to see what happens.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#narrow-prior, full-pooling model</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#2x(N+2)+1 parameters</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span>  a0[id] <span class="sc">+</span> a1<span class="sc">*</span>dose_adj,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span>  b0[id] <span class="sc">+</span> b1<span class="sc">*</span>dose_adj,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  a0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(mu_a,  <span class="fl">0.0001</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  b0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(mu_b, <span class="fl">0.0001</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  mu_a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  mu_b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  a1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  b1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-3" class="level2">
<h2 class="anchored" data-anchor-id="model-3">Model 3</h2>
<p>This is the same as model 1 but with different values for the priors. These priors are somewhat regularizing and more reasonable. As we’ll see, the results are similar to those from model 1, but the model runs more efficiently and thus faster.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#regularizing prior, partial-pooling model</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span>  a0[id] <span class="sc">+</span> a1<span class="sc">*</span>dose_adj,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span>  b0[id] <span class="sc">+</span> b1<span class="sc">*</span>dose_adj,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  a0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">2</span>,  <span class="dv">1</span>),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  b0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  a1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  b1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-4" class="level2">
<h2 class="anchored" data-anchor-id="model-4">Model 4</h2>
<p>This is our adaptive pooling model. For this model, we specify a few extra distributions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#adaptive priors, partial-pooling model</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#2x(N+2)+1 parameters</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span>  a0[id] <span class="sc">+</span> a1<span class="sc">*</span>dose_adj,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span>  b0[id] <span class="sc">+</span> b1<span class="sc">*</span>dose_adj,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  a0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(mu_a,  sigma_a),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  b0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(mu_b, sigma_b),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  mu_a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  mu_b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  sigma_a <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  sigma_b <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  a1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  b1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-few-model-alternatives" class="level2">
<h2 class="anchored" data-anchor-id="a-few-model-alternatives">A few model alternatives</h2>
<p>There are a few model alternatives I also want to consider. The first one is a version of model 2 that gets rid of individual-level parameters and instead has only population-level parameters. I discussed this model in part 1 of the tutorial and called it 2a there. Here is the model definition</p>
<section id="model-2a" class="level3">
<h3 class="anchored" data-anchor-id="model-2a">Model 2a</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#full-pooling model, population-level parameters only</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#2+2+1 parameters</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>m2a <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span>  a0 <span class="sc">+</span> a1<span class="sc">*</span>dose_adj,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span>  b0 <span class="sc">+</span> b1<span class="sc">*</span>dose_adj,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  a0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">2</span>,  <span class="fl">0.1</span>),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  b0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="fl">0.1</span>),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  a1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  b1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that <code>a0</code> and <code>b0</code> are not indexed by <code>id</code> anymore and are now single numbers, instead of <span class="math inline">\(N\)</span> values as before.</p>
</section>
<section id="model-4a" class="level3">
<h3 class="anchored" data-anchor-id="model-4a">Model 4a</h3>
<p>Another model I want to look at is a variant of model 4. This is in fact the same model as model 4, but written in a different way. A potential problem with model 4 and similar models is that parameters inside parameters can lead to inefficient or unreliable numerical results when running your Monte Carlo routine (in our case, this is Stan-powered Hamilton Monte Carlo). It is possible to rewrite the model such that it is the same model, but it looks different in a way that makes the numerics often run better. It turns out for our example, model 4 above runs ok. But it’s a good idea to be aware of the fact that one can re-write models if needed, therefore I decided to include this model alternative here.</p>
<p>The above model 4 is called a <strong>centered</strong> model and the re-write for model 4a is called a <strong>non-centered</strong> model. The trick is to pull out the parameters from inside the distributions for <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,i}\)</span>. The non-centered model looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#adaptive priors, partial-pooling model</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">#non-centered</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>m4a <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#rewritten to non-centered</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span>  mu_a <span class="sc">+</span> az[id]<span class="sc">*</span>sigma_a <span class="sc">+</span> a1<span class="sc">*</span>dose_adj,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  beta  <span class="ot">&lt;-</span>  mu_b <span class="sc">+</span> bz[id]<span class="sc">*</span>sigma_b <span class="sc">+</span> b1<span class="sc">*</span>dose_adj,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#rewritten to non-centered</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  az[id] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  bz[id] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  mu_a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  mu_b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  sigma_a <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  sigma_b <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  a1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  b1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Again, this model is mathematically the same as the original model 4. If this is confusing and doesn’t make sense (it sure wouldn’t to me if I just saw that for the first time 😁), check the <a href="https://xcelab.net/rm/statistical-rethinking/">Statistical Rethinking book</a>. (And no, I do not get a commission for continuing to point you to the book, and I wish there was a free online version (or a cheap paperback). But it is a great book and if you want to learn this kind of modeling for real, I think it’s worth the investment.)</p>
</section>
<section id="model-5" class="level3">
<h3 class="anchored" data-anchor-id="model-5">Model 5</h3>
<p>Another model, which I’m calling model 5 here, is one that does not include the dose effect. That means, parameters <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> are gone. Otherwise I’m following the setup of model 1. The reason I’m doing this is because on initial fitting of the above models, I could not obtain estimates for the dose parameters I used for the simulation. I noticed strong correlations between posterior distributions of the model parameters. I suspected an issue with non-identifiable parameters (i.e, trying to estimate more parameters than the data supports). To figure out what was going on, I wanted to see how a model without the dose component would perform. It turned out that the main reason things didn’t look right was because I had a typo in the code that generated the data, so what I thought was the generating model actually wasn’t 🤦. A helpful colleague and reader pointed this out. Once I fixed it, things made more sense. But I figured it’s instructive to keep this model anyway.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#no dose effect</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">#separate intercept for each individual/id</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#2xN+1 parameters</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>m5 <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># distribution of outcome</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># main equation for time-series trajectory</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#equations for alpha and beta</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span>  a0[id],</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span>  b0[id],</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#priors</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  a0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">2</span>,  <span class="dv">10</span>),</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  b0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">10</span>),</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="setting-starting-values" class="level2">
<h2 class="anchored" data-anchor-id="setting-starting-values">Setting starting values</h2>
<p>Any fitting routine needs to start with some parameter values and then from there tries to improve. <code>Stan</code> uses a heuristic way of picking some starting values. Often that works, sometimes it fails initially but then the routine fixes itself, and sometimes it fails all the way. In either case, I find it a good idea to specify starting values, even if they are not strictly needed. And it’s good to know that this is possible and how to do it, just in case you need it at some point. Setting starting values gives you more control, and you also know exactly what should happen when you look at for instance the traceplots of the chains.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Setting starting values</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 1</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>startm1 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">a0 =</span> <span class="fu">rep</span>(<span class="dv">2</span>,Ntot), <span class="at">b0 =</span> <span class="fu">rep</span>(<span class="fl">0.5</span>,Ntot), <span class="at">a1 =</span> <span class="fl">0.3</span> , <span class="at">b1 =</span> <span class="sc">-</span><span class="fl">0.3</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 2</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>startm2 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">a0 =</span> <span class="fu">rep</span>(<span class="dv">2</span>,Ntot), <span class="at">b0 =</span> <span class="fu">rep</span>(<span class="fl">0.5</span>,Ntot), <span class="at">mu_a =</span> <span class="dv">2</span>, <span class="at">mu_b =</span> <span class="dv">1</span>, <span class="at">a1 =</span> <span class="fl">0.3</span> , <span class="at">b1 =</span> <span class="sc">-</span><span class="fl">0.3</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 3</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>startm3 <span class="ot">=</span> startm1</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for models 4 and 4a</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>startm4 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">mu_a =</span> <span class="dv">2</span>, <span class="at">sigma_a =</span> <span class="dv">1</span>, <span class="at">mu_b =</span> <span class="dv">1</span>, <span class="at">sigma_b =</span> <span class="dv">1</span>, <span class="at">a1 =</span> <span class="fl">0.3</span> , <span class="at">b1 =</span> <span class="sc">-</span><span class="fl">0.3</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>startm4a <span class="ot">=</span> startm4</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 2a</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>startm2a <span class="ot">=</span> <span class="fu">list</span>(<span class="at">a0 =</span> <span class="dv">2</span>, <span class="at">b0 =</span> <span class="fl">0.5</span>, <span class="at">a1 =</span> <span class="fl">0.3</span>, <span class="at">b1 =</span> <span class="sc">-</span><span class="fl">0.3</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 5</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>startm5 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">a0 =</span> <span class="fu">rep</span>(<span class="dv">2</span>,Ntot), <span class="at">b0 =</span> <span class="fu">rep</span>(<span class="fl">0.5</span>,Ntot), <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">#put different starting values in list</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">#need to be in same order as models below</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>startlist <span class="ot">=</span> <span class="fu">list</span>(startm1,startm2,startm3,startm4,startm2a,startm4,startm5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we only specify values for the parameters that are directly estimated. Parameters that are built from other parameters (e.g.&nbsp;<span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>) are computed and don’t need starting values.</p>
<p>For some more detailed discussion on starting values, see for instance <a href="https://solomonkurz.netlify.app/blog/2021-06-05-don-t-forget-your-inits/">this post by Solomon Kurz</a>. He uses <code>brms</code> in his example, but the same idea applies with any package/fitting routine. He also explains that it is a good idea to set different starting values for each chain. I am not sure if/how this could be done with <code>rethinking</code>, it seems <code>ulam</code> does not support this? But it can be done for <code>brms</code> (and I’m doing it there).</p>
</section>
<section id="model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting">Model fitting</h2>
<p>Now that we specified all models, we can loop through all models and fit them. First, some setup before the actual fitting loop.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#general settings for fitting</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#you might want to adjust based on your computer</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>warmup <span class="ot">=</span> <span class="dv">6000</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>iter <span class="ot">=</span> warmup <span class="sc">+</span> <span class="fu">floor</span>(warmup<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>max_td <span class="ot">=</span> <span class="dv">18</span> <span class="co">#tree depth</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>adapt_delta <span class="ot">=</span> <span class="fl">0.9999</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>chains <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>cores  <span class="ot">=</span> chains</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>seed <span class="ot">=</span> <span class="dv">4321</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">#stick all models into a list</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>modellist <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m1=</span>m1,<span class="at">m2=</span>m2,<span class="at">m3=</span>m3,<span class="at">m4=</span>m4,<span class="at">m2a=</span>m2a,<span class="at">m4a=</span>m4a,<span class="at">m5=</span>m5)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># set up a list in which we'll store our results</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(modellist))</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co">#setting for parameter constraints</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>constraints <span class="ot">=</span> <span class="fu">list</span>(<span class="at">sigma=</span><span class="st">"lower=0"</span>,<span class="at">sigma_a=</span><span class="st">"lower=0"</span>,<span class="at">sigma_b=</span><span class="st">"lower=0"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first code block defines various settings for the <code>ulam</code> function. Look at the help file for details. Then we place all models into a list, set up an empty list for our fit results, and specify the data needed for fitting. The final command enforces some constraints on parameters. For our model, we want Half-Cauchy distributions for all variance parameters to ensure they are positive. Above, I specified them as Cauchy. There is no direct Half-Cauchy implementation. The way one achieves one is to tell <code>ulam</code>/<code>Stan</code> that the values for those parameters need to be positive. That’s what the <code>constraints</code> line in the code below does.</p>
<p>Looping over each model and fitting it. In addition to the actual fitting call to <code>ulam</code>, I’m also printing a few messages and storing the model name and the time it took to run. That’s useful for diagnostic. It’s generally a good idea to do short runs/chains until things work, then do a large run to get the actual result. Recording the running time helps decide how long a real run can be and how long it might take.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fitting models</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#loop over all models and fit them using ulam</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(modellist))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'************** </span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'starting model'</span>, <span class="fu">names</span>(modellist[n]), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  tstart<span class="ot">=</span><span class="fu">proc.time</span>(); <span class="co">#capture current time</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#run model fit</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  fl[[n]]<span class="sc">$</span>fit <span class="ot">&lt;-</span> <span class="fu">ulam</span>(<span class="at">flist =</span> modellist[[n]],</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> fitdat,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">start=</span>startlist[[n]],</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">constraints=</span>constraints,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                          <span class="at">log_lik=</span><span class="cn">TRUE</span>, <span class="at">cmdstan=</span><span class="cn">TRUE</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span>adapt_delta,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">max_treedepth =</span> max_td),</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                          <span class="at">chains=</span>chains, <span class="at">cores =</span> cores,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                          <span class="at">warmup =</span> warmup, <span class="at">iter =</span> iter,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                          <span class="at">seed =</span> seed</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  )<span class="co"># end ulam</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">#capture time taken for fit</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  tdiff<span class="ot">=</span><span class="fu">proc.time</span>()<span class="sc">-</span>tstart;</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  runtime_minutes<span class="ot">=</span>tdiff[[<span class="dv">3</span>]]<span class="sc">/</span><span class="dv">60</span>;</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'model fit took this many minutes:'</span>, runtime_minutes, <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'************** </span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add some more things to the fit object</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  fl[[n]]<span class="sc">$</span>runtime <span class="ot">=</span> runtime_minutes</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  fl[[n]]<span class="sc">$</span>model <span class="ot">=</span> <span class="fu">names</span>(modellist)[n]</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>} <span class="co">#end fitting of all models</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="co"># saving the list of results so we can use them later</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="co"># the file is too large for GitHub</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="co"># thus I am saving here to a local folder</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="co"># adjust accordingly for your setup</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">=</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="st">"D:"</span>,<span class="st">"Dropbox"</span>,<span class="st">"datafiles"</span>,<span class="st">"longitudinalbayes"</span>,<span class="st">"ulamfits"</span>, <span class="at">ext=</span><span class="st">"Rds"</span>)</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fl,filepath)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="explore-model-fits" class="level1">
<h1>Explore model fits</h1>
<p>Now we are ready to explore the model fitting results. All fits are in the list called <code>fl</code>. For each model the actual fit is in <code>fit</code>, the model name in <code>model</code> and the run time in <code>runtime</code>. Note that the code chunks below come from <a href="ulamexploremodels.R">this second R script</a>, thus some things are repeated (e.g., loading of simulated data).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loading list of previously saved fits.</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># useful if we don't want to re-fit</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># every time we want to explore the results.</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># since the file is too large for GitHub</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># it is stored in a local folder</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># adjust accordingly for your setup</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">=</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="st">"D:"</span>,<span class="st">"Dropbox"</span>,<span class="st">"datafiles"</span>,<span class="st">"longitudinalbayes"</span>,<span class="st">"ulamfits"</span>, <span class="at">ext=</span><span class="st">"Rds"</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(filepath)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># also load data file used for fitting</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>simdat <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"simdat.Rds"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">#pull our the data set we used for fitting</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">#if you fit a different one of the simulated datasets, change accordingly</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>fitdat <span class="ot">&lt;-</span> simdat<span class="sc">$</span>m3</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">#contains parameters used for fitting</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>pars <span class="ot">&lt;-</span> simdat<span class="sc">$</span>m3pars</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You should explore your model fits carefully. Look at the trace-plots or trank-plots with the <code>traceplot()</code> and <code>trankplot()</code> functions in <code>rethinking</code>. Make sure the chains are looking ok. You can also use the <code>summary</code> function to get some useful information on our model. To go further, you can call <code>stancode()</code> to get the actual Stan code for the model. This can be helpful to both learn Stan, and to check if the model translates into Stan code the way you expected it to.</p>
<p>I’m showing a few of those explorations to illustrate what I mean. For any real fitting, it is important to carefully look at all the output and make sure everything worked as expected and makes sense.</p>
<p>To keep output manageable, I’m using model 2a here, which has no individual-level parameters, thus only a total of 5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2a summary</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(fl[[<span class="dv">5</span>]]<span class="sc">$</span>fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hamiltonian Monte Carlo approximation
15000 samples from 5 chains

Sampling durations (seconds):
        warmup sample total
chain:1  22.35   8.14 30.49
chain:2  22.90  14.96 37.86
chain:3  22.07  11.31 33.38
chain:4  21.61  14.70 36.31
chain:5  22.59  14.32 36.91

Formula:
outcome ~ dnorm(mu, sigma)
mu &lt;- exp(alpha) * log(time) - exp(beta) * time
alpha &lt;- a0 + a1 * dose_adj
beta &lt;- b0 + b1 * dose_adj
a0 ~ dnorm(2, 0.1)
b0 ~ dnorm(0.5, 0.1)
a1 ~ dnorm(0.3, 1)
b1 ~ dnorm(-0.3, 1)
sigma ~ cauchy(0, 1)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2a trace plots</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(fl[[<span class="dv">5</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a0"</span>,<span class="st">"b0"</span>,<span class="st">"a1"</span>,<span class="st">"b1"</span>,<span class="st">"sigma"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/traceplot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2a trank plots</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">trankplot</span>(fl[[<span class="dv">5</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a0"</span>,<span class="st">"b0"</span>,<span class="st">"a1"</span>,<span class="st">"b1"</span>,<span class="st">"sigma"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/trankplot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2a pair plot</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation between posterior samples of parameters</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fl[[<span class="dv">5</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a0"</span>,<span class="st">"b0"</span>,<span class="st">"a1"</span>,<span class="st">"b1"</span>,<span class="st">"sigma"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/pairplot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Based on these diagnostic outputs, it seems the chains converged well, at least for model 2a. One interesting feature is the strong correlation between the parameters <span class="math inline">\(a_0\)</span> and <span class="math inline">\(b_0\)</span> and also <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>. Recall that <span class="math inline">\(\alpha\)</span> determined the initial increase of the function, <span class="math inline">\(\beta\)</span> the eventual decline. Both parameters determine the shape of the deterministic trajectory for all times, so large values for both can lead to somewhat similar results as small values for both. That is the reason for the correlations we see (and this is a different effect from the correlations we’ll discuss below).</p>
<section id="models-1-and-3" class="level2">
<h2 class="anchored" data-anchor-id="models-1-and-3">Models 1 and 3</h2>
<p>Now I’ll look at bit more carefully at the different models. We start by comparing fits for models 1 and 3. Those two are essentially the same model, with the only difference being wider priors for the individual-level parameters in model 1. It is worth mentioning that when running the fitting routine, model 1 takes much longer to fit than model 3. With the settings I used, runtimes were 331 versus 57 minutes. The wide priors made the fitting efficiency poor. But let’s see how it impacts the results.</p>
<p>First, we explore priors and posteriors. They are easy to extract from the models using the <code>extract.prior()</code> and <code>extract.samples()</code> functions from <code>rethinking</code>.</p>
<div class="cell" data-hash="index_cache/html/mod_1_3_prior_944249ccf8bdce015f191fa679312ebd">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#get priors and posteriors for models 1 and 3</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>m1prior <span class="ot">&lt;-</span> <span class="fu">extract.prior</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit, <span class="at">n =</span> <span class="fl">1e4</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>m1post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit, <span class="at">n =</span> <span class="fl">1e4</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>m3prior <span class="ot">&lt;-</span> <span class="fu">extract.prior</span>(fl[[<span class="dv">3</span>]]<span class="sc">$</span>fit, <span class="at">n =</span> <span class="fl">1e4</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>m3post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(fl[[<span class="dv">3</span>]]<span class="sc">$</span>fit, <span class="at">n =</span> <span class="fl">1e4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can plot the distributions. Note that for the individual-level parameters <span class="math inline">\(a_0\)</span> and <span class="math inline">\(b_0\)</span>, the plots show the distribution across all individuals. The dashed lines show the priors, the solid the posteriors. Black is model 1, blue is model 3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#showing density plots for a0</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(m1prior<span class="sc">$</span>a0), <span class="at">xlim =</span> <span class="fu">c</span> (<span class="sc">-</span><span class="dv">20</span>,<span class="dv">20</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m1post<span class="sc">$</span>a0), <span class="at">lty=</span><span class="dv">1</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m3prior<span class="sc">$</span>a0), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m3post<span class="sc">$</span>a0), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_prior_plots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#showing density plots for b0</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(m1prior<span class="sc">$</span>b0), <span class="at">xlim =</span> <span class="fu">c</span> (<span class="sc">-</span><span class="dv">20</span>,<span class="dv">20</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m1post<span class="sc">$</span>b0), <span class="at">lty=</span><span class="dv">1</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m3prior<span class="sc">$</span>b0), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m3post<span class="sc">$</span>b0), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_prior_plots-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#showing density plots for a1</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(m1prior<span class="sc">$</span>a1), <span class="at">xlim =</span> <span class="fu">c</span> (<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m1post<span class="sc">$</span>a1), <span class="at">lty=</span><span class="dv">1</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m3prior<span class="sc">$</span>a1), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m3post<span class="sc">$</span>a1), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_prior_plots-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#showing density plots for b1</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(m1prior<span class="sc">$</span>b1), <span class="at">xlim =</span> <span class="fu">c</span> (<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m1post<span class="sc">$</span>b1), <span class="at">lty=</span><span class="dv">1</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m3prior<span class="sc">$</span>b1), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m3post<span class="sc">$</span>b1), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_prior_plots-4.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We set up the models to have wider <span class="math inline">\(a_0\)</span> and <span class="math inline">\(b_0\)</span> priors for model 1, and the same priors for the <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> parameters. The dashed lines in the figures show that. Looking at the posteriors, we find that changing the priors has an impact, especially for <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>. Not only does model 3 lead to more peaked posteriors, they are also not centered at the same values, especially for <span class="math inline">\(b_1\)</span>. I don’t think that’s a good sign. We want the data to dominate the results, the priors should just be there to ensure the models explore the right parameter space efficiently and don’t do anything crazy. The fact that the same model, started with different priors, leads to different posterior distributions is in my opinion concerning. It could be that with more sampling, the posteriors might get closer. Or it might suggest that we are overfitting and have non-identifiability problems here.</p>
<p>One way to check that further is to look at potential correlations between parameter posterior distributions, e.g., using a <code>pairs()</code> plot as shown above. Here are such plots for the parameters associated with <span class="math inline">\(\alpha\)</span> for model 1. I only plot a few for each dose, otherwise the plots won’t be legible inside this html document. But you can try for yourself, if you make the plot large enough you can fit them all. You can also make plots for model 3 and for the <span class="math inline">\(b\)</span> parameters, those look very similar.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># all "a" parameters - too big to show</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">#pairs(fl[[1]]$fit, pars = c("a0","a1"))</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># a few parameters for each dose</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">#low dose</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a0[1]"</span>,<span class="st">"a0[2]"</span>,<span class="st">"a0[3]"</span>,<span class="st">"a0[4]"</span>,<span class="st">"a1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_pair_plots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#medium dose</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a0[8]"</span>,<span class="st">"a0[9]"</span>,<span class="st">"a0[10]"</span>,<span class="st">"a0[11]"</span>,<span class="st">"a1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_pair_plots-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#high dose</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a0[16]"</span>,<span class="st">"a0[17]"</span>,<span class="st">"a0[18]"</span>,<span class="st">"a0[19]"</span>,<span class="st">"a1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_pair_plots-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Recall that we set up the model such that dose is non-zero for low and high dose, while for the intermediate dose it drops out of the model. What seems to happen is that if the dose effect, i.e., <span class="math inline">\(a_1\)</span>, is present, there is a strong correlation among that parameter and the individual-level parameters for that dose. That part makes some sense to me. Both <span class="math inline">\(a_{0,i}\)</span> or <span class="math inline">\(a_1\)</span> can change <span class="math inline">\(\alpha\)</span> and thus the trajectory. If one is low, the other might be high, and the reverse, leading to similarly good fits.</p>
<p>Because every <span class="math inline">\(a_{0,i}\)</span> is correlated with <span class="math inline">\(a_1\)</span> in this way, this also leads to correlations among the <span class="math inline">\(a_{0,i}\)</span> values. I am surprised that this is an essentially perfect correlation. Maybe, if I thought about it harder and/or did the math, it would be clear that it needs to be that way. But I haven’t yet, so for now I’m just taking it as given 😁. Overall, this is another sign of that we might be overfitting and have non-identifiability problems, i.e.&nbsp;combinations for different values of <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(a_1\)</span> can lead to more or less the same results (everything I write here of course also holds for the <span class="math inline">\(b_{0,i}\)</span> and <span class="math inline">\(b_1\)</span> parameters).</p>
<p>Let’s move on and now look at the posterior distributions in numerical form. For that, I use the <code>precis</code> function from <code>rethinking</code>. Instead of printing all the <span class="math inline">\(N\)</span> different values of <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,i}\)</span>, I compute their means. If you want to see them all, change to <code>depth=2</code> in the <code>precis</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 1</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>a0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"a0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>b0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"b0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">1</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>48 vector or matrix parameters hidden. Use depth=2 to show them.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       mean    sd  5.5% 94.5% n_eff Rhat4
a1     0.22 0.736 -0.96  1.40  2600     1
b1    -0.21 0.745 -1.40  0.98  2384     1
sigma  1.06 0.052  0.98  1.15 16450     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(a0mean,b0mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.961711 1.005527</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 3</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>a0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">3</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"a0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>b0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">3</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"b0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">3</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">1</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>48 vector or matrix parameters hidden. Use depth=2 to show them.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>        mean    sd   5.5% 94.5% n_eff Rhat4
a1     0.141 0.110 -0.033 0.316  3005     1
b1    -0.082 0.109 -0.256 0.093  2776     1
sigma  1.062 0.052  0.985 1.148 15663     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(a0mean,b0mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.9757761 0.9810916</code></pre>
</div>
</div>
<p>The models seem to have converged ok, based on <code>Rhat</code> values of 1. Some parameters sampled better than others, as can be seen by the varying <code>n_eff</code> values. I used 5 chains of 3000 post-warmup samples for each chain, so the actual samples are 15000. If <code>n_eff</code> is lower than that, it means the sampling was not efficient, more means it worked very well (see e.g.&nbsp;Statistical Rethinking why it’s possible to get more effective samples than actual samples.)</p>
<p>We find that estimates for <span class="math inline">\(a_{0}\)</span>, <span class="math inline">\(b_0\)</span> and <span class="math inline">\(\sigma\)</span> are similar, <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> differ more.</p>
<p>Again, note that the only thing we changed between models 1 and 3 are to make the priors for the <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,i}\)</span> parameters tighter. It didn’t seem to impact estimates for those parameters, but it did impact the estimates for the posterior distributions of parameters <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>. The numbers are consistent with the posterior distribution figures above.</p>
</section>
<section id="comparing-model-estimates-with-the-truth" class="level2">
<h2 class="anchored" data-anchor-id="comparing-model-estimates-with-the-truth">Comparing model estimates with the truth</h2>
<p>We know the “truth” here, i.e., the actual values of the parameters which we used to created the simulated data. To generate the data, we used these parameter values: <span class="math inline">\(\sigma =\)</span> 1, <span class="math inline">\(\mu_a =\)</span> 3, <span class="math inline">\(\mu_b =\)</span> 1, <span class="math inline">\(a_1 =\)</span> 0.1, <span class="math inline">\(b_1 =\)</span> -0.1. We also said that our main scientific question is if there is a dose effect, i.e.&nbsp;non-zero <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>.</p>
<p>The models find estimates of <span class="math inline">\(\mu_a\)</span>, <span class="math inline">\(\mu_b\)</span> and <span class="math inline">\(\sigma\)</span> that are close to what we used. The estimates for <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> are not that great. That’s especially true for model 1. With these models, we aren’t able to convincingly recover the parameters used to generate the data. I’m not sure if increasing the sampling (longer or more chains) would help. Both models, especially model 1, already took quite a while to run. Thus I’m not too keen to try it with even more samples. As we’ll see below, alternative models do better.</p>
</section>
<section id="models-2-and-2a" class="level2">
<h2 class="anchored" data-anchor-id="models-2-and-2a">Models 2 and 2a</h2>
<p>Next, let’s look at models 2 and 2a. The estimates should be similar since the two models are conceptually pretty much the same.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare models 2 and 2a</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># first we compute the mean across individuals for model 2</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>a0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"a0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>b0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"b0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co">#rest of model 2</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">1</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>48 vector or matrix parameters hidden. Use depth=2 to show them.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>        mean     sd  5.5%  94.5% n_eff Rhat4
mu_a   2.992 0.0271  2.94  3.026    16   1.4
mu_b   0.999 0.0236  0.96  1.029    12   1.4
a1     0.095 0.0097  0.08  0.111   101   1.1
b1    -0.097 0.0082 -0.11 -0.083   147   1.1
sigma  6.867 0.2838  6.46  7.334   244   1.0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(a0mean,b0mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.991509 0.998633</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">#model 2a</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">5</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">1</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        mean     sd  5.5%  94.5% n_eff Rhat4
a0     2.920 0.0236  2.88  2.957  5343     1
b0     0.938 0.0204  0.90  0.971  5651     1
a1     0.107 0.0109  0.09  0.125  6123     1
b1    -0.098 0.0094 -0.11 -0.084  6787     1
sigma  7.003 0.3207  6.51  7.536  7308     1</code></pre>
</div>
</div>
<p>The first thing to note is that model 2 performs awfully, with <code>Rhat</code> values &gt;1 and very low effective sample size <code>n_eff</code>. This indicates that this model doesn’t work well for the data. Whenever you see diagnostics like that, you should not take the estimated values seriously. However, let’s pretend for a moment that we can take them seriously. Here is what we find.</p>
<p>First, both models produce similar estimates. Since model 2a is simpler and doesn’t have that strange feature of us enforcing a very tight distribution for the <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,i}\)</span> parameters, it actually samples much better, see the higher <code>n_eff</code> numbers. It also runs much faster, 1.3 minutes compared to 30 minutes for model 2.</p>
<p>Both models do a very poor job estimating <span class="math inline">\(\sigma\)</span>. That’s because we don’t allow the models to have the flexibility needed to fit the data, so it has to account for any variation between its estimated mean trajectory and the real data by making <span class="math inline">\(\sigma\)</span> large.</p>
<p>Since the models are more constrained compared to models 1 and 3, they produce estimates for <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> that are tighter. However, these estimates are over-confident. overall these models underfitting and are not good. We can for instance look at this using the <code>compare</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,fl[[<span class="dv">3</span>]]<span class="sc">$</span>fit,fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,fl[[<span class="dv">5</span>]]<span class="sc">$</span>fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 WAIC       SE        dWAIC        dSE     pWAIC        weight
fl[[1]]$fit  832.9455 23.39942   0.00000000         NA 43.718111  5.067138e-01
fl[[3]]$fit  832.9992 23.42829   0.05371325  0.4274202 43.737196  4.932862e-01
fl[[2]]$fit 1778.3776 44.18971 945.43210978 45.5782040  9.698475 2.551459e-206
fl[[5]]$fit 1788.1450 45.28523 955.19949836 47.0533571 10.466546 1.931199e-208</code></pre>
</div>
</div>
<p>I’m not going to discuss things in detail (see <a href="https://xcelab.net/rm/statistical-rethinking/">Statistical Rethinking</a>), but a lower WAIC means a model that fits best in the sense that it strikes a good balance between fitting the data while not overfitting. As you can see, models 1 and 3 perform very similarly and models 2 and 2a are much worse.</p>
<p>The larger WAIC indicates either strong overfitting or underfitting. In this case, it’s underfitting. The models are not flexible enough to capture the individual-level variation. You’ll see that clearly in the plots shown further below. If we did indeed not want to account for individual-level variation, we should go with a model that simply doesn’t include it, i.e.&nbsp;model 2a. The contrived model 2 with very narrow priors is just a bad model, and I’m really only exploring it here for demonstration purposes.</p>
</section>
<section id="models-4-and-4a" class="level2">
<h2 class="anchored" data-anchor-id="models-4-and-4a">Models 4 and 4a</h2>
<p>Now we get to the models we really care about. When I set up the models, I suggested that model 4 was similar to models 1-3, but with priors adaptively chosen. That didn’t apply during data generation/simulation since in that step, we always need to manually choose values. But during the fitting/estimation, we should expect that model 4 chooses priors in a smart way, such that it is better than the models where we fixed the priors. Let’s see what model 4 produces. We also look at model 4a, which is exactly the same model, just rewritten to potentially make the numerical fitting routine more efficient.</p>
<p>Let’s start with prior and posterior plots.</p>
<div class="cell" data-hash="index_cache/html/mod_4_4a_prior_2bded29ba3fb0b28746e35074038a210">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#get priors and posteriors for models 4 and 4a</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>m4prior <span class="ot">&lt;-</span> <span class="fu">extract.prior</span>(fl[[<span class="dv">4</span>]]<span class="sc">$</span>fit, <span class="at">n =</span> <span class="fl">1e4</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>m4post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(fl[[<span class="dv">4</span>]]<span class="sc">$</span>fit, <span class="at">n =</span> <span class="fl">1e4</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>m4aprior <span class="ot">&lt;-</span> <span class="fu">extract.prior</span>(fl[[<span class="dv">6</span>]]<span class="sc">$</span>fit, <span class="at">n =</span> <span class="fl">1e4</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>m4apost <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(fl[[<span class="dv">6</span>]]<span class="sc">$</span>fit, <span class="at">n =</span> <span class="fl">1e4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As before, the dashed lines show the priors, the solid the posteriors. Black is model 4, blue is model 4a.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">#showing density plots for a0</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(m4prior<span class="sc">$</span>mu_a), <span class="at">xlim =</span> <span class="fu">c</span> (<span class="sc">-</span><span class="dv">10</span>,<span class="dv">10</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m4post<span class="sc">$</span>mu_a), <span class="at">lty=</span><span class="dv">1</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m4aprior<span class="sc">$</span>mu_a), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m4apost<span class="sc">$</span>mu_a), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_4a_prior_plots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">#showing density plots for b0</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(m4prior<span class="sc">$</span>mu_b), <span class="at">xlim =</span> <span class="fu">c</span> (<span class="sc">-</span><span class="dv">10</span>,<span class="dv">10</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m4post<span class="sc">$</span>mu_b), <span class="at">lty=</span><span class="dv">1</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m4aprior<span class="sc">$</span>mu_b), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m4apost<span class="sc">$</span>mu_b), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_4a_prior_plots-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">#showing density plots for a1</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(m4prior<span class="sc">$</span>a1), <span class="at">xlim =</span> <span class="fu">c</span> (<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m4post<span class="sc">$</span>a1), <span class="at">lty=</span><span class="dv">1</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m4aprior<span class="sc">$</span>a1), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m4apost<span class="sc">$</span>a1), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_4a_prior_plots-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">#showing density plots for b1</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(m4prior<span class="sc">$</span>b1), <span class="at">xlim =</span> <span class="fu">c</span> (<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m4post<span class="sc">$</span>b1), <span class="at">lty=</span><span class="dv">1</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m4aprior<span class="sc">$</span>b1), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(m4apost<span class="sc">$</span>b1), <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_4a_prior_plots-4.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As you can see, up to numerical sampling variability, the results for models 4 and 4a are pretty much the same. That should be expected, since they are the same model, just reformulated for potential efficiency. Also, the posterior distributions are much narrower than the priors. I think that’s a good sign as well, it indicates the data mostly informed the posterior distributions, the priors just helped to keep things efficient.</p>
<p>We can also explore pair plots again, showing them here for model 4.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a few parameters for each dose</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co">#low dose</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fl[[<span class="dv">4</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a0[1]"</span>,<span class="st">"a0[2]"</span>,<span class="st">"a0[3]"</span>,<span class="st">"a0[4]"</span>,<span class="st">"a1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_4a_pair_plots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">#medium dose</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fl[[<span class="dv">4</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a0[8]"</span>,<span class="st">"a0[9]"</span>,<span class="st">"a0[10]"</span>,<span class="st">"a0[11]"</span>,<span class="st">"a1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_4a_pair_plots-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#high dose</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fl[[<span class="dv">4</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a0[16]"</span>,<span class="st">"a0[17]"</span>,<span class="st">"a0[18]"</span>,<span class="st">"a0[19]"</span>,<span class="st">"a1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_4a_pair_plots-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mean of a0 prior</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fl[[<span class="dv">4</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"mu_a"</span>,<span class="st">"mu_b"</span>,<span class="st">"a1"</span>,<span class="st">"b1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_4a_pair_plots-4.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">#saving one plot so I can use as featured image</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="at">filename =</span> <span class="st">"featured.png"</span>, <span class="at">width =</span> <span class="dv">6</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">res =</span> <span class="dv">300</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fl[[<span class="dv">4</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"mu_a"</span>,<span class="st">"mu_b"</span>,<span class="st">"a1"</span>,<span class="st">"b1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>png 
  2 </code></pre>
</div>
</div>
<p>We still see the same issue with correlations among the parameters for dose levels where <span class="math inline">\(a_1\)</span> is acting, though the correlations are not as extreme. They are also minor between the overall estimates for the mean of the <span class="math inline">\(a_0\)</span> and <span class="math inline">\(b_0\)</span> parameters and <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>. I interpret this to mean that the adaptive sampling helped somewhat with the identifiability and overfitting problem, though it seems to not fully resolve it. The fact that we gave each individual their own <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,i}\)</span> values allows those parameters to still “absorb” some of the dose-dependent signal in <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>.</p>
<p>We can also again look at the numerical outputs from the <code>precis</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model 4</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">4</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">1</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>48 vector or matrix parameters hidden. Use depth=2 to show them.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>          mean    sd   5.5%  94.5% n_eff Rhat4
mu_a     2.987 0.020  2.956  3.018 14437     1
mu_b     0.986 0.025  0.946  1.026 14777     1
sigma_a  0.093 0.016  0.071  0.121 10722     1
sigma_b  0.119 0.020  0.092  0.153 12199     1
a1       0.086 0.010  0.069  0.102  2170     1
b1      -0.107 0.013 -0.128 -0.085  2230     1
sigma    1.062 0.052  0.983  1.148 13477     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model 4a</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">6</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">1</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>48 vector or matrix parameters hidden. Use depth=2 to show them.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>          mean    sd   5.5%  94.5% n_eff Rhat4
mu_a     2.987 0.019  2.956  3.017  3803     1
mu_b     0.986 0.025  0.946  1.026  3259     1
sigma_a  0.093 0.016  0.072  0.121  4376     1
sigma_b  0.119 0.020  0.092  0.153  4285     1
a1       0.086 0.010  0.069  0.103  4267     1
b1      -0.106 0.013 -0.126 -0.084  3861     1
sigma    1.062 0.051  0.985  1.148 10624     1</code></pre>
</div>
</div>
<p>The numerics confirm that the two models lead to essentially the same results. The values for <code>n_eff</code> differ between models, though neither model is consistently larger. This suggests that each model formulation had advantages in sampling for some of the parameters.</p>
<p>In terms of run times, there wasn’t much difference, with 7 minutes for model 4 versus 10 minutes for model 4a (much better than models 1-3).</p>
<p>If we compare the parameter estimates with the true values and those found for models 1 and 3 above, we find that again the true <span class="math inline">\(\mu_a\)</span>, <span class="math inline">\(\mu_b\)</span> and <span class="math inline">\(\sigma\)</span> are estimated fairly well. Estimates for <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> are now also pretty good, and the credible intervals are less wide.</p>
<p>Now let’s briefly run the <code>compare</code> function too and include model 3 as well. In addition to using WAIC for comparison, I’m also including PSIS. Read about it in the Statistical Rethinking book. One advantage of PSIS is that it gives warnings if the estimates might not be reliable. You see that this happens here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(fl[[<span class="dv">3</span>]]<span class="sc">$</span>fit,fl[[<span class="dv">4</span>]]<span class="sc">$</span>fit,fl[[<span class="dv">6</span>]]<span class="sc">$</span>fit, <span class="at">func =</span> WAIC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                WAIC       SE     dWAIC       dSE    pWAIC    weight
fl[[4]]$fit 831.0751 23.40197 0.0000000        NA 42.58290 0.4659494
fl[[6]]$fit 831.6133 23.39119 0.5382072 0.3058545 42.76359 0.3560152
fl[[3]]$fit 832.9992 23.42829 1.9241902 2.5641934 43.73720 0.1780353</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(fl[[<span class="dv">3</span>]]<span class="sc">$</span>fit,fl[[<span class="dv">4</span>]]<span class="sc">$</span>fit,fl[[<span class="dv">6</span>]]<span class="sc">$</span>fit, <span class="at">func =</span> PSIS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some Pareto k values are high (&gt;0.5). Set pointwise=TRUE to inspect individual points.
Some Pareto k values are high (&gt;0.5). Set pointwise=TRUE to inspect individual points.
Some Pareto k values are high (&gt;0.5). Set pointwise=TRUE to inspect individual points.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                PSIS       SE     dPSIS       dSE    pPSIS    weight
fl[[4]]$fit 839.5114 24.33096 0.0000000        NA 46.80107 0.4616132
fl[[6]]$fit 839.8745 24.30905 0.3630563 0.5782962 46.89419 0.3849830
fl[[3]]$fit 841.7147 24.33321 2.2033083 2.7044971 48.09493 0.1534037</code></pre>
</div>
</div>
<p>We do find that model 4/4a performs a bit better, but not by much. Note that model 4/4a has more actual parameters, but the effective parameters (which is described by <code>pWAIC</code>) is a bit smaller.</p>
<p>Overall, this suggests that the adaptive pooling approach helped to estimate results more precisely and efficiently and is the best of the models.</p>
</section>
<section id="model-5-1" class="level2">
<h2 class="anchored" data-anchor-id="model-5-1">Model 5</h2>
<p>As stated above, due to a typo in my code, the above models, including 4/4a, initially produced estimates for <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> that were not close to those (I thought I) used to generate the data. Based on the pair plots, I suspected non-identifiability issues and wanted to explore what would happen if I removed the dose.</p>
<p>If we now look at the pairs plots, maybe not surprisingly, the correlations between individual <span class="math inline">\(a_0\)</span> parameters are gone.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a few parameters for each dose</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co">#low dose</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fl[[<span class="dv">7</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a0[1]"</span>,<span class="st">"a0[2]"</span>,<span class="st">"a0[3]"</span>,<span class="st">"a0[4]"</span>,<span class="st">"a0[5]"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_5_pair_plots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">#medium dose</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fl[[<span class="dv">7</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a0[8]"</span>,<span class="st">"a0[9]"</span>,<span class="st">"a0[10]"</span>,<span class="st">"a0[11]"</span>,<span class="st">"a0[12]"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_5_pair_plots-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co">#high dose</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fl[[<span class="dv">7</span>]]<span class="sc">$</span>fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"a0[16]"</span>,<span class="st">"a0[17]"</span>,<span class="st">"a0[18]"</span>,<span class="st">"a0[19]"</span>,<span class="st">"a0[20]"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter

Warning in par(usr): argument 1 does not name a graphical parameter</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_5_pair_plots-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The model estimates the parameters reasonably well</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>a0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">7</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"a0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>b0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">7</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"b0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">7</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">1</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>48 vector or matrix parameters hidden. Use depth=2 to show them.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>      mean    sd 5.5% 94.5% n_eff Rhat4
sigma  1.1 0.052 0.98   1.1 16614     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(a0mean,b0mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.0031331 0.9655931</code></pre>
</div>
</div>
<p>It doesn’t seem quite as good as the previous models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(fl[[<span class="dv">3</span>]]<span class="sc">$</span>fit,fl[[<span class="dv">4</span>]]<span class="sc">$</span>fit,fl[[<span class="dv">7</span>]]<span class="sc">$</span>fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                WAIC       SE    dWAIC      dSE    pWAIC    weight
fl[[4]]$fit 831.0751 23.40197 0.000000       NA 42.58290 0.5705560
fl[[3]]$fit 832.9992 23.42829 1.924190 2.564193 43.73720 0.2180046
fl[[7]]$fit 833.0604 23.39781 1.985346 2.445539 43.82551 0.2114394</code></pre>
</div>
</div>
<p><strong>And of course the main problem with this model: It can’t answer any question about the role of dose, since we removed that component from the model!</strong> So while ok to explore, scientifically not useful since it can’t help us address the question we want to answer regarding the potential impact of dose.</p>
</section>
</section>
<section id="computing-predictions" class="level1">
<h1>Computing predictions</h1>
<p>Looking at parameters as we did so far is useful. But we also want to see how model predictions look. It is possible to have a model that predicts overall well, even if the parameter estimates are not right (of course, for real, non-simulated data, we generally don’t know what the “right” values are). The opposite can’t happen, if you have the right model and the parameter estimates are right, the predictions will be good. But again, you never know if you have the right model, i.e., the model that captures the process underlying the data. For any real data, you almost certainly do not. Thus you could get parameters that look “right” (e.g.&nbsp;narrow credible intervals) but the model is still not good. Our models 2 and 2a fall into that category, as you’ll see below.</p>
<p>That is all to say, it’s important to look at model predicted outcomes, not just the parameters. So let’s plot the predictions implied by the fits for the models. The general strategy for that is to use the parameter estimates in the posterior, put them in the model, and compute the predictions. We are essentially going through the same steps we did to generate the data. Only now we start with the estimated values. While this could all be manually coded, we happily don’t need to do so. The <code>rethinking</code> package has some helper functions for that (<code>sim</code> and <code>link</code>).</p>
<p>The code below produces predictions, both for the deterministic mean trajectory <span class="math inline">\(\mu\)</span>, and the actual outcome, <span class="math inline">\(Y\)</span>, which has added variation due to <span class="math inline">\(\sigma\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">#small data adjustment for plotting</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>plotdat <span class="ot">&lt;-</span> fitdat <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>()  <span class="sc">%&gt;%</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">as.factor</span>(id))  <span class="sc">%&gt;%</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">mutate</span>(<span class="at">dose =</span> dose_cat)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="co">#this will contain all the predictions from the different models</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>fitpred <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(fl))</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="co"># we are looping over each fitted model</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(fl))</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#get current model</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>  nowmodel <span class="ot">=</span> fl[[n]]<span class="sc">$</span>fit</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#make new data for which we want predictions</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#specifically, more time points so the curves are smoother</span></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>  timevec <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.1</span>, <span class="at">to =</span> <span class="fu">max</span>(fitdat<span class="sc">$</span>time), <span class="at">length=</span><span class="dv">100</span>)</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>  Ntot <span class="ot">=</span> <span class="fu">max</span>(fitdat<span class="sc">$</span>id)</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">#new data used for predictions</span></span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>  preddat <span class="ot">=</span> <span class="fu">data.frame</span>( <span class="at">id =</span> <span class="fu">sort</span>(<span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">1</span>,Ntot),<span class="fu">length</span>(timevec))),</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>                        <span class="at">time =</span> <span class="fu">rep</span>(timevec,Ntot),</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>                        <span class="at">dose_adj =</span> <span class="dv">0</span></span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add right dose information for each individual</span></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Ntot)</span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">#dose for a given individual</span></span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a>    nowdose <span class="ot">=</span> <span class="fu">unique</span>(fitdat<span class="sc">$</span>dose_adj[fitdat<span class="sc">$</span>id <span class="sc">==</span> k])</span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a>    nowdose_cat <span class="ot">=</span> <span class="fu">unique</span>(fitdat<span class="sc">$</span>dose_cat[fitdat<span class="sc">$</span>id <span class="sc">==</span> k])</span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">#assign that dose</span></span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#the categorical values are just for plotting</span></span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a>    preddat[(preddat<span class="sc">$</span>id <span class="sc">==</span> k),<span class="st">"dose_adj"</span>] <span class="ot">=</span> nowdose</span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a>    preddat[(preddat<span class="sc">$</span>id <span class="sc">==</span> k),<span class="st">"dose_cat"</span>] <span class="ot">=</span> nowdose_cat</span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pull out posterior samples for the parameters</span></span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a>  post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(nowmodel)</span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># estimate and CI for parameter variation</span></span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this uses the link function from rethinking</span></span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># we ask for predictions for the new data generated above</span></span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true" tabindex="-1"></a>  linkmod <span class="ot">&lt;-</span> rethinking<span class="sc">::</span><span class="fu">link</span>(nowmodel, <span class="at">data =</span> preddat)</span>
<span id="cb91-43"><a href="#cb91-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-44"><a href="#cb91-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">#computing mean and various credibility intervals</span></span>
<span id="cb91-45"><a href="#cb91-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">#these choices are inspired by the Statistical Rethinking book</span></span>
<span id="cb91-46"><a href="#cb91-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">#and purposefully do not include 95%</span></span>
<span id="cb91-47"><a href="#cb91-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">#to minimize thoughts of statistical significance</span></span>
<span id="cb91-48"><a href="#cb91-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">#significance is not applicable here since we are doing bayesian fitting</span></span>
<span id="cb91-49"><a href="#cb91-49" aria-hidden="true" tabindex="-1"></a>  modmean <span class="ot">&lt;-</span> <span class="fu">apply</span>( linkmod<span class="sc">$</span>mu , <span class="dv">2</span> , mean )</span>
<span id="cb91-50"><a href="#cb91-50" aria-hidden="true" tabindex="-1"></a>  modPI79 <span class="ot">&lt;-</span> <span class="fu">apply</span>( linkmod<span class="sc">$</span>mu , <span class="dv">2</span> , PI , <span class="at">prob=</span><span class="fl">0.79</span> )</span>
<span id="cb91-51"><a href="#cb91-51" aria-hidden="true" tabindex="-1"></a>  modPI89 <span class="ot">&lt;-</span> <span class="fu">apply</span>( linkmod<span class="sc">$</span>mu , <span class="dv">2</span> , PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb91-52"><a href="#cb91-52" aria-hidden="true" tabindex="-1"></a>  modPI97 <span class="ot">&lt;-</span> <span class="fu">apply</span>( linkmod<span class="sc">$</span>mu , <span class="dv">2</span> , PI , <span class="at">prob=</span><span class="fl">0.97</span> )</span>
<span id="cb91-53"><a href="#cb91-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-54"><a href="#cb91-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># estimate and CI for prediction intervals</span></span>
<span id="cb91-55"><a href="#cb91-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this uses the sim function from rethinking</span></span>
<span id="cb91-56"><a href="#cb91-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the predictions factor in additional uncertainty around the mean (mu)</span></span>
<span id="cb91-57"><a href="#cb91-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># as indicated by sigma</span></span>
<span id="cb91-58"><a href="#cb91-58" aria-hidden="true" tabindex="-1"></a>  simmod <span class="ot">&lt;-</span> rethinking<span class="sc">::</span><span class="fu">sim</span>(nowmodel, <span class="at">data =</span> preddat)</span>
<span id="cb91-59"><a href="#cb91-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-60"><a href="#cb91-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mean and credible intervals for outcome predictions</span></span>
<span id="cb91-61"><a href="#cb91-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># modmeansim should agree with above modmean values</span></span>
<span id="cb91-62"><a href="#cb91-62" aria-hidden="true" tabindex="-1"></a>  modmeansim <span class="ot">&lt;-</span> <span class="fu">apply</span>( simmod , <span class="dv">2</span> , mean )</span>
<span id="cb91-63"><a href="#cb91-63" aria-hidden="true" tabindex="-1"></a>  modPIsim <span class="ot">&lt;-</span> <span class="fu">apply</span>( simmod , <span class="dv">2</span> , PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb91-64"><a href="#cb91-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-65"><a href="#cb91-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">#place all predictions into a data frame</span></span>
<span id="cb91-66"><a href="#cb91-66" aria-hidden="true" tabindex="-1"></a>  <span class="co">#and store in a list for each model</span></span>
<span id="cb91-67"><a href="#cb91-67" aria-hidden="true" tabindex="-1"></a>  fitpred[[n]] <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">id =</span> <span class="fu">as.factor</span>(preddat<span class="sc">$</span>id),</span>
<span id="cb91-68"><a href="#cb91-68" aria-hidden="true" tabindex="-1"></a>                            <span class="at">dose =</span> <span class="fu">as.factor</span>(preddat<span class="sc">$</span>dose_cat),</span>
<span id="cb91-69"><a href="#cb91-69" aria-hidden="true" tabindex="-1"></a>                            <span class="at">predtime =</span> preddat<span class="sc">$</span>time,</span>
<span id="cb91-70"><a href="#cb91-70" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Estimate =</span> modmean,</span>
<span id="cb91-71"><a href="#cb91-71" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Q79lo =</span> modPI79[<span class="dv">1</span>,], <span class="at">Q79hi =</span> modPI79[<span class="dv">2</span>,],</span>
<span id="cb91-72"><a href="#cb91-72" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Q89lo =</span> modPI89[<span class="dv">1</span>,], <span class="at">Q89hi =</span> modPI89[<span class="dv">2</span>,],</span>
<span id="cb91-73"><a href="#cb91-73" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Q97lo =</span> modPI97[<span class="dv">1</span>,], <span class="at">Q97hi =</span> modPI97[<span class="dv">2</span>,],</span>
<span id="cb91-74"><a href="#cb91-74" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Qsimlo=</span>modPIsim[<span class="dv">1</span>,], <span class="at">Qsimhi=</span>modPIsim[<span class="dv">2</span>,]</span>
<span id="cb91-75"><a href="#cb91-75" aria-hidden="true" tabindex="-1"></a>                            )</span>
<span id="cb91-76"><a href="#cb91-76" aria-hidden="true" tabindex="-1"></a>} <span class="co">#end loop over all models</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-plots-of-the-results" class="level1">
<h1>Creating plots of the results</h1>
<p>Now that we got the predictions computed, we can plot them and compare to the data. It turns out that trying to plot all the different credible intervals makes the plot too busy, so I’m only showing a few. You can play around by turning the commented lines on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co">#list for storing all plots</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>plotlist <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(fl))</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="co">#looping over all models, creating and storing a plot for each</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(fl))</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#adding titles to plots</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>  title <span class="ot">=</span> fl[[n]]<span class="sc">$</span>model</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>  plotlist[[n]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> fitpred[[n]], <span class="fu">aes</span>(<span class="at">x =</span> predtime, <span class="at">y =</span> Estimate, <span class="at">group =</span> id, <span class="at">color =</span> dose ) ) <span class="sc">+</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#geom_ribbon( aes(x=time, ymin=Q79lo, ymax=Q79hi, fill = dose), alpha=0.6, show.legend = F) +</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>predtime, <span class="at">ymin=</span>Q89lo, <span class="at">ymax=</span>Q89hi, <span class="at">fill =</span> dose, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">alpha=</span><span class="fl">0.3</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#geom_ribbon(aes(x=time, ymin=Q97lo, ymax=Q97hi, fill = dose), alpha=0.2, show.legend = F) +</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>predtime, <span class="at">ymin=</span>Qsimlo, <span class="at">ymax=</span>Qsimhi, <span class="at">fill =</span> dose, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">alpha=</span><span class="fl">0.1</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> plotdat, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> outcome, <span class="at">group =</span> id, <span class="at">color =</span> dose), <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>,<span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Virus load"</span>,</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"days post infection"</span>) <span class="sc">+</span></span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(title)</span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="showing-the-plots" class="level1">
<h1>Showing the plots</h1>
<p>Here are the plots for all models we considered. I’m plotting them in the order I discussed the models above, so the ones we compared above are shown right below each other.</p>
<p>It’s a bit hard to see, but each plot contains for each individual the data as symbols, the estimated mean as line, and the 89% credible interval and prediction interval as shaded areas. The prediction interval is the light shaded area. If you enlarge the images, you should be able to see it.</p>
<section id="models-1-and-3-1" class="level2">
<h2 class="anchored" data-anchor-id="models-1-and-3-1">Models 1 and 3</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_plots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">3</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_plots-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Despite differences in estimates for the dose related parameters, the predicted outcomes of the models are very similar. In fact, it’s hard to tell any difference by just looking at the plots (but they are slightly different, I checked). Thus, despite the inability of these models to provide precises estimates of all the parameter values, the predictions/outcomes are fine, they fit the data well.</p>
</section>
<section id="models-2-and-2a-1" class="level2">
<h2 class="anchored" data-anchor-id="models-2-and-2a-1">Models 2 and 2a</h2>
<p>For models 2 and 2a, recall that the only variation is for dose, we didn’t allow variation among individuals. That’s reflected in the plots. The credible intervals based on parameters are tight, but because the variability, <span class="math inline">\(\sigma\)</span>, had to account for all the differences, the prediction intervals are very wide.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">2</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_2_2a_plots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">5</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_2_2a_plots-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="models-4-and-4a-1" class="level2">
<h2 class="anchored" data-anchor-id="models-4-and-4a-1">Models 4 and 4a</h2>
<p>These models look good again, and very similar to models 1 and 3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">4</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_4a_plots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">6</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_4a_plots-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="model-5-2" class="level2">
<h2 class="anchored" data-anchor-id="model-5-2">Model 5</h2>
<p>The model fits look fine, suggesting that one parameter for each individual is enough to capture the data. That’s not surprising. However, this of course does not allow us to ask and answer any scientific questions about the role of dose.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">7</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_5_plots-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So overall, the figures make sense It seems that if we want to do prediction, all models that include individual variability are fine, models 2/2a are not great. If we wanted to estimate the model parameters, specifically <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>, models 1 and 3 and of course 5 don’t work. In that case, model 2/2a works ok. I consider model 4/4a the best one overall.</p>
<p>For another example and more discussion of estimation versus prediction, see e.g.&nbsp;Section 6.1. in <em>Statistical Rethinking</em>, as well as 9.5.4 (all referring to the 2nd edition of the book).</p>
</section>
</section>
<section id="summary-and-continuation" class="level1">
<h1>Summary and continuation</h1>
<p>To sum it up, we fit several models to the simulated time-series data to explore how different model formulations might or might not impact results. For this post, I used the - very nice! - <code>rethinking</code> package. In the next post, I’ll repeat the fitting again, now using <code>brms</code>. Since <code>brms</code> is very widely used and has some capabilities that go beyond what <code>rethinking</code> can do, I think it’s worth <a href="../../posts/longitudinal-multilevel-bayesian-analysis-3/">reading the next post</a>.</p>
<p>If you don’t care about <code>brms</code>, you can hop to <a href="../../posts/longitudinal-multilevel-bayesian-analysis-4/">this post</a>, where I discuss a few further topics and variations. Any fitting done in that post is with <code>ulam</code>/<code>rethinking</code>, so you don’t need to look at the <code>brms</code> post, but I still suggest you do 😁.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{handel2022,
  author = {Andreas Handel},
  title = {Bayesian Analysis of Longitudinal Multilevel Data Using Brms
    and Rethinking - Part 2},
  date = {2022-02-23},
  url = {https://www.andreashandel.com/posts/2022-02-23-longitudinal-multilevel-bayes-2},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-handel2022" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Andreas Handel. 2022. <span>“Bayesian Analysis of Longitudinal
Multilevel Data Using Brms and Rethinking - Part 2.”</span> February 23,
2022. <a href="https://www.andreashandel.com/posts/2022-02-23-longitudinal-multilevel-bayes-2">https://www.andreashandel.com/posts/2022-02-23-longitudinal-multilevel-bayes-2</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="andreashandel/andreashandelwebsite" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left"><i class="fa-regular fa-copyright" aria-hidden="true"></i> Andreas Handel, 2022<br> All content licensed under <i class="fa-brands fa-creative-commons" aria-hidden="true"></i> <i class="fa-brands fa-creative-commons-by" aria-hidden="true"></i> <i class="fa-brands fa-creative-commons-sa" aria-hidden="true"></i> <i class="fa-brands fa-creative-commons-nc" aria-hidden="true"></i> <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">(CC BY-NC-SA 4.0)</a></div>   
      <div class="nav-footer-center"><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">Made with <i class="fa-brands fa-r-project" aria-hidden="true"></i> and <a href="https://quarto.org/">Quarto</a><br> Inspiration and code snippets taken from <a href="../../posts/quarto-website-migration.html">these folks.</a><br> <a href="https://github.com/andreashandel/andreashandelwebsite">Source at <i class="fa-brands fa-github" aria-hidden="true"></i> GitHub</a></div>
  </div>
</footer>



</body></html>