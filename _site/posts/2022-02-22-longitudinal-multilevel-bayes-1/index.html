<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andreas Handel">
<meta name="dcterms.date" content="2022-02-22">
<meta name="description" content="Andreas Handel‚Äôs personal website.">

<title>Andreas Handel - Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../..//files/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script type="text/plain" cookie-consent="tracking">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-48442618-4', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script> 
  

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../customstyle.css">
<meta name="twitter:title" content="Andreas Handel - Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 1">
<meta name="twitter:description" content="Part 1 of a tutorial showing how to specify models and simulate data for a longitudinal multilevel setup.">
<meta name="twitter:image" content="https://www.andreashandel.com/posts\2022-02-22-longitudinal-multilevel-bayes-1\featured.png">
<meta name="twitter:creator" content="@andreashandel">
<meta name="twitter:image-height" content="1800">
<meta name="twitter:image-width" content="1800">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../files/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Andreas Handel</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html">Posts</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../presentations.html">Presentations</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html">Projects</a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 1</h1>
                  <div>
        <div class="description">
          Part 1 of a tutorial showing how to specify models and simulate data for a longitudinal multilevel setup.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">Data Analysis</div>
                <div class="quarto-category">Bayesian</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Andreas Handel </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 22, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#further-resources" id="toc-further-resources" class="nav-link active" data-scroll-target="#further-resources">Further resources</a></li>
  <li><a href="#acknowledgments" id="toc-acknowledgments" class="nav-link" data-scroll-target="#acknowledgments">Acknowledgments</a></li>
  <li><a href="#disclaimer" id="toc-disclaimer" class="nav-link" data-scroll-target="#disclaimer">Disclaimer</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#who-this-is-not-for" id="toc-who-this-is-not-for" class="nav-link" data-scroll-target="#who-this-is-not-for">Who this is (not) for</a></li>
  <li><a href="#the-overall-setup" id="toc-the-overall-setup" class="nav-link" data-scroll-target="#the-overall-setup">The overall setup</a></li>
  <li><a href="#building-the-models" id="toc-building-the-models" class="nav-link" data-scroll-target="#building-the-models">Building the models</a>
  <ul class="collapse">
  <li><a href="#model-for-outcome-the-likelihood" id="toc-model-for-outcome-the-likelihood" class="nav-link" data-scroll-target="#model-for-outcome-the-likelihood">Model for outcome (the likelihood)</a></li>
  <li><a href="#model-for-deterministic-trajectories" id="toc-model-for-deterministic-trajectories" class="nav-link" data-scroll-target="#model-for-deterministic-trajectories">Model for deterministic trajectories</a></li>
  <li><a href="#numerical-trickeries" id="toc-numerical-trickeries" class="nav-link" data-scroll-target="#numerical-trickeries">Numerical trickeries</a></li>
  <li><a href="#modeling-the-main-model-parameters" id="toc-modeling-the-main-model-parameters" class="nav-link" data-scroll-target="#modeling-the-main-model-parameters">Modeling the main model parameters</a></li>
  <li><a href="#some-rescaling" id="toc-some-rescaling" class="nav-link" data-scroll-target="#some-rescaling">Some rescaling</a></li>
  <li><a href="#quick-summary" id="toc-quick-summary" class="nav-link" data-scroll-target="#quick-summary">Quick summary</a></li>
  <li><a href="#specifying-priors" id="toc-specifying-priors" class="nav-link" data-scroll-target="#specifying-priors">Specifying priors</a></li>
  <li><a href="#model-1" id="toc-model-1" class="nav-link" data-scroll-target="#model-1">Model 1</a></li>
  <li><a href="#model-2" id="toc-model-2" class="nav-link" data-scroll-target="#model-2">Model 2</a></li>
  <li><a href="#model-3" id="toc-model-3" class="nav-link" data-scroll-target="#model-3">Model 3</a></li>
  <li><a href="#model-4" id="toc-model-4" class="nav-link" data-scroll-target="#model-4">Model 4</a></li>
  <li><a href="#recap" id="toc-recap" class="nav-link" data-scroll-target="#recap">Recap</a></li>
  <li><a href="#comment-on-terminology" id="toc-comment-on-terminology" class="nav-link" data-scroll-target="#comment-on-terminology">Comment on terminology</a></li>
  </ul></li>
  <li><a href="#simulating-data" id="toc-simulating-data" class="nav-link" data-scroll-target="#simulating-data">Simulating data</a>
  <ul class="collapse">
  <li><a href="#general-settings" id="toc-general-settings" class="nav-link" data-scroll-target="#general-settings">General settings</a></li>
  <li><a href="#setting-parameter-values" id="toc-setting-parameter-values" class="nav-link" data-scroll-target="#setting-parameter-values">Setting parameter values</a></li>
  <li><a href="#creating-simulated-data" id="toc-creating-simulated-data" class="nav-link" data-scroll-target="#creating-simulated-data">Creating simulated data</a></li>
  <li><a href="#plotting-the-simulated-data" id="toc-plotting-the-simulated-data" class="nav-link" data-scroll-target="#plotting-the-simulated-data">Plotting the simulated data</a></li>
  <li><a href="#saving-the-simulated-data" id="toc-saving-the-simulated-data" class="nav-link" data-scroll-target="#saving-the-simulated-data">Saving the simulated data</a></li>
  </ul></li>
  <li><a href="#summary-and-continuation" id="toc-summary-and-continuation" class="nav-link" data-scroll-target="#summary-and-continuation">Summary and continuation</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>This is a tutorial and worked example, to illustrate how one can use the <code>brms</code> and <code>rethinking</code> R packages to perform a Bayesian analysis of longitudinal data in a multilevel/hierarchical/mixed-effects setup.</p>
<p>I wrote it mainly for my own benefit/learning (nothing forces learning a concept like trying to explain it.) Hopefully, others find it useful too.</p>
<p>It started out as a single post, then became too large and is now a multi-part series. It currently has the following parts:</p>
<ul>
<li>In part 1 (this post), I am introducing the setup and the models and use them to simulate data.</li>
<li>In <a href="../../posts/longitudinal-multilevel-bayesian-analysis-2/">part 2</a>, I fit the data to the models using the <code>rethinking</code> R package.</li>
<li>In <a href="../../posts/longitudinal-multilevel-bayesian-analysis-3/">part 3</a>, I repeat the fitting, but now using the <code>brms</code> R package.</li>
<li>In part <a href="../../posts/longitudinal-multilevel-bayesian-analysis-4">part 4</a>, I show some some further explorations and alternatives of the models.</li>
</ul>
<p>I generally place further resources and acknowledgments sections at the end. However, since this series seems to be expanding and there is no clear order, I decided to get it out of the way and place these items right here at the beginning, before starting with the tutorial sequence.</p>
<section id="further-resources" class="level1">
<h1>Further resources</h1>
<p>Pretty much all I learned and described here comes from <a href="https://xcelab.net/rm/">Richard McElreath‚Äôs</a> excellent book <a href="https://xcelab.net/rm/statistical-rethinking/">Statistical Rethinking</a>. His courses are also great. I watched all lectures of his <a href="https://github.com/rmcelreath/stat_rethinking_2022">2022 course</a>. McElreath does everything using the <code>rethinking</code> package, which he wrote. <a href="https://solomonkurz.netlify.app/">Solomon Kurz</a> wrote an adaptation of the Statistical Rethinking book, which re-implements everything using <code>brms</code>. This great resource <a href="https://bookdown.org/content/4857/">can be found here.</a></p>
<p>For some more materials specifically on longitudinal data analysis, see <a href="https://bookdown.org/content/4253/">this online book by Solomon Kurz</a>, as well as the underlying textbook that his adaption is based on.</p>
<p>A good resource by <a href="https://m-clark.github.io/">Michael Clark</a>, which discusses how to fit mixed (hierarchical/multilevel) models with <code>R</code> in both a frequentist and Bayesian framework, <a href="https://m-clark.github.io/mixed-models-with-R/">can be found here.</a></p>
<p><a href="https://www.andrewheiss.com/">Andrew Heiss</a> also has a lot of good <a href="https://www.andrewheiss.com/blog/">blog posts</a> which cover fitting Bayesian models in R.</p>
<p>For more advanced materials, check out <a href="https://betanalpha.github.io/">Michael Betancourt‚Äôs</a> writings.</p>
<p>I mention some other resources throughout the text.</p>
</section>
<section id="acknowledgments" class="level1">
<h1>Acknowledgments</h1>
<p>In addition to the resources I just listed, I want to mention my (at the time of this writing) PhD students <a href="https://yangepi.github.io/">Yang Ge</a> and <a href="https://wzbillings.com/">Zane Billings</a>, who helped me work and think through this material and clear up some of my at times confused ideas. <a href="https://www.metrumrg.com/team_member/jonathan-french-sc-d/">Jonathan French</a> spotted a typo in my data generation code which led to initial model results that made no sense (now they make more sense) and provided additional useful feedback.</p>
</section>
<section id="disclaimer" class="level1">
<h1>Disclaimer</h1>
<p>I am starting to feel somewhat comfortable with that whole Bayesian/multilevel/partial pooling business. But I am still not sure I fully, truly understand every aspect. Or maybe I should say that I <strong>am</strong> sure I <strong>don‚Äôt</strong> fully understand üòÑ. It still seems a bit magical at times. Maybe it is just like quantum mechanics - once you‚Äôve solved the Schroedinger equation often enough, you get a feeling of ‚Äúunderstanding‚Äù, but I‚Äôm not sure full understanding happens - at least it never did for me. Maybe that‚Äôs as much as I can expect from Bayesian multilevel modeling too üòÅ.</p>
<p>Thus, it is quite possible the following posts contain thinking (or coding) mistakes. If you spot any, I‚Äôd appreciate feedback. And with that disclaimer out of the way, let‚Äôs get the tutorial started.</p>
</section>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>I was trained as a Physicist, and I never formally learned statistics. My statistical mechanics courses were the most stats-type instruction I received. The joke in physics is that if you need statistics to analyze your data, you should have done a better experiment. And I was doing theoretical physics anyway, so no data was touched or harmed for my PhD thesis üòÅ.</p>
<p>That is all to say, the stats I know is self-taught. I started learning some stats during my postdoc, and once I started my faculty position in an Epidemiology &amp; Biostatistics department, I picked up more.</p>
<p>I have always been drawn to the Bayesian perspective. It just seems to make most sense to me. However, frequentist material was (and still is) more ubiquitous and readily available. Thus, I picked up those approaches first and applied (and likely misapplied) them in various projects. But I‚Äôve always been meaning to properly learn and use Bayesian approaches.</p>
<p>I finally had the combination of two PhD students with strong stats skills and interests, and exposure to <a href="https://xcelab.net/rm/statistical-rethinking/">Statistical Rethinking</a> by Richard McElreath, which has put me on the - far from completed - path towards finally learning how to analyze data in a Bayesian framework.</p>
<p>Together with learning Bayesian methods, I‚Äôve been learning the multilevel/hierarchical fitting approach, which is also new to me. This series of posts is a ‚Äúthinking out loud‚Äù tutorial in which I walk through some of the stuff I learned so far.</p>
<p>The focus is on simulating and fitting longitudinal (panel, time-series) data in a multilevel framework using the <code>rethinking</code> and <code>brms</code> R packages.</p>
<p>There are of course other tutorials on this topic online. For instance <a href="https://www.andrewheiss.com/">Andrew Heiss</a> has a nice one <a href="https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/">here</a> (he has a lot of other good tutorials on his website). The problem for me is that he only uses <code>brms</code> and often doesn‚Äôt fully specify the model/priors. And that‚Äôs a step too advanced for me, I need to see every small baby step üòÑ.</p>
<p>So to teach myself how this all works and how to do it in R, I created some simulated data and code to fit it. For my own future reference, and maybe also for others, here is my write-up/tutorial.</p>
</section>
<section id="who-this-is-not-for" class="level1">
<h1>Who this is (not) for</h1>
<p>If you are completely new to Bayesian analyses, this might be too advanced. I‚Äôm trying to go slow, but I don‚Äôt explain everything. E.g., I assume you know some of the terminology and components of Bayesian models (e.g., prior, likelihood, posterior, chains.) I also assume you have a bit of familiarity with the general ideas of statistical model fitting (e.g., distributions, parameters). If you are new to all of this, I very strongly recommend the above mentioned <a href="https://xcelab.net/rm/statistical-rethinking/">Statistical Rethinking</a> book. The book unfortunately only exists in a paid (and not cheap) version, but if you really want to learn this material, I think it‚Äôs worth the investment.</p>
<p>If you are an experienced Bayesian multilevel modeler, you‚Äôll likely won‚Äôt learn anything here either. You can still keep reading and then (gently) let me know all the things I got wrong or could do better üòÅ - I‚Äôm still learning that stuff myself and appreciate feedback!</p>
</section>
<section id="the-overall-setup" class="level1">
<h1>The overall setup</h1>
<p>The data that motivated this tutorial and that I have in mind here is virus load measured over time for individuals who were infected (challenged) with virus inoculum at different doses (3 for this specific case, but that doesn‚Äôt really matter). To make this specific, here is a preview of the kind of simulated data we‚Äôll produce and explore, namely time-series of virus load measurements for a few individuals who received a virus challenge with three different virus doses (H = high (1000), M = medium (100), L = low (10)). Note that while I‚Äôm showing the dose in the plot as discrete categories, throughout this example we work with the actual, numerical value for the amounts of virus given (in our example, 10/100/1000 units). If you are curious to see an alternative modeling and analysis approach that treats the dose as unordered or ordered categories, see <a href="../../posts/longitudinal-multilevel-bayesian-analysis-4/">this separate post</a>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="featured.png" class="img-fluid figure-img" style="width:80.0%"></p>
<p></p><figcaption class="figure-caption">Simulated data showing time series of outcome (here, assumed to be virus load on a log scale), for individuals receiving different virus challenge doses.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Your (and my future) data and questions will likely be different, but the overall setup is common and thus the ideas I describe here might still apply. Basically, if you have some quantity of interested that is measured over time (longitudinally) for <span class="math inline">\(N\)</span> different individuals (or other discrete units, e.g.&nbsp;cities), and you want to determine if the time-series trajectory is systematically different between individuals based on some other characteristics (e.g.&nbsp;dose, treatment status, age, city size), then this approach described here can apply. Depending on your data and scientific questions, certain adaptations might be necessary.</p>
</section>
<section id="building-the-models" class="level1">
<h1>Building the models</h1>
<p>In the following, we consider several models that can be used to both simulate data, and then fit that simulated data.</p>
<p>For our notation, <span class="math inline">\(i\)</span> indexes each individual and <span class="math inline">\(t\)</span> indexes time (considered here to be in days, but this can be any time unit).</p>
<section id="model-for-outcome-the-likelihood" class="level2">
<h2 class="anchored" data-anchor-id="model-for-outcome-the-likelihood">Model for outcome (the likelihood)</h2>
<p>For our scenario, the outcome of interest (the log of the virus load) is continuous, which we assume to be normally distributed. Note that this is technically never fully correct, since there is some lower limit of detection for the virus load, which would lead to a truncation at low values. (A similar upper limit of detection does at times also occur.) If you have such censored data, you have to decide what to do about them. Here, we assume for simplicity that all values are far away from any limits, such that a normal distribution is a good approximation.</p>
<p>Making this normal distribution assumption, the equation describing the outcome (the likelihood model) is</p>
<p><span class="math display">\[
Y_{i,t}  \sim \mathrm{Normal}\left(\mu_{i,t}, \sigma\right)
\]</span></p>
<p>The <span class="math inline">\(Y_{i,t}\)</span> are the measured outcomes (log virus load here) for each individual <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>. This is shown as symbols in the (simulated) data you can see in the figure above. The deterministic time-series trajectory for each individual is given by <span class="math inline">\(\mu_{i,t}\)</span> (shown as lines in the figure above). <span class="math inline">\(\sigma\)</span> captures variation in the data that is not accounted for by the deterministic trajectories.</p>
<p>Note that you could assume a different distribution, based on the specifics of your data. For instance, if you had a time-series of counts, you could use a Poisson distribution. Some of the details would then change, e.g., you wouldn‚Äôt have a mean and standard deviation in your model, but instead a rate. But the overall setup described here will still work the same way.</p>
</section>
<section id="model-for-deterministic-trajectories" class="level2">
<h2 class="anchored" data-anchor-id="model-for-deterministic-trajectories">Model for deterministic trajectories</h2>
<p>Next, we need to describe the underlying deterministic time-series model for the outcome.</p>
<p>There are different ways for choosing this part of the model. If you have enough information about your system to propose a mechanistic/process model, it is generally the best idea to go with such a model. Unfortunately, this is rare. Further, process models for time-series data are often implemented as differential equations, and those can take a very long time to fit.</p>
<p>A more common approach is to model the overall pattern in the data with some type of phenomenological/heuristic function, chosen to match the data reasonably well. Generalized linear models (GLM), such as linear or logistic models, fall into that category. Here, we use such a phenomenological function, but a GLM won‚Äôt describe the pattern in our data (rapid virus growth, followed by decline). Therefore, we use an equation that gets us the shape we are looking for. For our simple example here, I choose a function that grows polynomially and declines exponentially with time. To be clear, this function doesn‚Äôt try to represent any real processes or mechanisms, it is simply chosen as an easy way to capture the general pattern seen in the virus load time-series. This is very similar to the use of GLMs or other standard models, which often work well at describing the overall pattern, without assuming a mechanistic process leading to the relation between predictor and outcome assumed by the GLM.</p>
<p>The equation for our model is given by</p>
<p><span class="math display">\[
\mu_{i,t} = \log\left( t_i^{\alpha_i} e^{-\beta_i t_i} \right)  
\]</span> In the model, <span class="math inline">\(t_i\)</span> are the times for each individual <span class="math inline">\(i\)</span> at which their outcome <span class="math inline">\(Y_{i,t}\)</span> was measured. Those could be the same for each individual, which we‚Äôll do here for simplicity, but they could also be all at different times and things won‚Äôt change. The model parameters are <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span>, and their values describe the trajectory for each individual.</p>
<p>You can convince yourself with the following bit of code that this function, for the right values of <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>, gives you ‚Äúup, then down‚Äù curves as a function of time. Note that since we are modeling the log of the virus load, I already log-transformed the equation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>t <span class="ot">=</span> <span class="fu">seq</span>(<span class="fl">0.1</span>,<span class="dv">30</span>,<span class="at">length=</span><span class="dv">100</span>) <span class="co">#simulating 30 days, don't start at 0 to avoid 0/inf in plot</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="dv">20</span>; beta <span class="ot">=</span> <span class="dv">2</span>; <span class="co">#just some values to show shape</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> <span class="fu">log</span>(t<span class="sc">^</span>alpha<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>beta<span class="sc">*</span>t)) <span class="co">#log virus load</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(t,mu, <span class="at">type =</span> <span class="st">"l"</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">30</span>)) <span class="co">#looks somewhat like virus load in acute infections</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">(Log) virus load time series for the heuristic model we will use.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The simple function I use here is in fact not that great for most real data, and better functions exist. See <a href="../../posts/longitudinal-multilevel-bayesian-analysis-4/">part 4</a> of this tutorial, where I show a more complex 4-parameter function, the one we actually used for our research problem. But to keep things somewhat simple here, I‚Äôm sticking with the 2-parameter function. It is fully sufficient to illustrate all the conceptual ideas I want to discuss. It can give us time-series which look somewhat similar to real virus load data often seen in acute infections. Of course, you need to pick whatever function describes your data reasonably well.</p>
</section>
<section id="numerical-trickeries" class="level2">
<h2 class="anchored" data-anchor-id="numerical-trickeries">Numerical trickeries</h2>
<p>Let‚Äôs go on a brief detour and discuss an important topic that comes up often.</p>
<p>In the equation for <span class="math inline">\(\mu_{i,t}\)</span> I just introduced, only positive values of <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> produce reasonable trajectories. It is common to have parameters that can only take on certain values (e.g., positive, between 0-1). The problem is that by default, most fitting routines assume that the parameters that need to be estimated can take on any value. It turns out that the fitting software we will use (<a href="https://mc-stan.org/"><code>Stan</code></a> through <code>rethinking</code> and <code>brms</code>) can be told that some parameters are only positive. You‚Äôll see that in action later. But with different software, that might not be possible. Further, as you‚Äôll also see below, we don‚Äôt actually fit <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> directly, and it is tricky to enforce them to be positive using the built-in parameter constraint functionality of <code>Stan</code>.</p>
<p>A general trick is to redefine parameters and rewrite the model to ensure positivity. Here, we can do that by exponentiating the parameters <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> like this</p>
<p><span class="math display">\[
\mu_{i,t}  = \log\left( t_i^{\exp(\alpha_{i})} e^{-\exp(\beta_{i}) t_i} \right)
\]</span> Now, <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span> themselves can take any value without the danger of getting a nonsensical shape for <span class="math inline">\(\mu_{i,t}\)</span>. It is likely possible to fit the model without taking those exponents and hoping that during the fitting process, the fitting routine ‚Äúnotices‚Äù that only positive values make sense. However, it might make the numerical procedures less robust.</p>
<p>Another alternative would be to enforce positive <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span> by setting up the rest of the model such that they can only take positive values. I‚Äôll show a version for that <a href="../../posts/longitudinal-multilevel-bayesian-analysis-4/">in part 4</a>.</p>
<p>One issue with that exponentiation approach is that it can sometimes produce very large or very small numbers and lead to numerical problems. For instance, if during the fitting the solver tries <span class="math inline">\(\beta_i = 10\)</span> and time is 10, then the exponent in the second term becomes <span class="math inline">\(e^{-10 exp(10)}\)</span>, and that number is so small that <code>R</code> sets it to 0. Similarly, if the solver happens to explore <span class="math inline">\(\alpha_i = 10\)</span> at time 10, we would end up with <span class="math inline">\(10^{exp(10)}\)</span> in the first term, which <code>R</code> can‚Äôt handle and sets to Infinity. (Try by typing <code>exp(-10 * exp(10))</code> or <code>10^exp(10)</code> into the R console). In both cases, the result will not make sense and can lead to the numerical routine either completely failing and aborting with an error, or at a minimum wasting computational time by having to ignore those values. (<code>Stan</code> is good at usually not completely breaking and instead ignoring such nonsensical results, but one can waste a lot of computational time.)</p>
<p>Numerical issues like this one are not uncommon and something to always be aware of. To minimize such problems with very large/small numbers, one can often use algebraic (logarithm, exponent, etc.) rules and rewrite the equations. In our case, we can rewrite as</p>
<p><span class="math display">\[
\mu_{i,t}  =  \exp(\alpha_{i}) \log (t_{i}) -\exp(\beta_{i}) t_{i}
\]</span> Using <span class="math inline">\(\mu_{i,t}\)</span> in this form in the code seems to work fine, as you‚Äôll see. Note that this is exactly the same equation as the one above, just rewritten for numerical convenience. Nothing else has changed.</p>
</section>
<section id="modeling-the-main-model-parameters" class="level2">
<h2 class="anchored" data-anchor-id="modeling-the-main-model-parameters">Modeling the main model parameters</h2>
<p>Ok, now let‚Äôs get back to building the rest of our model. So far, we specified an equation for the virus load trajectory <span class="math inline">\(\mu_{i,t}\)</span>. We assume that every individual has their own virus-load trajectory, specified by parameters <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span>. We need to define those. We allow each individual to have their own individual-level contribution to the parameters, and also assume there is a potential population-level effect of dose.</p>
<p>The latter assumption is in fact our main scientific question. We want to know if the dose someone receives has a systematic impact on the virus load trajectories. At the same time, we want to allow for variation between individuals. We could also consider a model that allows the impact of dose to be different for every individual. With enough data, that might seem feasible. But here, we assume we have limited data. (Of course, this is just simulated data, so it is as large as we want it to be. But for the real research project which motivates this tutorial, we only have data on 20 individuals.) We also really want to focus on the overall, population-level, effect of dose, and are less interested to see if there is variation of dose effect among individuals.</p>
<p>It is not clear how to best model the potential impact of inoculum dose. We really don‚Äôt have much biological/scientific intuition. Without such additional insight, a linear assumption is generally a reasonable choice. We thus model the main parameters <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span> as being linearly related to the (log of) the dose. This assumption relating the parameter to the log of the dose is mostly heuristic. But it does make some biological sense as often in systems like this, outcomes change in response to the logarithm of some input.</p>
<p>In addition to the dose component, every individual can have their unique contribution to <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span>.</p>
<p>Writing this in equation form gives</p>
<p><span class="math display">\[
\begin{aligned}
\alpha_{i} &amp;  =  a_{0,i} + a_1 \log (D_i) \\
\beta_{i}  &amp; =  b_{0,i} + b_1 \log (D_i)
\end{aligned}
\]</span> Here, <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,i}\)</span> are the individual-level contributions of each person to the main parameters, and <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> quantify how the dose each individual receives, <span class="math inline">\(D_i\)</span>, impacts the overall time-series trajectories. <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> do not vary between individuals, thus we are only estimating the overall/mean/population-level impact of dose, and won‚Äôt try to see if different individuals respond differently to dose. If, after fitting the data, we find that the distributions for <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> are mostly around zero, we could conclude that dose does not have an impact. In contrast, if the distributions for those parameters are away from zero, we conclude that dose seems to impact the time-series trajectories.</p>
<p>Note that if we were to fit this model in a frequentist framework, we would overfit (trying to estimate too many parameters). That is because if every individual has their own <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,i}\)</span>, the model can take any shape without needing the dose-related parameters to play a role. Thus we would have non-identifiability of parameters. As you‚Äôll see in the next post of this series, this feature of potential overfitting/non-identifiability can also be seen in the Bayesian approach, but we are still able to obtain reasonable fits and parameter estimates. We‚Äôll discuss that topic in more detail in the next post.</p>
</section>
<section id="some-rescaling" class="level2">
<h2 class="anchored" data-anchor-id="some-rescaling">Some rescaling</h2>
<p>Alright, time for another brief detour.</p>
<p>The model we have is ok. But as it is written right now, the parameters <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span> describe the virus-load trajectory for an individual with a dose of 1 (log(1)=0). In our made-up example, individuals receive doses of strength 10/100/1000 but not 1. If we didn‚Äôt work with dose on a log scale, the <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span> parameters would represent trajectories for individuals who received a dose of 0. That doesn‚Äôt make sense, since anyone not being challenged with virus will not have any virus trajectory.</p>
<p>It doesn‚Äôt mean the model is wrong, one can still fit it and get reasonable estimates. But interpretation of parameters, and thus choices for priors, might get trickier. In such cases, some transformation of the data/model can be useful.</p>
<p>A common approach is to adjust predictor variables by standardizing (subtracting the mean and dividing by the standard deviation). Here we do something slightly different. We subtract the log of the middle dose. We call that dose <span class="math inline">\(D_m\)</span>. In our example it takes on the value of 100. In general, you can do any transformation that you think makes the setup and problem easier to interpret.</p>
<p>The equations then become</p>
<p><span class="math display">\[
\begin{aligned}
\alpha_{i} &amp;  =  a_{0,i} + a_1 \left(\log (D_i) - \log (D_m)\right)  \\
\beta_{i}  &amp; =  b_{0,i} + b_1 \left(\log (D_i) - \log (D_m)\right)
\end{aligned}
\]</span> Now the intercept parameters <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span> describe the main model parameters <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span>, and thus the trajectory for the virus, if the dose is at the intermediate level. Thus, these parameters are now easy to interpret.</p>
</section>
<section id="quick-summary" class="level2">
<h2 class="anchored" data-anchor-id="quick-summary">Quick summary</h2>
<p>At this stage in the model building process, our model as the following parts</p>
<p><span class="math display">\[
\begin{aligned}
\textrm{Outcome} \\
Y_{i,t}   \sim \mathrm{Normal}\left(\mu_{i,t}, \sigma\right) \\
\\
\textrm{Deterministic time-series trajectory} \\
\mu_{i,t}   =  \exp(\alpha_{i}) \log (t_{i}) -\exp(\beta_{i}) t_{i} \\
\\
\textrm{Deterministic models for main parameters} \\
\alpha_{i}   =  a_{0,i} + a_1 \left(\log (D_i) - \log (D_m)\right)  \\
\beta_{i}   =  b_{0,i} + b_1 \left(\log (D_i) - \log (D_m)\right) \\
\end{aligned}
\]</span></p>
<p>The model parameters are <span class="math inline">\(\sigma\)</span>, <span class="math inline">\(a_1\)</span>, <span class="math inline">\(b_1\)</span>, <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span>. The latter two consist of as many parameters as there are individuals in the data. So if we have <span class="math inline">\(N\)</span> individuals, we have a total of <span class="math inline">\(3+2N\)</span> parameters.</p>
<p>At this point, we could fit the model in either a Bayesian or frequentist framework. For either approach, we need to determine what (if any) additional structure we want to impose on the model parameters.</p>
<p>One approach is to not impose any further structure. We could make the assumption that every individual is completely different from each other, such that their outcomes do not inform each other. That would mean we allow values of <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span> to be different for each individual, and let them be completely independent from each other. Such a model is (in McElreath‚Äôs terminology) a <strong>no pooling model</strong>. Such a model is expected to fit the data for each individual well. But it would lead to <strong>overfitting</strong>, trying to estimate too many parameters given the data. That means the estimates for the parameters will be uncertain, and thus our question of interest, the possible impact of dose, will be hard to answer. Also, it won‚Äôt be very good at predicting future individuals.</p>
<p>On the other extreme, we could instead assume that all individuals share the same parameter values, i.e.&nbsp;<span class="math inline">\(a_{i,0} = a_0\)</span> and <span class="math inline">\(b_{i,0} = b_0\)</span>. This is called a <strong>full pooling model</strong>. You see this model often in data analyses, when investigators take the mean of some measurements and then just model the means. For our example, it we would be modeling the mean virus load time-series trajectory for all individuals in a given dose group. This type of model can extract the population level (in our case dose) effect, but by ignoring the variation among individuals for the same dose, the model is likely overly confident in its estimates, and it leads to <strong>underfitting</strong> of the data. By not allowing differences between individuals, the model is likely too restrictive and thus is not that great at capturing the patterns seen in the data. We‚Äôll explore that when we fit the models.</p>
<p>An intermediate model - and usually the best approach - is one that neither allows the <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span> to be completely independent or forces them to be exactly the same. Instead, it imposes some correlation between the parameters. This leads to the mixed/hierarchical/multilevel modeling approach. Such an approach can be implemented in both a frequentist or Bayesian framework. Here, we focus on the Bayesian approach, which I personally find more intuitive since everything is explicit and spelled out.</p>
</section>
<section id="specifying-priors" class="level2">
<h2 class="anchored" data-anchor-id="specifying-priors">Specifying priors</h2>
<p>Since we are working in a Bayesian framework, our parameters need priors. We assume that for all models we discuss below, the parameters <span class="math inline">\(a_{0,i}\)</span>, <span class="math inline">\(b_{0,i}\)</span>, <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> have priors described by Normal distributions. The standard deviation <span class="math inline">\(\sigma\)</span> is modeled by a Half-Cauchy distribution (a Cauchy distribution that‚Äôs only defined for positive values, since standard deviations need to be positive). Those choices are a mix of convention, numerical usefulness and first principles. See for instance the <a href="https://xcelab.net/rm/statistical-rethinking/">Statistical Rethinking book</a> for more details. You can likely choose other prior distributions and results might not change much. If they do, it means you don‚Äôt have a lot of data to inform your results and need to be careful about drawing conclusions.</p>
<p>The equations for our priors are</p>
<p><span class="math display">\[
\begin{aligned}
\sigma  \sim \mathrm{HalfCauchy}(0, 1)  \\
a_1  \sim \mathrm{Normal}(0.1, 0.1) \\
b_1  \sim \mathrm{Normal}(-0.1, 0.1) \\
a_{0,i}  \sim \mathrm{Normal}(\mu_a, \sigma_a) \\
b_{0,i} \sim \mathrm{Normal}(\mu_b, \sigma_a) \\
\end{aligned}
\]</span> I gave the prior distributions for <span class="math inline">\(\sigma\)</span>, <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> fixed values. I chose those values to get reasonable simulation results (as you‚Äôll see below). We will use those same values for all models. The priors for <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span> are more interesting. They depend on parameters themselves. In the next sections, we will explore different choices for those parameters <span class="math inline">\(\mu_a\)</span>, <span class="math inline">\(\mu_b\)</span>, <span class="math inline">\(\sigma_a\)</span> and <span class="math inline">\(\sigma_b\)</span>, based on the different modeling approaches described in the previous section.</p>
</section>
<section id="model-1" class="level2">
<h2 class="anchored" data-anchor-id="model-1">Model 1</h2>
<p>Our first model is one that replicates the <strong>no pooling</strong> approach. In a Bayesian framework, such a no-pooling model can be implemented by making the priors for <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span> very wide, which essentially assumes that any values are allowed, and there is (almost) no shared commonality/information among the parameters for each individual.</p>
<p>In our example, we can accomplish this by ensuring <span class="math inline">\(\sigma_a\)</span> and <span class="math inline">\(\sigma_b\)</span> are large, such that the normal distributions for <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span> become very wide. In that case, the values for the mean, <span class="math inline">\(\mu_a\)</span> and <span class="math inline">\(\mu_b\)</span> don‚Äôt matter much since we allow the model to take on any values, even those far away from the mean. Therefore, we can just set <span class="math inline">\(\mu_a\)</span> and <span class="math inline">\(\mu_b\)</span> to some reasonable values, without paying too much attention.</p>
<p>This choice for the priors leads to a Bayesian model similar to a frequentist no-pooling model.</p>
</section>
<section id="model-2" class="level2">
<h2 class="anchored" data-anchor-id="model-2">Model 2</h2>
<p>Now we‚Äôll try to reproduce the <strong>full pooling model</strong> in a Bayesian framework. We could remove the individual-level variation by setting <span class="math inline">\(a_{i,0} = a_0\)</span> and <span class="math inline">\(b_{i,0} = b_0\)</span> (and we‚Äôll do that below). But if we want to keep the structure we have above, what we need to do is to ensure the priors for those parameters are very narrow, such that every individual is forced to have more or less the same value. We can accomplish that by setting values for <span class="math inline">\(\sigma_a\)</span> and <span class="math inline">\(\sigma_b\)</span> very close to zero.</p>
<p>If we set the <span class="math inline">\(\mu_a\)</span> and <span class="math inline">\(\mu_b\)</span> parameters to some fixed values, we would enforce <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span> to take specific values too. We don‚Äôt want that, we want them to be estimated, we just want to make sure all individuals get pretty much the same estimate. To do so, we can give <span class="math inline">\(\mu_a\)</span> and <span class="math inline">\(\mu_b\)</span> their own distributions and make those wide/flat. A normal distribution for each parameter with a wide variance should work.</p>
<p>With these choices, we have a model that can find the mean for <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span>, but the spread in those parameters is minimal.</p>
</section>
<section id="model-3" class="level2">
<h2 class="anchored" data-anchor-id="model-3">Model 3</h2>
<p>Ok, so we discussed that the <strong>no pooling</strong> model 1 is too flexible and thus likely overfits, the <strong>full pooling</strong> model 2 is too rigid and likely underfits. Why not build a model that has reasonable priors in between those two? That‚Äôs a good idea and it leads us to a <strong>partial pooling</strong> model.</p>
<p>We want priors for <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span> that are not too flat/wide (model 1) or too narrow (model 2). They should allow some variation, but still ensure that there is shared information among the parameters. With that, we might be able to find a happy medium between underfitting and overfitting. Such priors are known as <strong>regularizing priors</strong>. They allow some variability for the parameters among individuals, while implementing the notion that the individuals share some commonality, and therefore their parameters should also share some common features, as indicated by belonging to the same prior distributions.</p>
<p>The question is, how to set the priors? One option is to pick some values for <span class="math inline">\(\mu_a\)</span>, <span class="math inline">\(\mu_b\)</span>, <span class="math inline">\(\sigma_a\)</span> and <span class="math inline">\(\sigma_b\)</span> (either by specifying their distributions or by directly setting values), then do prior predictive simulations, see if results look reasonable (no crazy outcomes, but still a good bit of variability) and then iterate until one found good priors. One can also explore the impact of the priors on the posterior. If they have a strong impact, it suggests there is not enough data to fully determine the posterior.</p>
<p>This approach of trial and error is reasonable, and we‚Äôll use it here for our model 3. But it also feels a bit like ad-hoc. One might want to ask the question if there is another way to pick the priors. The answer is yes, which brings us to our next model.</p>
</section>
<section id="model-4" class="level2">
<h2 class="anchored" data-anchor-id="model-4">Model 4</h2>
<p>Instead of trying to pick values for the priors manually (again, nothing wrong with that, but maybe not always optimal), one can let the data determine the priors. That approach involves estimating each of the parameters that specify the priors for <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span>.</p>
<p>The parameters <span class="math inline">\(\mu_a\)</span>, <span class="math inline">\(\mu_b\)</span>, <span class="math inline">\(\sigma_a\)</span> and <span class="math inline">\(\sigma_b\)</span> now get their own distributions, with their own priors (often called hyper-priors). The values for the hyper-priors are picked such that resulting simulations from the model produce (somewhat) reasonable trajectories, as you‚Äôll see below. In principle, one can further specify them as functions of other priors (turtles, I mean priors, all the way down!). But in most cases, including our example, not much is gained from that.</p>
<p>What now happens is that as we fit the model, our priors for <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span> share some information, and the amount of sharing is controlled by the hyper-prior parameters, which are determined by the data fitting process itself. It sounds a bit like magic, and I admit that on some deep level, I still don‚Äôt fully understand this magic, even though I can follow the steps. Maybe at some point in the future I will fully get it. For now I‚Äôm content with the level of understanding I have, and knowing that it works üòÑ.</p>
<p>This model is a <strong>partial pooling model</strong> like model 3, but now the pooling is determined <strong>adaptively</strong> by the data. This leads to a happy intermediate between the too-rigid full-pooling model and the too-flexible no-pooling model. This kind of model is often the best choice.</p>
</section>
<section id="recap" class="level2">
<h2 class="anchored" data-anchor-id="recap">Recap</h2>
<p>Ok, those were a lot of steps, so to have it all in one place, here are the models again, now shown with equations and with all components in one place.</p>
<p>All models have these parts:</p>
<p><span class="math display">\[
\begin{aligned}
\textrm{Outcome} \\
Y_{i,t}   \sim \mathrm{Normal}\left(\mu_{i,t}, \sigma\right) \\
\\
\textrm{Deterministic time-series trajectory} \\
\mu_{i,t}   =  \exp(\alpha_{i}) \log (t_{i}) -\exp(\beta_{i}) t_{i} \\
\\
\textrm{Deterministic models for main parameters} \\
\alpha_{i}   =  a_{0,i} + a_1 \left(\log (D_i) - \log (D_m)\right)  \\
\beta_{i}   =  b_{0,i} + b_1 \left(\log (D_i) - \log (D_m)\right) \\
\\
\textrm{population-level priors} \\
\sigma  \sim \mathrm{HalfCauchy}(0,1)  \\
a_1 \sim \mathrm{Normal}(0.1, 0.1) \\
b_1 \sim \mathrm{Normal}(-0.1, 0.1) \\
a_{0,i} \sim \mathrm{Normal}(\mu_a, \sigma_a) \\
b_{0,i}  \sim \mathrm{Normal}(\mu_b, \sigma_a) \\
\end{aligned}
\]</span></p>
<p>For model 1, we set the parameters describing the distribution for <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,i}\)</span> to produce un-informative/flat priors. For our example, these values work:</p>
<p><span class="math display">\[
\begin{aligned}
\mu_a &amp; = 3  \\
\mu_b &amp; = 1  \\
\sigma_a &amp; = 10  \\
\sigma_b &amp; = 10   
\end{aligned}
\]</span></p>
<p>For model 2, we set the standard deviations to a very small value and give the mean parameters somewhat flexible distributions. These work:</p>
<p><span class="math display">\[
\begin{aligned}
\mu_a &amp; \sim \mathrm{Normal}(3, 1) \\
\mu_b &amp; \sim \mathrm{Normal}(1, 1) \\
\sigma_a &amp; = 0.001  \\
\sigma_b &amp; = 0.001  
\end{aligned}
\]</span></p>
<p>As mentioned, an alternative for model 2, which I‚Äôll call model 2a, is to reduce the parameters from 2N to 2 and specify these priors for what are now population-level only parameters, like this:</p>
<p><span class="math display">\[
\begin{aligned}
a_{0} &amp;  \sim \mathrm{Normal}(3, 1) \\
b_{0} &amp; \sim \mathrm{Normal}(1, 1)
\end{aligned}
\]</span></p>
<p>For model 3, we set values that lead to priors that are reasonably intermediate between the model 1 too flat and model 2 too narrow priors. These work:</p>
<p><span class="math display">\[
\begin{aligned}
\mu_a &amp; = 3  \\
\mu_b &amp; = 1  \\
\sigma_a &amp; = 1  \\
\sigma_b &amp; = 1   
\end{aligned}
\]</span></p>
<p>Finally, model 4 has distributions for all 4 parameters. These work for our example</p>
<p><span class="math display">\[
\begin{aligned}
\mu_a &amp; \sim \mathrm{Normal}(3, 1) \\
\mu_b &amp; \sim \mathrm{Normal}(1, 1) \\
\sigma_a &amp; \sim \mathrm{HalfCauchy}(0,1)  \\
\sigma_b &amp; \sim \mathrm{HalfCauchy}(0,1)  
\end{aligned}
\]</span></p>
</section>
<section id="comment-on-terminology" class="level2">
<h2 class="anchored" data-anchor-id="comment-on-terminology">Comment on terminology</h2>
<p>I have been talking about 4 different models (or 5 if you count model 2a). As I‚Äôm sure you realized, some models are structurally the same, just with different choices for the priors. In a Bayesian framework, the priors (which includes choices for both the distribution and values) are part of the model, thus in that sense, model 1 and 3 can be considered different models, even if we only change the values for the variance priors. For the purpose of this tutorial I‚Äôll take that perspective and consider them separate models. It also makes it easier to talk about them by giving each their own label/number.</p>
</section>
</section>
<section id="simulating-data" class="level1">
<h1>Simulating data</h1>
<p>So far, we‚Äôve specified some mathematical/statistical models. It‚Äôs now time to implement them in <code>R</code>. We‚Äôll use these models both for fitting data (in the next parts of this tutorial) and for simulating data, which we are doing now. This involves translating the models into <code>R</code> code, then running them to simulate data. I‚Äôll show the code with explanations and commentary in the following sections.</p>
<p>Note that we can use any of the models to both generate simulated data, and to fit the simulated data. The model used for data generation and fitting it do not need to be the same. We‚Äôll look at that more as we go along. The following code produces simulated data for (some of) the models.</p>
<p>It‚Äôs often useful to go slow and type your own code, or copy and paste the code chunks below and execute one at a time. However, if you are in a hurry, you can find the code shown below in <a href="generatedata.R">this file</a>.</p>
<section id="general-settings" class="level2">
<h2 class="anchored" data-anchor-id="general-settings">General settings</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## General settings</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co">#for reproducibility</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># days at which we assume outcome is measured</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>timevec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">10</span>,<span class="dv">14</span>,<span class="dv">21</span>,<span class="dv">28</span>,<span class="dv">35</span>,<span class="dv">42</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#different number of individuals per dose to make it clearer which is which</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#also, that's the structure of the data which motivated the tutorial</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>Nlow <span class="ot">=</span> <span class="dv">7</span>; Nmed <span class="ot">=</span> <span class="dv">8</span>; Nhigh <span class="ot">=</span> <span class="dv">9</span>; filename <span class="ot">=</span> <span class="st">"simdat.Rds"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#if you want to explore how model fitting changes if you increase sample size</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#turn on this line of code</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#this is used in part 4 of the tutorial</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">#Nlow = 70; Nmed = 80; Nhigh = 90; filename = "simdat_big.Rds"</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>Ntot <span class="ot">=</span> Nlow <span class="sc">+</span> Nmed <span class="sc">+</span> Nhigh; <span class="co">#total number of individuals</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Set values for dose</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># since we only consider dose on a log scale</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># we'll log transform right here and then always use it in those log units</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>high_dose <span class="ot">=</span> <span class="fu">log</span>(<span class="dv">1000</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>med_dose <span class="ot">=</span> <span class="fu">log</span>(<span class="dv">100</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>low_dose <span class="ot">=</span> <span class="fu">log</span>(<span class="dv">10</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>dosevec <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">rep</span>(low_dose,Nlow),<span class="fu">rep</span>(med_dose,Nmed),<span class="fu">rep</span>(high_dose,Nhigh))</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># we are also creating a version of the dose variable</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co"># that consists of ordered categories instead of numeric values</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># we'll use that mostly for plotting</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>dosevec_cat <span class="ot">=</span> <span class="fu">ordered</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"low"</span>, Nlow),</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">rep</span>(<span class="st">"medium"</span>,Nmed),</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">rep</span>(<span class="st">"high"</span>,Nhigh)),</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>                      <span class="at">levels=</span><span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"medium"</span>,<span class="st">"high"</span>))</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="do">## Setting parameter values</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I chose fairly low sample sizes, with less than 10 individuals for each dose group. This is motivated by the real data I have in mind, which has similar sample sizes. Of course, more data is generally better. In <a href="../../posts/longitudinal-multilevel-bayesian-analysis-4">part 4 of the tutorial</a> I play around a bit with fitting larger samples.</p>
</section>
<section id="setting-parameter-values" class="level2">
<h2 class="anchored" data-anchor-id="setting-parameter-values">Setting parameter values</h2>
<p>The parameters <span class="math inline">\(\sigma\)</span>, <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> show up in all models. For easy comparison between models, I‚Äôm setting them to the same value for all models.</p>
<p>For the estimation procedure (see <a href="../../posts/longitudinal-multilevel-bayesian-analysis-1/">part 2</a>), we assume that those parameters follow the distributions shown above. We could sample a single value for each of them from such a distribution. But to reduce variability and to more easily compare estimated parameters to those used to simulate the data, I‚Äôm setting them to specific values, which you can conceptually think of as being a single sample from the distributions we discussed above. It makes sense to chose their means as the value to use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>a1 <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now well get values for the other parameters. For model 1, we have <span class="math inline">\(N\)</span> parameters for <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span>, with priors that are very wide. We set them as follows</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>m1_mua <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>m1_mub <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>m1_sigmaa <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>m1_sigmab <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>m1_a0 <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="at">n=</span>Ntot, m1_mua, m1_sigmaa)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>m1_b0 <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="at">n=</span>Ntot, m1_mub, m1_sigmaa)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># saving main parameters</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>m1pars <span class="ot">=</span> <span class="fu">c</span>(<span class="at">sigma =</span> sigma, <span class="at">a1 =</span> a1, <span class="at">b1 =</span> b1,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">a0_mu =</span> m1_mua, <span class="at">b0_mu =</span> m1_mub)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note a few things here. First, the priors are narrower than I specified above. As you will see in the figures below, even with these less wide priors, results for model 1 still look way too variable. We can use the wider priors when we fit the model, to allow the data to dominate the fits. But for data generation, going too wild/wide seems pointless.</p>
<p>Second, you noticed that I did sample from distributions for the <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span> parameters. That‚Äôs not necessary, I could have also specified values for each of the parameters, like I did for <span class="math inline">\(\sigma\)</span>, <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>, as long as the values can be thought of as coming from the underlying distribution. If I sample, I need to make sure to set a random seed (which I did above) to ensure reproducibility.</p>
<p>Lastly, I‚Äôm saving the parameters in a vector which will be added to the generated data so we can keep track of the parameters that were used to generate the data, and compare later with the estimates from the models.</p>
<p>Ok, now for model 2. We have 2 versions, model 2a collapses the individual-level parameters into a single population one. We‚Äôll explore that model when doing the fitting, for simulating the data I‚Äôm just going with model 2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>m2_mua <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>m2_mub <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>m2_sigmaa <span class="ot">=</span> <span class="fl">0.0001</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>m2_sigmab <span class="ot">=</span> <span class="fl">0.0001</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>m2_a0 <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="at">n=</span>Ntot, m2_mua, m2_sigmaa)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>m2_b0 <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="at">n=</span>Ntot, m2_mub, m2_sigmab)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>m2pars <span class="ot">=</span> <span class="fu">c</span>(<span class="at">sigma =</span> sigma, <span class="at">a1 =</span> a1, <span class="at">b1 =</span> b1,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">a0_mu =</span> m2_mua, <span class="at">b0_mu =</span> m2_mub)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, model 3 with priors that have a width between those of model 1 and model 2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>m3_mua <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>m3_mub <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>m3_sigmaa <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>m3_sigmab <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>m3_a0 <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="at">n=</span>Ntot, m3_mua, m3_sigmaa)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>m3_b0 <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="at">n=</span>Ntot, m3_mub, m3_sigmaa)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>m3pars <span class="ot">=</span> <span class="fu">c</span>(<span class="at">sigma =</span> sigma, <span class="at">a1 =</span> a1, <span class="at">b1 =</span> b1,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">a0_mu =</span> m3_mua, <span class="at">b0_mu =</span> m3_mub)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that for the purpose of simulating data, model 4 is basically the same as model 3. We would need to sample (or pick) values for the parameters <span class="math inline">\(\mu_a\)</span>, <span class="math inline">\(\sigma_a\)</span>, <span class="math inline">\(\mu_b\)</span>, and <span class="math inline">\(\sigma_b\)</span> and then use them to sample (or set) values for <span class="math inline">\(a_{i,0}\)</span> and <span class="math inline">\(b_{i,0}\)</span>. This setup makes sense during fitting, but for generating data, it isn‚Äôt really different than what er already did. You can conceptually assume we did sample parameters and happen to get the values shown for model 3. Thus, model 4 collapses to the models we already specified.</p>
<p>Overall, when generating data, we can go through all steps of sampling from each specified distribution to get values. Nothing wrong with that. But if we change the random seed, values change. And it is harder to compare the parameters used to generate the data with those that are estimated. Thus, it is generally easier during the data generation process to assume conceptually that values correspond to samples from distributions, but then set the values manually. Above, we used that approach for most parameters. We did sample the <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,i}\)</span> to show explicitly the sampling steps involved in generating simulated data from our Bayesian models.</p>
</section>
<section id="creating-simulated-data" class="level2">
<h2 class="anchored" data-anchor-id="creating-simulated-data">Creating simulated data</h2>
<p>Now we can combine the parameters as specified in the equations above to get simulated trajectories for each individual, for each of the models. We just need to add the parameters together in the way prescribed by the model to get to the outcome. This is a nice feature of Bayesian models, that you can run them both ‚Äúforward‚Äù to generate data given parameter values, and ‚Äúbackward‚Äù to estimate parameter values, given the data. Because of that feature, Bayesian models are generative models.</p>
<p>Here is the code that computes the mean and the outcome for model 1, the wide model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>m1_alpha <span class="ot">=</span> m1_a0 <span class="sc">+</span> a1<span class="sc">*</span>(dosevec <span class="sc">-</span> med_dose)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>m1_beta <span class="ot">=</span> m1_b0 <span class="sc">+</span> b1<span class="sc">*</span>(dosevec <span class="sc">-</span> med_dose)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#doing matrix multiplication to get time-series for each individual</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#for that to work, the timevec vector needs to be transposed</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>m1_mu <span class="ot">=</span>  <span class="fu">exp</span>(m1_alpha) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">log</span>(timevec)) <span class="sc">-</span> <span class="fu">exp</span>(m1_beta) <span class="sc">%*%</span> <span class="fu">t</span>(timevec)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># apply variation following a normal distribution to each data point</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>m1_y <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(m1_mu),m1_mu, sigma)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># in a final step, we reorganize the data into a long data frame with</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># columns id, time, dose, model,</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># the deterministic mean mu, and the normally distributed outcome.</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># We store dose in 3 versions, the original (log transformed one),</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># the one that has the middle value subtracted, and a categorical one.</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that trick using sort to get time in the right order.</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Not a robust way of doing things, but works here</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>m1_dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>Ntot,<span class="fu">length</span>(timevec)),</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">dose =</span> <span class="fu">rep</span>(dosevec,<span class="fu">length</span>(timevec)),</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">dose_adj =</span> <span class="fu">rep</span>(dosevec,<span class="fu">length</span>(timevec))<span class="sc">-</span>med_dose,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>                     <span class="at">dose_cat =</span>  <span class="fu">rep</span>(dosevec_cat,<span class="fu">length</span>(timevec)),</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>                     <span class="at">time =</span> <span class="fu">sort</span>(<span class="fu">rep</span>(timevec,Ntot)),</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mu =</span> <span class="fu">as.vector</span>(m1_mu),</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>                     <span class="at">outcome =</span> <span class="fu">as.vector</span>(m1_y),</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">"m1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we just repeat the same code again for the other models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#model 2</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>m2_alpha <span class="ot">=</span> m2_a0 <span class="sc">+</span> a1<span class="sc">*</span>(dosevec <span class="sc">-</span> med_dose)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>m2_beta <span class="ot">=</span> m2_b0 <span class="sc">+</span> b1<span class="sc">*</span>(dosevec <span class="sc">-</span> med_dose)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>m2_mu <span class="ot">=</span>  <span class="fu">exp</span>(m2_alpha) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">log</span>(timevec)) <span class="sc">-</span> <span class="fu">exp</span>(m2_beta) <span class="sc">%*%</span> <span class="fu">t</span>(timevec)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>m2_y <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(m2_mu),m2_mu, sigma)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>m2_dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>Ntot,<span class="fu">length</span>(timevec)),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">dose =</span> <span class="fu">rep</span>(dosevec,<span class="fu">length</span>(timevec)),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">dose_adj =</span> <span class="fu">rep</span>(dosevec,<span class="fu">length</span>(timevec))<span class="sc">-</span>med_dose,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">dose_cat =</span>  <span class="fu">rep</span>(dosevec_cat,<span class="fu">length</span>(timevec)),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">time =</span> <span class="fu">sort</span>(<span class="fu">rep</span>(timevec,Ntot)),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mu =</span> <span class="fu">as.vector</span>(m2_mu),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">outcome =</span> <span class="fu">as.vector</span>(m2_y),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">"m2"</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">#model 3</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>m3_alpha <span class="ot">=</span> m3_a0 <span class="sc">+</span> a1<span class="sc">*</span>(dosevec <span class="sc">-</span> med_dose)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>m3_beta <span class="ot">=</span> m3_b0 <span class="sc">+</span> b1<span class="sc">*</span>(dosevec <span class="sc">-</span> med_dose)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>m3_mu <span class="ot">=</span>  <span class="fu">exp</span>(m3_alpha) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">log</span>(timevec)) <span class="sc">-</span> <span class="fu">exp</span>(m3_beta) <span class="sc">%*%</span> <span class="fu">t</span>(timevec)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>m3_y <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(m3_mu),m3_mu, sigma)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>m3_dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>Ntot,<span class="fu">length</span>(timevec)),</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>                     <span class="at">dose =</span> <span class="fu">rep</span>(dosevec,<span class="fu">length</span>(timevec)),</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>                     <span class="at">dose_adj =</span> <span class="fu">rep</span>(dosevec,<span class="fu">length</span>(timevec))<span class="sc">-</span>med_dose,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>                     <span class="at">dose_cat =</span>  <span class="fu">rep</span>(dosevec_cat,<span class="fu">length</span>(timevec)),</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>                     <span class="at">time =</span> <span class="fu">sort</span>(<span class="fu">rep</span>(timevec,Ntot)),</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mu =</span> <span class="fu">as.vector</span>(m3_mu),</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">outcome =</span> <span class="fu">as.vector</span>(m3_y),</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">"m3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plotting-the-simulated-data" class="level2">
<h2 class="anchored" data-anchor-id="plotting-the-simulated-data">Plotting the simulated data</h2>
<p>To ensure our simulated data makes sense, let‚Äôs plot what we produced. We‚Äôll use <code>ggplot2</code>, so let‚Äôs load it first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'ggplot2'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These lines of code create plots for each model/simulated dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(m1_dat) <span class="sc">+</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>mu, <span class="at">col =</span> dose_cat, <span class="at">group =</span> id)) <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>outcome, <span class="at">col =</span> dose_cat)) <span class="sc">+</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>,<span class="dv">200</span>)) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Outcome (log virus load)"</span>,  <span class="at">x =</span> <span class="st">"Time (days)"</span>) <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(m2_dat) <span class="sc">+</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>mu, <span class="at">col =</span> dose_cat, <span class="at">group =</span> id)) <span class="sc">+</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>outcome, <span class="at">col =</span> dose_cat)) <span class="sc">+</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>,<span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Outcome (log virus load)"</span>,  <span class="at">x =</span> <span class="st">"Time (days)"</span>) <span class="sc">+</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(m3_dat) <span class="sc">+</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>mu, <span class="at">col =</span> dose_cat, <span class="at">group =</span> id)) <span class="sc">+</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>time, <span class="at">y=</span>outcome, <span class="at">col =</span> dose_cat)) <span class="sc">+</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>,<span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Outcome (log virus load)"</span>,  <span class="at">x =</span> <span class="st">"Time (days)"</span>) <span class="sc">+</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let‚Äôs plot the simulated data. For each plot, the lines show the deterministic mean trajectory, and the symbols show the outcomes, which have some extra variation on top, determined by the value of <span class="math inline">\(\sigma\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/showplots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/showplots-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/showplots-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As you can see, the priors for model 1 are so wide that some of the resulting trajectories are not reasonable. The variation between individuals is so strong that the dose effect - which we programmed into the simulated data to exist - is swamped out. That could certainly be true for real data, sometimes there is just too much noise/variability to detect a pattern, even if it exists. But some of the trajectories produce virus load that‚Äôs just biologically unreasonable (note how high the y-values go.)</p>
<p>On the other extreme, the priors for model 2 allow so little variation that the individual-level variation is minimal and the only effect that is noticable is the dose dependence we assumed in our model (by setting <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> to non-zero values).</p>
<p>Model 3 produces the most reasonable trajectories, with both the dose-effect showing, and some variation between individuals.</p>
</section>
<section id="saving-the-simulated-data" class="level2">
<h2 class="anchored" data-anchor-id="saving-the-simulated-data">Saving the simulated data</h2>
<p>Finally, let‚Äôs combine all the simulated data into a single list containing all data frames, and save it. I‚Äôm also saving the parameters for each model, and sample sizes, so we can quickly retrieve them when we compare with the model estimates.</p>
<p>We‚Äôll also save one of the plots (this is mainly so I can show it at the beginning of the tutorial).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save a plot so we can use it in the blog post</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>simdat <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">m1 =</span> m1_dat, <span class="at">m2 =</span> m2_dat, <span class="at">m3 =</span> m3_dat, <span class="at">m1pars =</span> m1pars, <span class="at">m2pars =</span> m2pars, <span class="at">m3pars =</span> m3pars, <span class="at">Nlow =</span> Nlow, <span class="at">Nmed =</span> Nmed, <span class="at">Nhigh =</span> Nhigh)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(simdat, <span class="at">file =</span> filename)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">"featured.png"</span>), p3, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">width =</span> <span class="dv">6</span>, <span class="at">height =</span> <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 53 row(s) containing missing values (geom_path).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 53 rows containing missing values (geom_point).</code></pre>
</div>
</div>
<p>We‚Äôll load and use the <code>simdat</code> file in the next parts of the tutorial.</p>
</section>
</section>
<section id="summary-and-continuation" class="level1">
<h1>Summary and continuation</h1>
<p>To sum it up, we specified several models that could be used to both fit and generate simulated time-series data for individuals that might differ by some additional factor (here, dose). We wrote some code that simulated data, which we then plotted to make sure it looks reasonable.</p>
<p>Of course, the main part of fitting the data is still missing. I had planned to do the whole process in a single tutorial. But it‚Äôs gotten so long that I decided to split the model definition and data simulation from the fitting. So as a next step, <a href="../../posts/longitudinal-multilevel-bayesian-analysis-2/">hop on over to part 2</a> where we now fit these models and simulated data.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{handel2022,
  author = {Andreas Handel},
  editor = {},
  title = {Bayesian Analysis of Longitudinal Multilevel Data Using Brms
    and Rethinking - Part 1},
  date = {2022-02-22},
  url = {https://www.andreashandel.com/posts/2022-02-22-longitudinal-multilevel-bayes-1},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-handel2022" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Andreas Handel. 2022. <span>‚ÄúBayesian Analysis of Longitudinal
Multilevel Data Using Brms and Rethinking - Part 1.‚Äù</span> February 22,
2022. <a href="https://www.andreashandel.com/posts/2022-02-22-longitudinal-multilevel-bayes-1">https://www.andreashandel.com/posts/2022-02-22-longitudinal-multilevel-bayes-1</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } 
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="andreashandel/andreashandelwebsite" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left"><i class="fa-regular fa-copyright" aria-hidden="true"></i> Andreas Handel, 2022<br> All content licensed under <i class="fa-brands fa-creative-commons" aria-hidden="true"></i> <i class="fa-brands fa-creative-commons-by" aria-hidden="true"></i> <i class="fa-brands fa-creative-commons-sa" aria-hidden="true"></i> <i class="fa-brands fa-creative-commons-nc" aria-hidden="true"></i> <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">(CC BY-NC-SA 4.0)</a></div>   
      <div class="nav-footer-center"><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">Made with <i class="fa-brands fa-r-project" aria-hidden="true"></i> and <a href="https://quarto.org/">Quarto</a><br> Inspiration and code snippets taken from <a href="../../posts/quarto-website-migration.html">these folks.</a><br> <a href="https://github.com/andreashandel/andreashandelwebsite">Source at <i class="fa-brands fa-github" aria-hidden="true"></i> GitHub</a></div>
  </div>
</footer>



</body></html>