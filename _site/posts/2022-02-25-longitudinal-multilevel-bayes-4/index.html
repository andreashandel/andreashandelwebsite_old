<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andreas Handel">
<meta name="dcterms.date" content="2022-02-25">
<meta name="description" content="Andreas Handel’s personal website.">

<title>Andreas Handel - Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 4</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../..//files/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script type="text/plain" cookie-consent="tracking">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-48442618-4', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script> 
  

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../customstyle.css">
<meta name="twitter:title" content="Andreas Handel - Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 4">
<meta name="twitter:description" content="Some more musings and explorations that didn't fit into the main posts of this series.">
<meta name="twitter:image" content="https://www.andreashandel.com/posts\2022-02-25-longitudinal-multilevel-bayes-4\featured.png">
<meta name="twitter:creator" content="@andreashandel">
<meta name="twitter:image-height" content="1800">
<meta name="twitter:image-width" content="1800">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../files/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Andreas Handel</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html">
 <span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../presentations.html">
 <span class="menu-text">Presentations</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html">
 <span class="menu-text">Projects</span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 4</h1>
                  <div>
        <div class="description">
          Some more musings and explorations that didn’t fit into the main posts of this series.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">Data Analysis</div>
                <div class="quarto-category">Bayesian</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Andreas Handel </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 25, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#who-this-is-not-for" id="toc-who-this-is-not-for" class="nav-link" data-scroll-target="#who-this-is-not-for">Who this is (not) for</a></li>
  <li><a href="#r-setup" id="toc-r-setup" class="nav-link" data-scroll-target="#r-setup">R setup</a></li>
  <li><a href="#defining-a-few-functions" id="toc-defining-a-few-functions" class="nav-link" data-scroll-target="#defining-a-few-functions">Defining a few functions</a></li>
  <li><a href="#alternative-model-for-time-series-trajectory" id="toc-alternative-model-for-time-series-trajectory" class="nav-link" data-scroll-target="#alternative-model-for-time-series-trajectory">Alternative model for time-series trajectory</a></li>
  <li><a href="#fitting-an-alternative-data-set" id="toc-fitting-an-alternative-data-set" class="nav-link" data-scroll-target="#fitting-an-alternative-data-set">Fitting an alternative data set</a></li>
  <li><a href="#fitting-a-larger-data-set" id="toc-fitting-a-larger-data-set" class="nav-link" data-scroll-target="#fitting-a-larger-data-set">Fitting a larger data set</a></li>
  <li><a href="#alternative-to-enforcing-positivity-of-parameters" id="toc-alternative-to-enforcing-positivity-of-parameters" class="nav-link" data-scroll-target="#alternative-to-enforcing-positivity-of-parameters">Alternative to enforcing positivity of parameters</a></li>
  <li><a href="#treating-dose-as-an-unordered-categorical-variable" id="toc-treating-dose-as-an-unordered-categorical-variable" class="nav-link" data-scroll-target="#treating-dose-as-an-unordered-categorical-variable">Treating dose as an <strong>unordered</strong> categorical variable</a>
  <ul class="collapse">
  <li><a href="#a-model-that-doesnt-work" id="toc-a-model-that-doesnt-work" class="nav-link" data-scroll-target="#a-model-that-doesnt-work">A model that “doesn’t work”</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#more-things-to-try" id="toc-more-things-to-try" class="nav-link" data-scroll-target="#more-things-to-try">More things to try</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>This is a continuation with some side analyses of <a href="../../posts/longitudinal-multilevel-bayesian-analysis-1/">this tutorial</a> illustrating how one can use the <code>brms</code> and <code>rethinking</code> R packages to perform a Bayesian analysis of longitudinal data using a multilevel/hierarchical/mixed-effects setup.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>I assume you read through the main posts of the tutorial, namely <a href="../../posts/longitudinal-multilevel-bayesian-analysis-1/">this one describing model setup and data generation</a>, and <a href="../../posts/longitudinal-multilevel-bayesian-analysis-2/">this one describing fitting with rethinking</a>. You probably also looked at the <a href="../../posts/longitudinal-multilevel-bayesian-analysis-3/">fitting with <code>brms</code></a> post, though that’s optional for following along with this post.</p>
<p>Here, I’m doing a few additional explorations that just didn’t fit into the other posts. I’m doing all of these with <code>rethinking</code>.</p>
</section>
<section id="who-this-is-not-for" class="level1">
<h1>Who this is (not) for</h1>
<p>This is only for you if you read my main tutorial posts and enjoyed my musings and explorations enough that you want to see some more stuff 😁.</p>
</section>
<section id="r-setup" class="level1">
<h1>R setup</h1>
<p>Again as previously, the code shown below are housed in 2 separate R scripts, which you can get <a href="part4fitmodels.R">here</a> and <a href="part4exploremodels.R">here</a>. You can run the scripts one after the other. The code chunks don’t quite show up in that order in this post.</p>
<p>We need the same packages as previously. See comments in previous posts on how to get <code>Stan</code> installed and working.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'dplyr'</span>) <span class="co"># for data manipulation</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'ggplot2'</span>) <span class="co"># for plotting</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'cmdstanr'</span>) <span class="co">#for model fitting</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'rethinking'</span>) <span class="co">#for model fitting</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'fs'</span>) <span class="co">#for file path</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="defining-a-few-functions" class="level1">
<h1>Defining a few functions</h1>
<p>For the explorations below, I will repeat some parts, specifically the fitting, predicting and plotting components. For simplicity and to streamline code, I defined a few functions that I’m using repeatedly.</p>
<p>This function specifies the fitting part:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################################</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to fit each model</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="do">######################################</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># function to run fit so I don't need to keep repeating</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># some parameters are set globally.</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># not very clean code but good enough for here :)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>fitfunction <span class="ot">&lt;-</span> <span class="cf">function</span>(model, data, start, constraints)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  tstart<span class="ot">=</span><span class="fu">proc.time</span>(); <span class="co">#capture current time</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  fl<span class="sc">$</span>fit <span class="ot">&lt;-</span> <span class="fu">ulam</span>(<span class="at">flist =</span> model,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> data,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">start=</span>start,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">constraints=</span>constraints,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">log_lik=</span><span class="cn">TRUE</span>, <span class="at">cmdstan=</span><span class="cn">TRUE</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                 <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span>adapt_delta, <span class="at">max_treedepth =</span> max_td),</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                 <span class="at">chains=</span>chains, <span class="at">cores =</span> cores,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">warmup =</span> warmup, <span class="at">iter =</span> iter</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  )<span class="co"># end ulam statement</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  tend<span class="ot">=</span><span class="fu">proc.time</span>(); <span class="co">#capture current time</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  tdiff<span class="ot">=</span>tend<span class="sc">-</span>tstart;</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  runtime_minutes<span class="ot">=</span>tdiff[[<span class="dv">3</span>]]<span class="sc">/</span><span class="dv">60</span>;</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add some more things to the fit object</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  fl<span class="sc">$</span>runtime <span class="ot">=</span> runtime_minutes</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  fl<span class="sc">$</span>model <span class="ot">=</span> <span class="fu">names</span>(model)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(fl)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function does the prediction for the different models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># defining a function so I don't need to re-type the same code</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>predfunction <span class="ot">&lt;-</span> <span class="cf">function</span>(fl,fitdat)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#this will contain all the predictions from the different models</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  fitpred <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(fl))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># we are looping over each fitted model</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(fl))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#get current model</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    nowmodel <span class="ot">=</span> fl[[n]]<span class="sc">$</span>fit</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#make new data for which we want predictions</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#specifically, more time points so the curves are smoother</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    timevec <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.1</span>, <span class="at">to =</span> <span class="fu">max</span>(fitdat<span class="sc">$</span>time), <span class="at">length=</span><span class="dv">100</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    Ntot <span class="ot">=</span> <span class="fu">max</span>(fitdat<span class="sc">$</span>id)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#new data used for predictions</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#make variables for all versions of dose we use</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    preddat <span class="ot">=</span> <span class="fu">data.frame</span>( <span class="at">id =</span> <span class="fu">sort</span>(<span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">1</span>,Ntot),<span class="fu">length</span>(timevec))),</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time =</span> <span class="fu">rep</span>(timevec,Ntot),</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                          <span class="at">dose =</span> <span class="dv">0</span>,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>                          <span class="at">dose_adj =</span> <span class="dv">0</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>                          <span class="at">dose_adj2 =</span> <span class="dv">0</span>,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>                          <span class="at">dose_cat =</span> <span class="st">"0"</span>,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>                          <span class="at">dose_cat2 =</span> <span class="dv">0</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#add right dose information for each individual</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">#this could likely be coded better</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Ntot)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>      <span class="co">#get actual dose for a given individual</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>      <span class="co">#assign that dose</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>      <span class="co">#if statements because not every data set/model has each dose type</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="st">"dose"</span> <span class="sc">%in%</span> <span class="fu">names</span>(fitdat)) {</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        nowdose <span class="ot">=</span> <span class="fu">unique</span>(fitdat<span class="sc">$</span>dose[fitdat<span class="sc">$</span>id <span class="sc">==</span> k])</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        preddat[(preddat<span class="sc">$</span>id <span class="sc">==</span> k),<span class="st">"dose"</span>] <span class="ot">=</span> nowdose</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="st">"dose_adj"</span> <span class="sc">%in%</span> <span class="fu">names</span>(fitdat)) {</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        nowdose_adj <span class="ot">=</span> <span class="fu">unique</span>(fitdat<span class="sc">$</span>dose_adj[fitdat<span class="sc">$</span>id <span class="sc">==</span> k])</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>        preddat[(preddat<span class="sc">$</span>id <span class="sc">==</span> k),<span class="st">"dose_adj"</span>] <span class="ot">=</span> nowdose_adj</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="st">"dose_adj2"</span> <span class="sc">%in%</span> <span class="fu">names</span>(fitdat)) {</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        nowdose_adj2 <span class="ot">=</span> <span class="fu">unique</span>(fitdat<span class="sc">$</span>dose_adj2[fitdat<span class="sc">$</span>id <span class="sc">==</span> k])</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        preddat[(preddat<span class="sc">$</span>id <span class="sc">==</span> k),<span class="st">"dose_adj2"</span>] <span class="ot">=</span> nowdose_adj2</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="st">"dose_cat"</span> <span class="sc">%in%</span> <span class="fu">names</span>(fitdat)) {</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>        nowdose_cat <span class="ot">=</span> <span class="fu">unique</span>(fitdat<span class="sc">$</span>dose_cat[fitdat<span class="sc">$</span>id <span class="sc">==</span> k])</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        preddat[(preddat<span class="sc">$</span>id <span class="sc">==</span> k),<span class="st">"dose_cat"</span>] <span class="ot">=</span> <span class="fu">as.character</span>(nowdose_cat)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="st">"dose_cat2"</span> <span class="sc">%in%</span> <span class="fu">names</span>(fitdat)) {</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        nowdose_cat2 <span class="ot">=</span> <span class="fu">unique</span>(fitdat<span class="sc">$</span>dose_cat2[fitdat<span class="sc">$</span>id <span class="sc">==</span> k])</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        preddat[(preddat<span class="sc">$</span>id <span class="sc">==</span> k),<span class="st">"dose_cat2"</span>] <span class="ot">=</span> nowdose_cat2</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pull out posterior samples for the parameters</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(nowmodel)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># estimate and CI for parameter variation</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this uses the link function from rethinking</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we ask for predictions for the new data generated above</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    linkmod <span class="ot">&lt;-</span> rethinking<span class="sc">::</span><span class="fu">link</span>(nowmodel, <span class="at">data =</span> preddat)</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">#computing mean and various credibility intervals</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">#these choices are inspired by the Statistical Rethinking book</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">#and purposefully do not include 95%</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">#to minimize thoughts of statistical significance</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">#significance is not applicable here since we are doing bayesian fitting</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    modmean <span class="ot">&lt;-</span> <span class="fu">apply</span>( linkmod<span class="sc">$</span>mu , <span class="dv">2</span> , mean )</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    modPI79 <span class="ot">&lt;-</span> <span class="fu">apply</span>( linkmod<span class="sc">$</span>mu , <span class="dv">2</span> , PI , <span class="at">prob=</span><span class="fl">0.79</span> )</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    modPI89 <span class="ot">&lt;-</span> <span class="fu">apply</span>( linkmod<span class="sc">$</span>mu , <span class="dv">2</span> , PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    modPI97 <span class="ot">&lt;-</span> <span class="fu">apply</span>( linkmod<span class="sc">$</span>mu , <span class="dv">2</span> , PI , <span class="at">prob=</span><span class="fl">0.97</span> )</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># estimate and CI for prediction intervals</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this uses the sim function from rethinking</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the predictions factor in additional uncertainty around the mean (mu)</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># as indicated by sigma</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    simmod <span class="ot">&lt;-</span> rethinking<span class="sc">::</span><span class="fu">sim</span>(nowmodel, <span class="at">data =</span> preddat)</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mean and credible intervals for outcome predictions</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># modmeansim should agree with above modmean values</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    modmeansim <span class="ot">&lt;-</span> <span class="fu">apply</span>( simmod , <span class="dv">2</span> , mean )</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    modPIsim <span class="ot">&lt;-</span> <span class="fu">apply</span>( simmod , <span class="dv">2</span> , PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">#place all predictions into a data frame</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">#and store in a list for each model</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    fitpred[[n]] <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">id =</span> <span class="fu">as.factor</span>(preddat<span class="sc">$</span>id),</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>                              <span class="at">dose =</span> preddat<span class="sc">$</span>dose_cat,</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>                              <span class="at">predtime =</span> preddat<span class="sc">$</span>time,</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Estimate =</span> modmean,</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Q79lo =</span> modPI79[<span class="dv">1</span>,], <span class="at">Q79hi =</span> modPI79[<span class="dv">2</span>,],</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Q89lo =</span> modPI89[<span class="dv">1</span>,], <span class="at">Q89hi =</span> modPI89[<span class="dv">2</span>,],</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Q97lo =</span> modPI97[<span class="dv">1</span>,], <span class="at">Q97hi =</span> modPI97[<span class="dv">2</span>,],</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Qsimlo=</span>modPIsim[<span class="dv">1</span>,], <span class="at">Qsimhi=</span>modPIsim[<span class="dv">2</span>,]</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>  } <span class="co">#end loop over all models</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(fitpred)</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>} <span class="co">#end function computing predictions</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function does the plotting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># defining a function so I don't need to re-type the same code</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>plotfunction <span class="ot">&lt;-</span> <span class="cf">function</span>(fl,fitpred,fitdat)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#list for storing all plots</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  plotlist <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(fl))</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#small data adjustment for plotting</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  plotdat <span class="ot">&lt;-</span> fitdat <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>()  <span class="sc">%&gt;%</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">as.factor</span>(id))  <span class="sc">%&gt;%</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dose =</span> dose_cat)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#looping over all models, creating and storing a plot for each</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(fl))</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#adding titles to plots</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    title <span class="ot">=</span> fl[[n]]<span class="sc">$</span>model</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    plotlist[[n]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> fitpred[[n]], <span class="fu">aes</span>(<span class="at">x =</span> predtime, <span class="at">y =</span> Estimate, <span class="at">group =</span> id, <span class="at">color =</span> dose )) <span class="sc">+</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">show.legend =</span> F ) <span class="sc">+</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>predtime, <span class="at">ymin=</span>Q89lo, <span class="at">ymax=</span>Q89hi, <span class="at">fill =</span> dose, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">alpha=</span><span class="fl">0.3</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>predtime, <span class="at">ymin=</span>Qsimlo, <span class="at">ymax=</span>Qsimhi, <span class="at">fill =</span> dose, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">alpha=</span><span class="fl">0.1</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">data =</span> plotdat, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> outcome, <span class="at">group =</span> id, <span class="at">color =</span> dose), <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>,<span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Virus load"</span>,</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="st">"days post infection"</span>) <span class="sc">+</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggtitle</span>(title)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(plotlist)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>} <span class="co">#end function making plots</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These are the settings we use for all fits shown in this post:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################################</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define general fit settings</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="do">######################################</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#general settings for fitting</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">#you might want to adjust based on your computer</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>warmup <span class="ot">=</span> <span class="dv">6000</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>iter <span class="ot">=</span> warmup <span class="sc">+</span> <span class="fu">floor</span>(warmup<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>max_td <span class="ot">=</span> <span class="dv">18</span> <span class="co">#tree depth</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>adapt_delta <span class="ot">=</span> <span class="fl">0.9999</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>chains <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>cores  <span class="ot">=</span> chains</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>seed <span class="ot">=</span> <span class="dv">123</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With these function definitions and specifications out of the way, we can get to some more model explorations.</p>
</section>
<section id="alternative-model-for-time-series-trajectory" class="level1">
<h1>Alternative model for time-series trajectory</h1>
<p>In the main tutorial, I used the following two-parameter model to describe hypothetical virus-load time series for an acute virus infection.</p>
<p><span class="math display">\[
\mu_{i,t} = \log\left( t_i^{\alpha_i} e^{-\beta_i t_i} \right)  
\]</span></p>
<p>I mentioned there that this equation does in fact not capture real data too well. For our research project, we used a somewhat more flexible equation, given as</p>
<p><span class="math display">\[
\mu_{i,t} = \log\left( \frac{2 p_i}{e^{-g_i  (k_i - t_i)} + e^{d_i  (t_i - k_i)}}\right).
\]</span></p>
<p>Instead of two parameters, this model has 4. The parameters approximately represent virus peak, <span class="math inline">\(p_i\)</span>, initial growth rate, <span class="math inline">\(g_i\)</span>, decay rate, <span class="math inline">\(d_i\)</span>, and time of peak, <span class="math inline">\(k_i\)</span>. Colleagues <a href="https://bmcpublichealth.biomedcentral.com/articles/10.1186/1471-2458-11-S1-S10">showed previously</a> that this can fit virus load data for acute infections fairly well. The original use was for influenza, we found that it also worked reasonably well for our norovirus data, and thus used it. For the tutorial, I decided to stick to the simpler 2-parameter model. But everything I discussed there applies to this alternative model. For all 4 parameters, we can define individual-level and population level parameters, make them dose-dependent, etc. The main models for the 4 parameters are:</p>
<p><span class="math display">\[
\begin{aligned}
p_{i} &amp; =  p_{0,i} + p_1 x_i  \\
g_{i} &amp; =  g_{0,i} + g_1 x_i \\
d_{i} &amp; =  d_{0,i} + d_1 x_i \\
k_{i} &amp; =  k_{0,i} + k_1 x_i \\
\end{aligned}
\]</span></p>
<p>In this notation, <span class="math inline">\(x_i\)</span> is the dose, transformed and scaled as needed.</p>
<p>The same ideas about model specification, exponentiating to avoid negative values, and all of that still applies. You now need to specify priors for the parameters in each of the four equations above, instead of the 2 equations we had previously. It’s conceptionally the same, just a bit more typing and coding. Since there isn’t anything fundamentally new to show or learn, I’m not implementing the code. I’m confident once you walked through the prior posts in the tutorial, you can copy &amp; paste your way to working code for this bigger model. So if you feel like it, go ahead and implement the above model, both to simulate data and then to fit it.</p>
<p>The model you use to simulate data does not have to be the same you use to fit it. You could for instance try to simulate data with the 2-parameter model and fit with the 4-parameter one, or the reverse. I haven’t tried it, but I expect that using the 2-parameter model to simulate data and the 4-parameter model to fit should work ok (since the 4 parameter model is flexible enough) but the reverse is likely not working too well. In either case, the fits are likely worse than if you use the same model to simulate the data and fit it. That’s not surprising.</p>
<p>It illustrates the point that choosing the right main function (likelihood and deterministic part), is at least as important - probably more so - than setting priors. Most non-Bayesians get hung up about priors, but the dirty (somewhat)-secret is that the overall model specification - which needs to be done for both frequentist and Bayesian fitting - often has a much more pronounced impact, and choosing the model structure is always based on expertise (or convention, though that’s a bad reason), and there are no real rules.</p>
</section>
<section id="fitting-an-alternative-data-set" class="level1">
<h1>Fitting an alternative data set</h1>
<p>For the main tutorial, I used one of the simulated data sets (as generated by model 3) for fitting purposes, since it had the most realistic structure. But we can of course try to fit the other data sets as well. Here, I’m doing a quick exploration using data set 2. That was the one generated by model 2, which did not have any individual-level variability. Recall that model 2 did not run well at all, while model 2a (basically the same model, just better specified) worked ok, though the fit was not great. Let’s see how model 2a does when fitting to a data that has the right overall structure. We’ll compare it to model 4.</p>
<p>Here are the two models we want to fit:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#full-pooling model, population-level parameters only</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>m2a <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span>  a0 <span class="sc">+</span> a1<span class="sc">*</span>dose_adj,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span>  b0 <span class="sc">+</span> b1<span class="sc">*</span>dose_adj,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  a0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">2</span>,  <span class="fl">0.1</span>),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  b0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="fl">0.1</span>),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  a1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  b1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#adaptive priors, partial-pooling model</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span>  a0[id] <span class="sc">+</span> a1<span class="sc">*</span>dose_adj,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span>  b0[id] <span class="sc">+</span> b1<span class="sc">*</span>dose_adj,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  a0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(mu_a,  sigma_a),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  b0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(mu_b, sigma_b),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  mu_a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  mu_b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  sigma_a <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  sigma_b <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  a1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  b1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Setup for fitting these models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################################</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Model fit to alternative data set</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="do">######################################</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#stick all models into a list</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>modellist <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m2a=</span>m2a, <span class="at">m4=</span>m4)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># set up a list in which we'll store our results</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(modellist))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">#now fitting dataset 2 we produced in the first post</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">#also removing anything in the dataframe that's not used for fitting</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">#makes the ulam/Stan code more robust</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>simdat <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"simdat.Rds"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>fitdat <span class="ot">=</span> <span class="fu">list</span>(<span class="at">id=</span>simdat[[<span class="dv">2</span>]]<span class="sc">$</span>id,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">outcome =</span> simdat[[<span class="dv">2</span>]]<span class="sc">$</span>outcome,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose_adj =</span> simdat[[<span class="dv">2</span>]]<span class="sc">$</span>dose_adj,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose_cat =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose_cat,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">time =</span> simdat[[<span class="dv">2</span>]]<span class="sc">$</span>time)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co">#pulling out number of observations</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>Ntot <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(fitdat<span class="sc">$</span>id))</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Setting starting values</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 2</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>startm2a <span class="ot">=</span> <span class="fu">list</span>(<span class="at">a0 =</span> <span class="dv">2</span>, <span class="at">b0 =</span> <span class="fl">0.5</span>, <span class="at">a1 =</span> <span class="fl">0.5</span> , <span class="at">b1 =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 4</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>startm4 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">mu_a =</span> <span class="dv">2</span>, <span class="at">sigma_a =</span> <span class="dv">1</span>, <span class="at">mu_b =</span> <span class="dv">0</span>, <span class="at">sigma_b =</span> <span class="dv">1</span>, <span class="at">a1 =</span> <span class="fl">0.5</span> , <span class="at">b1 =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co">#put different starting values in list</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co">#need to be in same order as models below</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>startlist <span class="ot">=</span> <span class="fu">list</span>(startm2a,startm4)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="co"># defining constraints on parameters</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>constm2a <span class="ot">=</span> <span class="fu">list</span>(<span class="at">sigma=</span><span class="st">"lower=0"</span>)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>constm4 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">sigma=</span><span class="st">"lower=0"</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>constraintlist <span class="ot">=</span> <span class="fu">list</span>(constm2a,constm4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Running the fits:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(modellist))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'************** </span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'starting model'</span>, <span class="fu">names</span>(modellist[n]), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  fl[[n]] <span class="ot">&lt;-</span> <span class="fu">fitfunction</span>(<span class="at">model =</span> modellist[[n]],</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> fitdat,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">start =</span> startlist[[n]],</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">constraints =</span> constraintlist[[n]])</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'model fit took this many minutes:'</span>, fl[[n]]<span class="sc">$</span>runtime, <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'************** </span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"># saving the results so we can use them later</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">=</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="st">"D:"</span>,<span class="st">"Dropbox"</span>,<span class="st">"datafiles"</span>,<span class="st">"longitudinalbayes"</span>,<span class="st">"ulamfits_dat2"</span>, <span class="at">ext=</span><span class="st">"Rds"</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fl,filepath)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see what we get for the fits to this changed data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#loading previously saved fits.</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">=</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="st">"D:"</span>,<span class="st">"Dropbox"</span>,<span class="st">"datafiles"</span>,<span class="st">"longitudinalbayes"</span>,<span class="st">"ulamfits_dat2"</span>, <span class="at">ext=</span><span class="st">"Rds"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(filepath)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>fitdat <span class="ot">&lt;-</span> fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit<span class="sc">@</span>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Model 2a</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">1</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       mean     sd   5.5%  94.5% n_eff Rhat4
a0     3.00 0.0030  2.994  3.003  5591     1
b0     1.00 0.0027  0.995  1.004  5885     1
a1     0.10 0.0014  0.098  0.102  6691     1
b1    -0.10 0.0013 -0.102 -0.098  7868     1
sigma  0.99 0.0440  0.925  1.066  7717     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Model 4</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>a0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"a0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>b0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"b0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">1</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>48 vector or matrix parameters hidden. Use depth=2 to show them.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>           mean     sd     5.5%   94.5% n_eff Rhat4
mu_a     3.0000 0.0031  2.99494  3.0048   545     1
mu_b     1.0005 0.0028  0.99586  1.0050   581     1
sigma_a  0.0018 0.0013  0.00018  0.0041   218     1
sigma_b  0.0023 0.0015  0.00030  0.0049   338     1
a1       0.0998 0.0014  0.09758  0.1021  2209     1
b1      -0.1001 0.0013 -0.10217 -0.0980  4232     1
sigma    0.9854 0.0448  0.91690  1.0585  4520     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(a0mean,b0mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.999965 1.000551</code></pre>
</div>
</div>
<p>The estimates for the parameters are fairly similar. Model 2a actually seems to work a bit better here, since the model structure and the data structure are a close match.</p>
<p>Comparison of the models using WAIC confirms that model 2a now does well:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>comp <span class="ot">&lt;-</span> <span class="fu">compare</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(comp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                WAIC       SE    dWAIC      dSE     pWAIC    weight
fl[[1]]$fit 749.8964 22.94737 0.000000       NA  5.001198 0.8273078
fl[[2]]$fit 753.0297 23.14726 3.133333 2.350631 11.154308 0.1726922</code></pre>
</div>
</div>
<p>Let’s look at plots to further see if/how the models differ. First we need to make predictions, then we can plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fitpred <span class="ot">&lt;-</span> <span class="fu">predfunction</span>(fl,fitdat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>plotlist <span class="ot">&lt;-</span> <span class="fu">plotfunction</span>(fl,fitpred,fitdat)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/plot_dat2-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">2</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/plot_dat2-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>For this data set, with little individual-level variation, the simpler model and the more complex one perform more or less equally well. Depending on the amount of noise (<span class="math inline">\(\sigma\)</span> in the model), at some point we can expect the simple model to not capture things too well anymore.</p>
<p>Generally speaking, model choice should be driven by the underlying scientific assumptions. If one expects no or almost no variation between the individual units (e.g., people in our case, but it could be anything else), then a simple model that ignores individual-level variation might be ok. In most cases, a model that allows for such variation is likely more appropriate. Especially since the adaptive pooling model allows the model to learn the amount of variation that best describes the data, thus it seems - apart from a bit more complex model setup and a longer run time - there is essentially no downside to the more flexible type of model. The minor downside is potentially larger uncertainty for those cases where a simpler model is suitable. The downside is more bias/risk of underfitting for the simpler model. It’s always possible to try it both ways.</p>
</section>
<section id="fitting-a-larger-data-set" class="level1">
<h1>Fitting a larger data set</h1>
<p>The number of individuals in our simulated data in the main tutorial is low. That was motivated by the real data we had. But since the data are simulated, we can explore how things might or might not change if we increase the data. I was especially interested to see how the estimates for <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> might change with larger samples.</p>
<p>To get larger samples, I ran the simulation script shown in <a href="../../posts/longitudinal-multilevel-bayesian-analysis-1/">part 1</a> with a 10 times larger sample size for each group. Everything else stayed the same. Here is the code that fits model 4 to the larger data set.</p>
<p>Setting up things.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################################</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Model fit to bigger data set</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="do">######################################</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">#stick all models into a list</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>modellist <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m4=</span>m4)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># set up a list in which we'll store our results</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(modellist))</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">#fitting dataset with larger sample size</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>simdat <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"simdat_big.Rds"</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>fitdat<span class="ot">=</span><span class="fu">list</span>(<span class="at">id=</span>simdat[[<span class="dv">3</span>]]<span class="sc">$</span>id,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">outcome =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>outcome,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose_adj =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose_adj,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose_cat =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose_cat,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">time =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>time</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 4</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>startm4 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">mu_a =</span> <span class="dv">2</span>, <span class="at">sigma_a =</span> <span class="dv">1</span>, <span class="at">mu_b =</span> <span class="dv">0</span>, <span class="at">sigma_b =</span> <span class="dv">1</span>, <span class="at">a1 =</span> <span class="fl">0.5</span> , <span class="at">b1 =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>startlist <span class="ot">=</span> <span class="fu">list</span>(startm4)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="co"># defining constraints on parameters</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>constm4 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">sigma=</span><span class="st">"lower=0"</span>,<span class="at">sigma_a=</span><span class="st">"lower=0"</span>,<span class="at">sigma_b=</span><span class="st">"lower=0"</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>constraintlist <span class="ot">=</span> <span class="fu">list</span>(constm4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Running the fits.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fitting model</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">'************** </span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">'starting model'</span>, <span class="fu">names</span>(modellist[<span class="dv">1</span>]), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>fl[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">fitfunction</span>(<span class="at">model =</span> modellist[[<span class="dv">1</span>]],</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> fitdat,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">start =</span> startlist[[<span class="dv">1</span>]],</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">constraints =</span> constraintlist[[<span class="dv">1</span>]])</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">'model fit took this many minutes:'</span>, fl[[<span class="dv">1</span>]]<span class="sc">$</span>runtime, <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">'************** </span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co"># saving the results so we can use them later</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">=</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="st">"D:"</span>,<span class="st">"Dropbox"</span>,<span class="st">"datafiles"</span>,<span class="st">"longitudinalbayes"</span>,<span class="st">"ulamfits_big"</span>, <span class="at">ext=</span><span class="st">"Rds"</span>)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fl,filepath)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#loading previously saved fits.</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">=</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="st">"D:"</span>,<span class="st">"Dropbox"</span>,<span class="st">"datafiles"</span>,<span class="st">"longitudinalbayes"</span>,<span class="st">"ulamfits_big"</span>, <span class="at">ext=</span><span class="st">"Rds"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(filepath)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>fitdat <span class="ot">&lt;-</span> fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit<span class="sc">@</span>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Exploring model fits</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>a0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"a0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>b0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"b0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">1</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>480 vector or matrix parameters hidden. Use depth=2 to show them.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>          mean     sd   5.5%  94.5% n_eff Rhat4
mu_a     3.004 0.0066  2.993  3.014 22580     1
mu_b     0.999 0.0063  0.989  1.009 24493     1
sigma_a  0.103 0.0048  0.095  0.111 29459     1
sigma_b  0.097 0.0045  0.090  0.104 27303     1
a1       0.099 0.0036  0.093  0.105   643     1
b1      -0.099 0.0035 -0.105 -0.094   628     1
sigma    1.015 0.0156  0.991  1.041 18468     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(a0mean,b0mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.0039243 0.9992366</code></pre>
</div>
</div>
<p>Note the message about the hidden parameters, it’s 10 times as many as previously, since we have <span class="math inline">\(N\)</span> increased by a factor of 10. If we compare these estimates to those for model 4 in <a href="../../posts/longitudinal-multilevel-bayesian-analysis-2/">part 2</a>, we notice that the credible intervals shrank, i.e.&nbsp;the precision increased. This is expected for larger sample size. So, reassuringly, larger sample size behaves as expected, helping the model to make more precise estimates. This should also lead to narrower uncertainty intervals for the predictions. Let’s check:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>fitpred <span class="ot">&lt;-</span> <span class="fu">predfunction</span>(fl,fitdat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>plotlist <span class="ot">&lt;-</span> <span class="fu">plotfunction</span>(fl,fitpred,fitdat)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co">#update plot</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> plotlist[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>,<span class="dv">70</span>))</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/plot_big-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save plot so we can use it in the blog post</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">"featured.png"</span>), p1, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">width =</span> <span class="dv">6</span>, <span class="at">height =</span> <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looks messy, but overall ok.</p>
</section>
<section id="alternative-to-enforcing-positivity-of-parameters" class="level1">
<h1>Alternative to enforcing positivity of parameters</h1>
<p>In the main tutorial, we enforced positivity for the main parameters <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> through exponentiation. There are other options. An alternative is to ensure they are positive based on the assigned distributions.</p>
<p>As a reminder, our main model describing the mean trajectory of the data is given by</p>
<p><span class="math display">\[
\mu_{i,t}  = \log\left( T_i^{\alpha_{i}} e^{-\beta_{i} * T_i} \right)
\]</span> Only positive values for <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span> produce meaningful trajectories. Thus we need to ensure they are positive. In the main tutorial, I did that by exponentiating them, and then rewriting the equation to minimize potential numerical problems.</p>
<p>Another approach is to keep the parameters the way they are, and specify the rest of the model in such a way that they can only be positive. The equations determining <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span> are for our case the following:</p>
<p><span class="math display">\[
\begin{aligned}
\alpha_{i} &amp;  =  a_{0,i} + a_1 \left(\log (D_i) - \log (D_m)\right)  \\
\beta_{i} &amp;  =  b_{0,i} + b_1 \left(\log (D_i) - \log (D_m)\right)
\end{aligned}
\]</span> I’m going to make a small change by dropping the subtraction of the middle dose. As discussed, we did that for ease of interpretation but otherwise it wasn’t quite needed. So I’m considering a model of this form</p>
<p><span class="math display">\[
\begin{aligned}
\alpha_{i} &amp;  =  a_{0,i} + a_1 \log (D_i)   \\
\beta_{i} &amp;  =  b_{0,i} + b_1 \log (D_i)
\end{aligned}
\]</span> We can choose priors for <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,i}\)</span> that ensure only positive values. However, the priors for <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> should be allowed to be either positive or negative, since we don’t know what impact the dose has. We also don’t know how strong the dose effect is. That means, with the model above, it is tricky to ensure <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span> are positive.</p>
<p>As mentioned in the main tutorial, we could just leave things as they are and hope that the data will push the fitting routine to reasonable values. That might or might not work, so let’s try to help things along. To do so, we’ll rewrite the equations a bit as follows:</p>
<p><span class="math display">\[
\begin{aligned}
\alpha_{i} &amp;  =  a_{0,i} \left( 1  + (a_2-1)  \frac{\log (D_i)}{\max(\log(D_i))} \right)  \\
\beta_{i} &amp; =  b_{0,i} \left( 1 + (b_2-1)  \frac{\log (D_i) }{\max(\log(D_i))} \right)
\end{aligned}
\]</span></p>
<p>This maybe strange rewriting does two things. First, we rescaled the dose variable, such that all values are between 0 and 1. Additionally, we replaced the parameters <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> with <span class="math inline">\(a_1 = (a_2-1) a_{0,i}\)</span> and <span class="math inline">\(b_1 = (b_2-1) a_{0,i}\)</span> and reorganized the equation.</p>
<p>This rewriting doesn’t change the model, but it helps us to now more easily define priors that enforce the equations to be positive. If we give all parameters priors that are positive, it will ensure that the part related to the dose only goes as low as -1 (if <span class="math inline">\(a_2\)</span> or <span class="math inline">\(b_2\)</span> are zero), which means the full equations can only go down to 0 and not lower. These priors should work:</p>
<p><span class="math display">\[
\begin{aligned}
a_{0,i}  \sim \mathrm{LogNormal}(\mu_a, \sigma_a) \\
b_{0,i}  \sim \mathrm{LogNormal}(\mu_b, \sigma_b) \\
a_{2}  \sim \mathrm{LogNormal}(0, 1) \\
b_{2}  \sim \mathrm{LogNormal}(0, 1) \\
\end{aligned}
\]</span></p>
<p>This implements again the adaptive pooling strategy, like we did previously for model 4.</p>
<p>With these choices, we now ensure that <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span> can not become negative. Let’s run the model using <code>rethinking</code> to see how it works. I’m comparing it to the previous model 4. Note the different forms of dose that are used in the models, corresponding to the equations just discussed. (I know I used 4a and 5 as model labels previously. The ones I’m calling 4a and 5 here are different/new 😁.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#adaptive priors, partial-pooling model</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co">#no middle dose subtraction</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>m4a <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span>  a0[id] <span class="sc">+</span> a1 <span class="sc">*</span> dose,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span>  b0[id] <span class="sc">+</span> b1 <span class="sc">*</span> dose,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  a0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(mu_a,  sigma_a),</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  b0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(mu_b, sigma_b),</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  mu_a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  mu_b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  sigma_a <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  sigma_b <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  a1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  b1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># different way of enforcing positive parameters</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>m5 <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span>  a0[id]<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> (a2<span class="dv">-1</span>) <span class="sc">*</span> dose_adj2),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span>  b0[id]<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> (b2<span class="dv">-1</span>) <span class="sc">*</span>dose_adj2),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  a0[id] <span class="sc">~</span> <span class="fu">dlnorm</span>(mu_a,  sigma_a),</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  b0[id] <span class="sc">~</span> <span class="fu">dlnorm</span>(mu_b, sigma_b),</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  mu_a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">1</span>, <span class="fl">0.5</span>),</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  mu_b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="fl">0.5</span>),</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  sigma_a <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  sigma_b <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  a2 <span class="sc">~</span> <span class="fu">dlnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  b2 <span class="sc">~</span> <span class="fu">dlnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the setup up for fitting this model. Note the new variable <code>dose_adj2</code> which is defined as shown in the equations above:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#stick all models into a list</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>modellist <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m4a=</span>m4a, <span class="at">m5=</span>m5)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set up a list in which we'll store our results</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(modellist))</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co">#fitting dataset 3 we produced in the earlier post</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co">#also removing anything in the dataframe that's not used for fitting</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co">#makes the ulam/Stan code more robust</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">#note that we need both dose_adj and an alternative that divides by max dose</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co">#for model 5</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>simdat <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"simdat.Rds"</span>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>fitdat<span class="ot">=</span><span class="fu">list</span>(<span class="at">id=</span>simdat[[<span class="dv">3</span>]]<span class="sc">$</span>id,</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">outcome =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>outcome,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose_adj2 =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose<span class="sc">/</span><span class="fu">max</span>(simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose),</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose_cat =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose_cat,</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">time =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>time</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="co">#pulling out number of observations</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>Ntot <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(fitdat<span class="sc">$</span>id))</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 4a</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>startm4a <span class="ot">=</span> <span class="fu">list</span>(<span class="at">mu_a =</span> <span class="dv">2</span>, <span class="at">sigma_a =</span> <span class="dv">1</span>, <span class="at">mu_b =</span> <span class="dv">0</span>, <span class="at">sigma_b =</span> <span class="dv">1</span>, <span class="at">a1 =</span> <span class="fl">0.5</span> , <span class="at">b1 =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 5</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>startm5 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">mu_a =</span> <span class="dv">2</span>, <span class="at">sigma_a =</span> <span class="dv">1</span>, <span class="at">mu_b =</span> <span class="dv">0</span>, <span class="at">sigma_b =</span> <span class="dv">1</span>, <span class="at">a1 =</span> <span class="fl">0.2</span> , <span class="at">b1 =</span> <span class="sc">-</span><span class="fl">0.2</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a><span class="co">#put different starting values in list</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="co">#need to be in same order as models below</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>startlist <span class="ot">=</span> <span class="fu">list</span>(startm4a, startm5)</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a><span class="co"># defining constraints on parameters</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>constm4a <span class="ot">=</span> <span class="fu">list</span>(<span class="at">sigma=</span><span class="st">"lower=0"</span>,<span class="at">sigma_a=</span><span class="st">"lower=0"</span>,<span class="at">sigma_b=</span><span class="st">"lower=0"</span>)</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>constm5 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">sigma=</span><span class="st">"lower=0"</span>,<span class="at">sigma_a=</span><span class="st">"lower=0"</span>,<span class="at">sigma_b=</span><span class="st">"lower=0"</span>)</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>constraintlist <span class="ot">=</span> <span class="fu">list</span>(constm4a, constm5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Running the fits:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fitting models</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(modellist))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'************** </span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'starting model'</span>, <span class="fu">names</span>(modellist[n]), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  fl[[n]] <span class="ot">&lt;-</span> <span class="fu">fitfunction</span>(<span class="at">model =</span> modellist[[n]],</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> fitdat,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">start =</span> startlist[[n]],</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">constraints =</span> constraintlist[[n]])</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'model fit took this many minutes:'</span>, fl[[n]]<span class="sc">$</span>runtime, <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'************** </span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co"># saving the results so we can use them later</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">=</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="st">"D:"</span>,<span class="st">"Dropbox"</span>,<span class="st">"datafiles"</span>,<span class="st">"longitudinalbayes"</span>,<span class="st">"ulamfits_altpos"</span>, <span class="at">ext=</span><span class="st">"Rds"</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fl,filepath)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see what we get with this changed model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#loading previously saved fits.</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">=</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="st">"D:"</span>,<span class="st">"Dropbox"</span>,<span class="st">"datafiles"</span>,<span class="st">"longitudinalbayes"</span>,<span class="st">"ulamfits_altpos"</span>, <span class="at">ext=</span><span class="st">"Rds"</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(filepath)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>fitdat <span class="ot">&lt;-</span> fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit<span class="sc">@</span>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For model 4, the estimates for the dose parameters <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> are similar to our previous ones. That’s good, since we are still estimating the impact of changes in (log) dose, as before. The fact that we don’t subtract the middle dose anymore should not impact the estimates of the <em>changes</em> in outcome as dose changes. In contrast, the intercept parameters, <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,i}\)</span> are now different from previous model fits and the original data generating model. That is also expected, since we generated the data with the model that subtracted the medium dose, but now fit it without that part.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Model 4a</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>a0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"a0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>b0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"b0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">1</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>48 vector or matrix parameters hidden. Use depth=2 to show them.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>          mean    sd   5.5%  94.5% n_eff Rhat4
mu_a     2.588 0.055  2.500  2.674  1515     1
mu_b     1.469 0.068  1.360  1.578  1551     1
sigma_a  0.093 0.016  0.071  0.120  6218     1
sigma_b  0.119 0.020  0.092  0.153  7161     1
a1       0.087 0.011  0.070  0.103  1352     1
b1      -0.105 0.013 -0.126 -0.084  1382     1
sigma    1.063 0.051  0.984  1.147  7381     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(a0mean,b0mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.588210 1.469683</code></pre>
</div>
</div>
<p>These are the parameter estimates for model 5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Model 5</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">1</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>48 vector or matrix parameters hidden. Use depth=2 to show them.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         mean     sd  5.5% 94.5% n_eff Rhat4
mu_a    0.952 0.0202 0.920 0.984  1670     1
mu_b    0.377 0.0598 0.281 0.470  2024     1
sigma_a 0.031 0.0053 0.024 0.041  6349     1
sigma_b 0.140 0.0233 0.108 0.180  6206     1
a2      1.229 0.0325 1.179 1.280  1510     1
b2      0.507 0.0449 0.442 0.583  1666     1
sigma   1.063 0.0524 0.983 1.150  6566     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>a0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"a0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>b0mean <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">precis</span>(fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>,<span class="st">"b0"</span>)<span class="sc">$</span>mean)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(a0mean,b0mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.593450 1.474345</code></pre>
</div>
</div>
<p>To compare those with model 4a, I’m doing the math to convert the <span class="math inline">\(a_2\)</span> and <span class="math inline">\(b_2\)</span> parameters to <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># computing values that correspond to a1 and b1</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>a1est <span class="ot">=</span> (<span class="fu">precis</span>(fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,<span class="at">pars=</span><span class="st">"a2"</span>)[<span class="dv">1</span>,]<span class="sc">-</span><span class="dv">1</span>)<span class="sc">*</span>a0mean<span class="sc">/</span><span class="fu">max</span>(fitdat<span class="sc">$</span>dose)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>b1est <span class="ot">=</span> (<span class="fu">precis</span>(fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,<span class="at">pars=</span><span class="st">"b2"</span>)[<span class="dv">1</span>,]<span class="sc">-</span><span class="dv">1</span>)<span class="sc">*</span>b0mean<span class="sc">/</span><span class="fu">max</span>(fitdat<span class="sc">$</span>dose)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(a1est,b1est))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  0.0857905 -0.1052279</code></pre>
</div>
</div>
<p>These estimates for model 5 are similar to those for model 4a.</p>
<p>We can also compare the two models based on WAIC and run time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                WAIC       SE     dWAIC       dSE    pWAIC    weight
fl[[1]]$fit 831.7940 23.34184 0.0000000        NA 42.75312 0.6177683
fl[[2]]$fit 832.7542 23.47192 0.9601733 0.7762243 43.13370 0.3822317</code></pre>
</div>
</div>
<p>The fit quality is more or less the same. Note that model 4a ran faster than model 5, 14 versus 133 minutes.</p>
<p>Finally, let’s do the plots to check that they look more or less the same.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>fitpred <span class="ot">&lt;-</span> <span class="fu">predfunction</span>(fl,fitdat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s make and look at the plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>plotlist <span class="ot">&lt;-</span> <span class="fu">plotfunction</span>(fl,fitpred,fitdat)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/plot_altpos-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">2</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/plot_altpos-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The plots for the 2 models are pretty much the same. That’s good, since those are essentially the same models, just written in different forms. In this case, the original way of writing seems better since it runs faster.</p>
</section>
<section id="treating-dose-as-an-unordered-categorical-variable" class="level1">
<h1>Treating dose as an <strong>unordered</strong> categorical variable</h1>
<p>In the main tutorial, we treated the predictor of interest as continuous. If you have a continuous predictor of interest, that’s generally the best approach. Dose is a bit of a borderline case. We know the exact dose that was given, but it’s not clear that one should assume a linear relation between dose and the model parameters. To explore the possible impact of this assumption, one could try all kinds of functional relationships. But without any good scientific knowledge of how that relation should look, it’s a bit futile. Another option is to try and fit the model with dose treated categorically. At other times, you have a predictor that is categorical from the start, for instance one group receiving treatment and the other not is clearly categorical.</p>
<p>Here is a version of the model we looked at, now with dose treated categorical. I’m only showing this for the adaptive partial pooling model (model 4), but it could also be implemented for the other models.</p>
<p>The equations change as follows</p>
<p><span class="math display">\[
\begin{align}
\textrm{Outcome} \\
Y_{i,t}   \sim \mathrm{Normal}\left(\mu_{i,t}, \sigma\right) \\
\\
\textrm{Deterministic time-series trajectory} \\
\mu_{i,t}   =  \exp(\alpha_{i}) \log (t_{i}) -\exp(\beta_{i}) t_{i} \\
\\
\textrm{Deterministic models for main parameters} \\
\alpha_{i}   =  a_{0,i} + a_1[dose_i]   \\
\beta_{i}   =  b_{0,i} + b_1[dose_i]  \\
\\
\textrm{Priors} \\
a_{0,i} \sim \mathrm{Normal}(\mu_a, \sigma_a) \\
b_{0,i}  \sim \mathrm{Normal}(\mu_b, \sigma_a) \\
a_1[dose_i] \sim \mathrm{Normal}(0.3, 1) \\
b_1[dose_i] \sim \mathrm{Normal}(-0.3, 1) \\
\mu_a \sim \mathrm{Normal}(2, 1) \\
\mu_b \sim \mathrm{Normal}(0.5, 1) \\
\sigma_a  \sim \mathrm{HalfCauchy}(0,1)  \\
\sigma_b  \sim \mathrm{HalfCauchy}(0,1)  \\
\sigma  \sim \mathrm{HalfCauchy}(0, 1)  \\
\end{align}
\]</span></p>
<p>The difference is that now the parameters <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> depend on the dose category (low/medium/high) of individual <span class="math inline">\(i\)</span>, instead of the actual dose value for that individual. The rest of the model didn’t change. Let’s run this new model, which I call model 6.</p>
<p>Model 6 with dose treated (unordered) categorical. I call the indices for the categorical dose <code>dose_cat2</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">#model with dose treated as categorical</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>m6 <span class="ot">&lt;-</span> <span class="fu">alist</span>(</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span>  a0[id] <span class="sc">+</span> a1[dose_cat2],</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span>  b0[id] <span class="sc">+</span> b1[dose_cat2],</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  a0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(mu_a,  sigma_a),</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  b0[id] <span class="sc">~</span> <span class="fu">dnorm</span>(mu_b, sigma_b),</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  mu_a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  mu_b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  sigma_a <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  sigma_b <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>  a1[dose_cat] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>  b1[dose_cat] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Set up for fitting, running both this new model and the previous model 4 for comparison:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">#stick all models into a list</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>modellist <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m4=</span>m4, <span class="at">m6=</span>m6)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set up a list in which we'll store our results</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co">#note that we use dose_cat for plotting</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co">#ulam wants categories coded as integers, so we make dose_cat2</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>simdat <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"simdat.Rds"</span>)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>fitdat<span class="ot">=</span><span class="fu">list</span>(<span class="at">id=</span>simdat[[<span class="dv">3</span>]]<span class="sc">$</span>id,</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">outcome =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>outcome,</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose,</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose_adj =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose_adj,</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose_cat =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose_cat,</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose_cat2 =</span> <span class="fu">as.numeric</span>(simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose_cat),</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">time =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>time)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a><span class="co">#pulling out number of observations</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>Ntot <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(fitdat<span class="sc">$</span>id))</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>startm4 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">mu_a =</span> <span class="dv">2</span>, <span class="at">sigma_a =</span> <span class="dv">1</span>, <span class="at">mu_b =</span> <span class="dv">0</span>, <span class="at">sigma_b =</span> <span class="dv">1</span>, <span class="at">a1 =</span> <span class="fl">0.5</span> , <span class="at">b1 =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>startm6 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">mu_a =</span> <span class="dv">2</span>, <span class="at">sigma_a =</span> <span class="dv">1</span>, <span class="at">mu_b =</span> <span class="dv">0</span>, <span class="at">sigma_b =</span> <span class="dv">1</span>, <span class="at">a1 =</span> <span class="fu">rep</span>(<span class="fl">0.3</span>,<span class="dv">3</span>) , <span class="at">b1 =</span> <span class="fu">rep</span>(<span class="sc">-</span><span class="fl">0.3</span>,<span class="dv">3</span>), <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>startlist <span class="ot">=</span> <span class="fu">list</span>(startm4, startm6)</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a><span class="co"># defining constraints on parameters</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>constm4 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">sigma=</span><span class="st">"lower=0"</span>,<span class="at">sigma_a=</span><span class="st">"lower=0"</span>,<span class="at">sigma_b=</span><span class="st">"lower=0"</span>)</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>constm6 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">sigma=</span><span class="st">"lower=0"</span>,<span class="at">sigma_a=</span><span class="st">"lower=0"</span>,<span class="at">sigma_b=</span><span class="st">"lower=0"</span>)</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>constraintlist <span class="ot">=</span> <span class="fu">list</span>(constm4, constm6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Running the fitting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fitting model</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(modellist))</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'************** </span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'starting model'</span>, <span class="fu">names</span>(modellist[n]), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  fl[[n]] <span class="ot">&lt;-</span> <span class="fu">fitfunction</span>(<span class="at">model =</span> modellist[[n]],</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> fitdat,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">start =</span> startlist[[n]],</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">constraints =</span> constraintlist[[n]])</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'model fit took this many minutes:'</span>, fl[[n]]<span class="sc">$</span>runtime, <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'************** </span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="co"># saving the results so we can use them later</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">=</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="st">"D:"</span>,<span class="st">"Dropbox"</span>,<span class="st">"datafiles"</span>,<span class="st">"longitudinalbayes"</span>,<span class="st">"ulamfits_cat"</span>, <span class="at">ext=</span><span class="st">"Rds"</span>)</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fl,filepath)</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">'all done'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see what we get with this changed model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#loading previously saved fits.</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">=</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="st">"D:"</span>,<span class="st">"Dropbox"</span>,<span class="st">"datafiles"</span>,<span class="st">"longitudinalbayes"</span>,<span class="st">"ulamfits_cat"</span>, <span class="at">ext=</span><span class="st">"Rds"</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(filepath)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>fitdat <span class="ot">&lt;-</span> fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit<span class="sc">@</span>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the coefficients. I’m showing all here, so we can see the dose-related ones (which are level 2 for the categorical one). The first set of coefficients are the previous ones, from model 4, treating dose as continuous. The second set of coefficients is from the categorical dose model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Model 4</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          mean    sd   5.5%  94.5% n_eff Rhat4
a0[1]    3.176 0.028  3.132  3.221  3337     1
a0[2]    3.138 0.028  3.094  3.184  3494     1
a0[3]    2.943 0.030  2.895  2.990  3779     1
a0[4]    2.877 0.030  2.829  2.925  3892     1
a0[5]    2.920 0.030  2.872  2.967  3665     1
a0[6]    3.011 0.029  2.965  3.057  3505     1
a0[7]    2.961 0.030  2.914  3.008  4024     1
a0[8]    2.984 0.015  2.959  3.008 12342     1
a0[9]    2.911 0.016  2.885  2.936 12920     1
a0[10]   2.984 0.015  2.960  3.008 12193     1
a0[11]   2.939 0.016  2.914  2.964 11111     1
a0[12]   2.845 0.017  2.818  2.873 12133     1
a0[13]   2.972 0.015  2.948  2.995 12117     1
a0[14]   3.089 0.014  3.067  3.110 11179     1
a0[15]   2.950 0.015  2.925  2.974 12608     1
a0[16]   3.084 0.026  3.042  3.125  2949     1
a0[17]   2.866 0.027  2.822  2.909  3032     1
a0[18]   3.041 0.026  2.998  3.082  2970     1
a0[19]   3.073 0.026  3.032  3.116  2864     1
a0[20]   3.047 0.026  3.005  3.089  3051     1
a0[21]   3.023 0.027  2.980  3.065  3033     1
a0[22]   2.976 0.027  2.933  3.019  2918     1
a0[23]   2.967 0.027  2.924  3.009  2862     1
a0[24]   2.916 0.027  2.872  2.958  3039     1
b0[1]    0.992 0.032  0.942  1.044  2805     1
b0[2]    0.896 0.032  0.845  0.947  2911     1
b0[3]    0.941 0.032  0.889  0.991  2887     1
b0[4]    0.960 0.032  0.910  1.010  2861     1
b0[5]    1.178 0.031  1.128  1.227  2750     1
b0[6]    0.928 0.032  0.877  0.979  2896     1
b0[7]    1.018 0.032  0.967  1.068  2848     1
b0[8]    1.015 0.014  0.993  1.036 12171     1
b0[9]    0.910 0.015  0.885  0.934 12885     1
b0[10]   0.984 0.014  0.962  1.006 11880     1
b0[11]   1.151 0.012  1.132  1.169 10972     1
b0[12]   1.049 0.013  1.028  1.069 11970     1
b0[13]   1.010 0.013  0.988  1.031 11914     1
b0[14]   0.951 0.014  0.928  0.974 10992     1
b0[15]   0.794 0.017  0.767  0.820 12556     1
b0[16]   1.111 0.034  1.058  1.166  3145     1
b0[17]   0.848 0.036  0.790  0.903  3444     1
b0[18]   1.108 0.034  1.055  1.161  3202     1
b0[19]   1.192 0.033  1.139  1.245  3040     1
b0[20]   0.850 0.036  0.793  0.905  3431     1
b0[21]   1.059 0.034  1.005  1.113  3220     1
b0[22]   0.998 0.034  0.943  1.053  3295     1
b0[23]   0.881 0.035  0.824  0.937  3383     1
b0[24]   0.856 0.035  0.799  0.912  3493     1
mu_a     2.987 0.020  2.955  3.018 15770     1
mu_b     0.987 0.025  0.946  1.027 15800     1
sigma_a  0.093 0.016  0.071  0.121 12658     1
sigma_b  0.119 0.020  0.092  0.153 12519     1
a1       0.086 0.010  0.070  0.103  2500     1
b1      -0.106 0.013 -0.127 -0.086  2583     1
sigma    1.062 0.051  0.981  1.147 12837     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Model 6</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">precis</span>(fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit,<span class="at">depth=</span><span class="dv">2</span>),<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          mean    sd   5.5% 94.5% n_eff Rhat4
a0[1]    2.671 0.487  1.899  3.45   870     1
a0[2]    2.634 0.487  1.865  3.41   872     1
a0[3]    2.439 0.487  1.666  3.21   871     1
a0[4]    2.373 0.487  1.600  3.15   871     1
a0[5]    2.416 0.487  1.647  3.19   871     1
a0[6]    2.506 0.487  1.735  3.28   870     1
a0[7]    2.457 0.487  1.689  3.23   870     1
a0[8]    2.524 0.487  1.752  3.30   867     1
a0[9]    2.451 0.487  1.680  3.23   867     1
a0[10]   2.525 0.487  1.758  3.30   867     1
a0[11]   2.479 0.487  1.711  3.25   865     1
a0[12]   2.385 0.487  1.615  3.16   868     1
a0[13]   2.512 0.487  1.742  3.29   866     1
a0[14]   2.629 0.487  1.860  3.41   867     1
a0[15]   2.491 0.487  1.721  3.27   867     1
a0[16]   2.584 0.487  1.811  3.36   865     1
a0[17]   2.366 0.487  1.593  3.14   865     1
a0[18]   2.541 0.487  1.765  3.32   865     1
a0[19]   2.574 0.487  1.799  3.35   866     1
a0[20]   2.548 0.486  1.772  3.32   865     1
a0[21]   2.523 0.487  1.749  3.30   865     1
a0[22]   2.476 0.487  1.702  3.26   866     1
a0[23]   2.467 0.487  1.692  3.24   865     1
a0[24]   2.416 0.487  1.640  3.19   865     1
b0[1]    1.114 0.508  0.298  1.97   810     1
b0[2]    1.018 0.508  0.201  1.87   810     1
b0[3]    1.063 0.508  0.245  1.91   810     1
b0[4]    1.082 0.508  0.265  1.93   809     1
b0[5]    1.300 0.508  0.481  2.15   809     1
b0[6]    1.050 0.508  0.234  1.90   809     1
b0[7]    1.140 0.508  0.322  1.99   810     1
b0[8]    1.141 0.509  0.315  1.99   818     1
b0[9]    1.036 0.509  0.207  1.89   817     1
b0[10]   1.111 0.509  0.286  1.96   818     1
b0[11]   1.278 0.509  0.449  2.13   816     1
b0[12]   1.175 0.509  0.350  2.02   817     1
b0[13]   1.137 0.509  0.311  1.99   818     1
b0[14]   1.078 0.509  0.252  1.93   818     1
b0[15]   0.920 0.509  0.091  1.77   819     1
b0[16]   1.231 0.508  0.409  2.08   815     1
b0[17]   0.967 0.508  0.142  1.82   817     1
b0[18]   1.228 0.508  0.406  2.08   817     1
b0[19]   1.311 0.508  0.488  2.16   817     1
b0[20]   0.970 0.508  0.147  1.82   816     1
b0[21]   1.179 0.508  0.356  2.03   817     1
b0[22]   1.117 0.508  0.293  1.97   818     1
b0[23]   1.000 0.508  0.175  1.85   817     1
b0[24]   0.976 0.509  0.149  1.82   818     1
mu_a     2.499 0.486  1.730  3.28   866     1
mu_b     1.109 0.507  0.288  1.96   811     1
sigma_a  0.092 0.016  0.070  0.12  3179     1
sigma_b  0.122 0.021  0.094  0.16  2986     1
a1[1]    0.306 0.486 -0.468  1.08   869     1
a1[2]    0.459 0.486 -0.320  1.23   866     1
a1[3]    0.698 0.487 -0.079  1.47   865     1
b1[1]    0.123 0.508 -0.726  0.94   809     1
b1[2]   -0.127 0.509 -0.978  0.70   817     1
b1[3]   -0.364 0.508 -1.214  0.46   816     1
sigma    1.063 0.051  0.986  1.15  3024     1</code></pre>
</div>
</div>
<p>The <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> coefficients are the interesting ones. We now have a different estimate for each dose. The values for <span class="math inline">\(a_1\)</span> increase with dose and the values for <span class="math inline">\(b_1\)</span> decrease with dose. This is consistent with the linear/continuous model and the way we generated the data.</p>
<p>We can compare this model to the continuous one in terms of WAIC</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare</span>(fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit,fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                WAIC       SE     dWAIC       dSE    pWAIC    weight
fl[[1]]$fit 831.1873 23.32505 0.0000000        NA 42.55486 0.5897949
fl[[2]]$fit 831.9135 23.34799 0.7262354 0.4992692 42.89880 0.4102051</code></pre>
</div>
</div>
<p>The models are comparable with that metric.</p>
<p>Let’s compute predictions so we can plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>fitpred <span class="ot">&lt;-</span> <span class="fu">predfunction</span>(fl,fitdat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s make and look at the plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>plotlist <span class="ot">&lt;-</span> <span class="fu">plotfunction</span>(fl,fitpred,fitdat)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/plot_cat-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">2</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/plot_cat-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The plot looks reasonable, so treating dose here as categorical seems to lead to similar results as treating it continuous. It’s a scientific question/decision on how to do it. In general, if there are reasons for either approach, my suggestion is to do it both ways and report the additional results as sensitivity analyses.</p>
<section id="a-model-that-doesnt-work" class="level2">
<h2 class="anchored" data-anchor-id="a-model-that-doesnt-work">A model that “doesn’t work”</h2>
<p>When we originally scribbled down models that we might use to fit our data, we came up with this model.</p>
<p><span class="math display">\[
\begin{align}
\textrm{Outcome} \\
Y_{i,t}  \sim \mathrm{Normal}\left(\mu_{i,t}, \sigma\right) \\
\\
\textrm{Deterministic time-series trajectory} \\
\mu_{i,t} =  \exp(\alpha_{i}) \log (t_{i}) -\exp(\beta_{i}) t_{i} \\
\\
\textrm{Distribution for main parameters} \\
\alpha_{i}  \sim \mathrm{Normal}\left(am_{i}, \sigma_a \right)  \\
\beta_{i}  \sim \mathrm{Normal}\left(bm_{i}, \sigma_b \right) \\
\\
\textrm{Deterministic models for main parameters} \\
am_{i}   =  a_{0,i} + a_1 \left(\log (D_i) - \log (D_m)\right)  \\
bm_{i}  =  b_{0,i} + b_1 \left(\log (D_i) - \log (D_m)\right) \\
\\
\textrm{Distribution for (hyper)parameters} \\
a_{0,i}  \sim \mathrm{Normal}(2, 0.1) \\
a_{1}  \sim \mathrm{Normal}(0.5, 0.1) \\
b_{0,i}  \sim \mathrm{Normal}(0, 0.1) \\
b_{1}  \sim \mathrm{Normal}(-0.5, 0.1) \\
\sigma_a  \sim \mathrm{HalfCauchy}(0,1)  \\
\sigma_b  \sim \mathrm{HalfCauchy}(0,1)  \\
\sigma  \sim \mathrm{HalfCauchy}(0,1)  
\end{align}
\]</span></p>
<p>The model is similar to models 1-3, but with another distribution for parameters <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span>. Fitting this model didn’t work, the fitting routine kept choking. We concluded that with this model we are overfitting. However, I am also not sure if there is something more fundamentally wrong in the way we wrote down this model. I’m not sure if a mix of having parameters defined by equations, then as distributions and equations again is a generally wrong way. This is currently beyond my Bayesian understanding. Feedback appreciated 😄.</p>
<p>It is straightforward to translate the model to <code>rethinking</code> or <code>brms</code> code, but since it didn’t fit well, and I’m not even sure if it’s a “proper” model, there’s no point in showing the code. Implement it if you want, and let me know if you have some insights into what exactly might be wrong with the model.</p>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>This post contained a few more explorations of alternative models and model implementations. I know I didn’t provide as much explanation and detail as I did for the main tutorials. Hopefully, seeing these additional examples is still somewhat helpful. And you know what comes now: For more/real learning of that stuff, you should really check out <a href="https://xcelab.net/rm/statistical-rethinking/">Statistical Rethinking</a> 😁.</p>
</section>
<section id="more-things-to-try" class="level1">
<h1>More things to try</h1>
<p>This section is mainly for myself, some ideas for further extensions. Here are additional topics I can think of. Feel free to provide feedback if you want me to cover some other aspects (no promises of course, it depends on my time and understanding 😄).</p>
<ul>
<li>Treating dose as an ordered categorical variable. I started that, but haven’t finished yet. Hopefully will show up here soon.</li>
<li>Using a scientific/mechanistic/process model based on differential equations to describe the main time-series trajectory.</li>
<li>Exploring individual level variation in dose-dependence, i.e.&nbsp;<span class="math inline">\(a_{1,i}\)</span>, <span class="math inline">\(b_{1,i}\)</span> parameters.</li>
<li>Implementing some of the models in a fully frequentist framework and comparing.</li>
</ul>
<!-- # Treating dose as an __ordered__ categorical variable -->
<!-- For some predictors (e.g. treatment yes/no) there is no ordering. If we assume dose as categorical, there is a clear ordering (Low < Medium < High). If one assumes that an increase in dose has **a monotone impact on the outcome** then one can treat the predictor as ordered categorical variable.  -->
<!-- For our specific example, this is actually not the best idea. The reason is that we are not sure that dose has a monotone impact on the outcomes. But for the sake of illustrating how this could be done, here is an example. Including ordered predictors involves some trickeries, which you can learn about in chapter 12.4 of Statistical Rethinking (2nd edition). I won't attempt to explain the math behind it, I'll just show the code for `ulam`/rethinking`. -->
<!-- To compare with the two versions we just did, I'm implementing model 4 again. -->
<!-- ```{r} -->
<!-- #model with ordered categories -->
<!-- #naming this model m7 -->
<!-- m7 <- alist( -->
<!--   outcome ~ dnorm(mu, sigma), -->
<!--   mu <- exp(alpha)*log(time) - exp(beta)*time, -->
<!--   alpha <-  a0[id] + a1[dose_cat], -->
<!--   beta <-  b0[id] + b1[dose_cat], -->
<!--   a0[id] ~ dnorm(mu_a,  sigma_a), -->
<!--   b0[id] ~ dnorm(mu_b, sigma_b), -->
<!--   mu_a ~ dnorm(2, 1), -->
<!--   mu_b ~ dnorm(0.5, 1), -->
<!--   sigma_a ~ cauchy(0, 1), -->
<!--   sigma_b ~ cauchy(0, 1), -->
<!--   a1 ~ dnorm(0.3, 1), -->
<!--   b1 ~ dnorm(-0.3, 1), -->
<!--   simplex[7]:  -->
<!--   sigma ~ cauchy(0, 1) -->
<!--   ) -->
<!-- ``` -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{handel2022,
  author = {Andreas Handel},
  title = {Bayesian Analysis of Longitudinal Multilevel Data Using Brms
    and Rethinking - Part 4},
  date = {2022-02-25},
  url = {https://www.andreashandel.com/posts/2022-02-25-longitudinal-multilevel-bayes-4},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-handel2022" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Andreas Handel. 2022. <span>“Bayesian Analysis of Longitudinal
Multilevel Data Using Brms and Rethinking - Part 4.”</span> February 25,
2022. <a href="https://www.andreashandel.com/posts/2022-02-25-longitudinal-multilevel-bayes-4">https://www.andreashandel.com/posts/2022-02-25-longitudinal-multilevel-bayes-4</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="andreashandel/andreashandelwebsite" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left"><i class="fa-regular fa-copyright" aria-hidden="true"></i> Andreas Handel, 2022<br> All content licensed under <i class="fa-brands fa-creative-commons" aria-hidden="true"></i> <i class="fa-brands fa-creative-commons-by" aria-hidden="true"></i> <i class="fa-brands fa-creative-commons-sa" aria-hidden="true"></i> <i class="fa-brands fa-creative-commons-nc" aria-hidden="true"></i> <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">(CC BY-NC-SA 4.0)</a></div>   
      <div class="nav-footer-center"><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">Made with <i class="fa-brands fa-r-project" aria-hidden="true"></i> and <a href="https://quarto.org/">Quarto</a><br> Inspiration and code snippets taken from <a href="../../posts/quarto-website-migration.html">these folks.</a><br> <a href="https://github.com/andreashandel/andreashandelwebsite">Source at <i class="fa-brands fa-github" aria-hidden="true"></i> GitHub</a></div>
  </div>
</footer>



</body></html>