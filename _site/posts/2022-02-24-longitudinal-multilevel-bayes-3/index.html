<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andreas Handel">
<meta name="dcterms.date" content="2022-02-24">
<meta name="description" content="Andreas Handel’s personal website.">

<title>Andreas Handel - Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 3</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../..//files/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script type="text/plain" cookie-consent="tracking">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-48442618-4', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script> 
  

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../customstyle.css">
<meta name="twitter:title" content="Andreas Handel - Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 3">
<meta name="twitter:description" content="Part 3 of a tutorial showing how to fit Bayesian models using the `brms` package.">
<meta name="twitter:image" content="https://www.andreashandel.com/posts\2022-02-24-longitudinal-multilevel-bayes-3\featured.png">
<meta name="twitter:creator" content="@andreashandel">
<meta name="twitter:image-height" content="1800">
<meta name="twitter:image-width" content="1800">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../files/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Andreas Handel</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html">
 <span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../presentations.html">
 <span class="menu-text">Presentations</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html">
 <span class="menu-text">Projects</span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 3</h1>
                  <div>
        <div class="description">
          Part 3 of a tutorial showing how to fit Bayesian models using the <code>brms</code> package.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">Data Analysis</div>
                <div class="quarto-category">Bayesian</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Andreas Handel </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 24, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#r-setup" id="toc-r-setup" class="nav-link" data-scroll-target="#r-setup">R Setup</a></li>
  <li><a href="#data-loading" id="toc-data-loading" class="nav-link" data-scroll-target="#data-loading">Data loading</a></li>
  <li><a href="#fitting-with-brms" id="toc-fitting-with-brms" class="nav-link" data-scroll-target="#fitting-with-brms">Fitting with <code>brms</code></a>
  <ul class="collapse">
  <li><a href="#model-1" id="toc-model-1" class="nav-link" data-scroll-target="#model-1">Model 1</a></li>
  <li><a href="#model-2a" id="toc-model-2a" class="nav-link" data-scroll-target="#model-2a">Model 2a</a></li>
  <li><a href="#model-3" id="toc-model-3" class="nav-link" data-scroll-target="#model-3">Model 3</a></li>
  <li><a href="#model-4" id="toc-model-4" class="nav-link" data-scroll-target="#model-4">Model 4</a></li>
  <li><a href="#combine-models" id="toc-combine-models" class="nav-link" data-scroll-target="#combine-models">Combine models</a></li>
  <li><a href="#fitting-setup" id="toc-fitting-setup" class="nav-link" data-scroll-target="#fitting-setup">Fitting setup</a></li>
  <li><a href="#setting-starting-values" id="toc-setting-starting-values" class="nav-link" data-scroll-target="#setting-starting-values">Setting starting values</a></li>
  <li><a href="#model-fitting" id="toc-model-fitting" class="nav-link" data-scroll-target="#model-fitting">Model fitting</a></li>
  </ul></li>
  <li><a href="#explore-model-fits" id="toc-explore-model-fits" class="nav-link" data-scroll-target="#explore-model-fits">Explore model fits</a>
  <ul class="collapse">
  <li><a href="#models-1-and-3" id="toc-models-1-and-3" class="nav-link" data-scroll-target="#models-1-and-3">Models 1 and 3</a></li>
  <li><a href="#comparison-with-the-truth-and-ulam" id="toc-comparison-with-the-truth-and-ulam" class="nav-link" data-scroll-target="#comparison-with-the-truth-and-ulam">Comparison with the truth and <code>ulam</code></a></li>
  <li><a href="#model-2a-1" id="toc-model-2a-1" class="nav-link" data-scroll-target="#model-2a-1">Model 2a</a></li>
  <li><a href="#model-4-1" id="toc-model-4-1" class="nav-link" data-scroll-target="#model-4-1">Model 4</a></li>
  <li><a href="#comparing-all-models" id="toc-comparing-all-models" class="nav-link" data-scroll-target="#comparing-all-models">Comparing all models</a></li>
  <li><a href="#prior-exploration" id="toc-prior-exploration" class="nav-link" data-scroll-target="#prior-exploration">Prior exploration</a></li>
  </ul></li>
  <li><a href="#computing-predictions" id="toc-computing-predictions" class="nav-link" data-scroll-target="#computing-predictions">Computing predictions</a></li>
  <li><a href="#creating-plots-of-the-results" id="toc-creating-plots-of-the-results" class="nav-link" data-scroll-target="#creating-plots-of-the-results">Creating plots of the results</a></li>
  <li><a href="#showing-the-plots" id="toc-showing-the-plots" class="nav-link" data-scroll-target="#showing-the-plots">Showing the plots</a></li>
  <li><a href="#summary-and-continuation" id="toc-summary-and-continuation" class="nav-link" data-scroll-target="#summary-and-continuation">Summary and continuation</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>This is part 3 of a tutorial illustrating how one can use the <code>brms</code> and <code>rethinking</code> R packages to perform a Bayesian analysis of longitudinal data using a multilevel/hierarchical/mixed-effects setup.</p>
<p>I assume you’ve read both <a href="../../posts/longitudinal-multilevel-bayesian-analysis-1/">part 1</a>, and <a href="../../posts/longitudinal-multilevel-bayesian-analysis-2/">part 2</a> otherwise this post won’t make much sense.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In the previous post, I showed how to fit the data using the <code>rethinking</code> package. Now I’m re-doing it using <code>brms</code>. The <a href="https://paul-buerkner.github.io/brms/"><code>brms</code> package</a> is a widely used and very powerful tool to interface with Stan. It has overall more capabilities compared to <code>rethinking</code>. In my opinion, the main disadvantage is that it is often not obvious how to go from mathematical model to code, unless one has a good bit of experience jumping between the often terse formula notation of <code>brms</code> and the model equations. I’m not there yet, so I currently prefer to start with <code>rethinking</code>. But since <code>brms</code> can do things that are not as easy (or impossible) with <code>rethinking</code>, it seems good to know how to use both.</p>
<p>Also, comparing results using two different numerical packages is always good (even though both use <code>Stan</code> underneath, so in some sense those are not truly independent software routines).</p>
<p>As was true for <code>ulam/rethinking</code>, fitting the models can take a good bit of time. I therefore wrote separate <code>R</code> scripts for the fitting and the exploring parts. The code chunks from those scripts are shown below. The manual effort and slower pace of copying and pasting the code chunks from this tutorial and re-produce them can help in learning, but if you just want to get all the code from this post you can find it <a href="brmsfitmodels.R">here</a> and <a href="brmsexploremodels.R">here</a>.</p>
</section>
<section id="r-setup" class="level1">
<h1>R Setup</h1>
<p>As always, make sure these packages are installed. <code>brms</code> uses the <a href="https://mc-stan.org/">Stan Bayesian modeling engine</a>. If you did the fitting with <code>rethinking</code> tutorial, you’ll have it already installed, otherwise you’ll need to install it. It is in my experience mostly seamless, but at times it seems to be tricky. I generally follow the instructions on the <a href="https://github.com/rmcelreath/rethinking"><code>rethinking</code> website</a> and it has so far always worked for me. It might need some fiddling, but you should be able to get them all to work.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'dplyr'</span>) <span class="co"># for data manipulation</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'ggplot2'</span>) <span class="co"># for plotting</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'cmdstanr'</span>) <span class="co">#for model fitting</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'brms'</span>) <span class="co"># for model fitting</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'posterior'</span>) <span class="co">#for post-processing</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'fs'</span>) <span class="co">#for file path</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-loading" class="level1">
<h1>Data loading</h1>
<p>We’ll jump right in and load the data we generated in the previous tutorial.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>simdat <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"simdat.Rds"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#pulling out number of observations</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>Ntot <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(simdat<span class="sc">$</span>m3<span class="sc">$</span>id))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#fitting dataset 3</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#we need to make sure the id is coded as a factor variable</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#also removing anything in the dataframe that's not used for fitting</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#makes the Stan code more robust</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>fitdat<span class="ot">=</span><span class="fu">list</span>(<span class="at">id =</span> <span class="fu">as.factor</span>(simdat[[<span class="dv">3</span>]]<span class="sc">$</span>id),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">outcome =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>outcome,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose_adj =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>dose_adj,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">time =</span> simdat[[<span class="dv">3</span>]]<span class="sc">$</span>time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fitting-with-brms" class="level1">
<h1>Fitting with <code>brms</code></h1>
<p>We’ll fit some of the models we discussed in parts 1 and 2, now using the <code>brms</code> package. The main function in that package, which does the fitting using Stan, is <code>brm</code>.</p>
<p>First, we’ll specify each model. We’ll do that first, then run them all in a single loop. Since we determined when using <code>ulam</code>/<code>rethinking</code> that our model 2 was a bad model, and model 4 and 4a didn’t lead to much of a difference, I’m skipping those here and only do models 1, 2a, 3 and 4. I’m also skipping model 5 since I only ran that for diagnostics/understanding and it doesn’t encode the right structure, since dose effect is missing.</p>
<section id="model-1" class="level2">
<h2 class="anchored" data-anchor-id="model-1">Model 1</h2>
<p>This is one of the models with individual-level and dose-level effects, all priors fixed. This model has <span class="math inline">\(2N+2+1\)</span> parameters. <span class="math inline">\(N\)</span> each for the individual-level intercepts for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> (the <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,i}\)</span> parameters), the two dose-level parameters <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>, and 1 overall deviation, <span class="math inline">\(\sigma\)</span> for the outcome distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#no-pooling model</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#separate intercept for each individual/id</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#2x(N+1)+1 parameters</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>m1eqs <span class="ot">&lt;-</span> <span class="fu">bf</span>(  <span class="co">#main equation for time-series trajectory</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>          outcome <span class="sc">~</span>  <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>          <span class="co">#equations for alpha and beta</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>          alpha <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> id <span class="sc">+</span> dose_adj,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>          beta  <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> id <span class="sc">+</span> dose_adj,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">nl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>m1priors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="co">#assign priors to all coefficients related to both id and dose_adj for alpha and beta</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">2</span>, <span class="dv">10</span>),  <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"alpha"</span>),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">0.5</span>, <span class="dv">10</span>),  <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"beta"</span>),</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>              <span class="co">#change the dose_adj priors to something different than the id priors</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),   <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"alpha"</span>, <span class="at">coef =</span> <span class="st">"dose_adj"</span>),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),  <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"beta"</span>, <span class="at">coef =</span> <span class="st">"dose_adj"</span>),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">cauchy</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sigma"</span>) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice how this notation in <code>brms</code> looks quite a bit different from the mathematical equations or the <code>ulam</code> implementation. That’s a part I don’t particularly like about <code>brms</code>, the very condensed formula notation. It takes time getting used to and it always requires extra checking to ensure the model implemented in code corresponds to the mathematical model. One can check by looking at the priors and make sure they look as expected. We’ll do that below after we fit.</p>
</section>
<section id="model-2a" class="level2">
<h2 class="anchored" data-anchor-id="model-2a">Model 2a</h2>
<p>This is the easiest model, with only population level effects for intercept and dose, so only 2+2+1 parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#full-pooling model</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#2+2+1 parameters</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>m2aeqs <span class="ot">&lt;-</span> <span class="fu">bf</span>(  <span class="co">#main equation for time-series trajectory</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#equations for alpha and beta</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> dose_adj,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  beta  <span class="sc">~</span>  <span class="dv">1</span> <span class="sc">+</span> dose_adj,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">nl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>m2apriors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">2</span>, <span class="dv">2</span>),  <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"alpha"</span>, <span class="at">coef =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">0.5</span>, <span class="dv">2</span>),  <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"beta"</span>, <span class="at">coef =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),   <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"alpha"</span>, <span class="at">coef =</span> <span class="st">"dose_adj"</span>),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),  <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"beta"</span>, <span class="at">coef =</span> <span class="st">"dose_adj"</span>),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">cauchy</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-3" class="level2">
<h2 class="anchored" data-anchor-id="model-3">Model 3</h2>
<p>This is the same as model 1 but with different values for the priors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#same as model 1 but regularizing priors</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>m3eqs <span class="ot">&lt;-</span> m1eqs</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>m3priors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="co">#assign priors to all coefficients related to id and dose_adj for alpha and beta</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">2</span>, <span class="dv">1</span>),  <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"alpha"</span>),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),  <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"beta"</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#change the dose_adj priors to something different than the id priors</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),   <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"alpha"</span>, <span class="at">coef =</span> <span class="st">"dose_adj"</span>),</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),  <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"beta"</span>, <span class="at">coef =</span> <span class="st">"dose_adj"</span>),</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">cauchy</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sigma"</span>) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-4" class="level2">
<h2 class="anchored" data-anchor-id="model-4">Model 4</h2>
<p>This is the adaptive-pooling multi-level model where priors are estimated. Here we have for each main parameter (<span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>) an overall mean and standard deviation, and N individual intercepts, so 2 times 1+1+N. And of course we still have the 2 dose-related parameters and the overall standard deviation, so a total of 2*(1+1+N)+2+1 parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#adaptive prior, partial-pooling model</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>m4eqs <span class="ot">&lt;-</span> <span class="fu">bf</span>(  <span class="co">#main equation for time-series trajectory</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  outcome <span class="sc">~</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#equations for alpha and beta</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span>  (<span class="dv">1</span><span class="sc">|</span>id) <span class="sc">+</span> dose_adj,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  beta  <span class="sc">~</span>  (<span class="dv">1</span><span class="sc">|</span>id) <span class="sc">+</span> dose_adj,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">nl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>m4priors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">2</span>, <span class="dv">1</span>),  <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"alpha"</span>, <span class="at">coef =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),  <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"beta"</span>, <span class="at">coef =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">0.3</span>, <span class="dv">1</span>),   <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"alpha"</span>, <span class="at">coef =</span> <span class="st">"dose_adj"</span>),</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">1</span>),  <span class="at">class =</span> <span class="st">"b"</span>,  <span class="at">nlpar =</span> <span class="st">"beta"</span>, <span class="at">coef =</span> <span class="st">"dose_adj"</span>),</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">cauchy</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">nlpar =</span> <span class="st">"alpha"</span>),</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">cauchy</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">nlpar =</span> <span class="st">"beta"</span>),</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">cauchy</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combine-models" class="level2">
<h2 class="anchored" data-anchor-id="combine-models">Combine models</h2>
<p>To make our lives easier below, we combine all models and priors into lists.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#stick all models into a list</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>modellist <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m1=</span>m1eqs,<span class="at">m2a=</span>m2aeqs,<span class="at">m3=</span>m3eqs,<span class="at">m4=</span>m4eqs)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#also make list for priors</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>priorlist <span class="ot">=</span> <span class="fu">list</span>(<span class="at">m1priors=</span>m1priors,<span class="at">m2apriors=</span>m2apriors,<span class="at">m3priors=</span>m3priors,<span class="at">m4priors=</span>m4priors)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># set up a list in which we'll store our results</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(modellist))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fitting-setup" class="level2">
<h2 class="anchored" data-anchor-id="fitting-setup">Fitting setup</h2>
<p>We define some general values for the fitting. Since the starting values depend on number of chains, we need to do this setup first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#general settings for fitting</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">#you might want to adjust based on your computer</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>warmup <span class="ot">=</span> <span class="dv">6000</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>iter <span class="ot">=</span> warmup <span class="sc">+</span> <span class="fu">floor</span>(warmup<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>max_td <span class="ot">=</span> <span class="dv">18</span> <span class="co">#tree depth</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>adapt_delta <span class="ot">=</span> <span class="fl">0.9999</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>chains <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>cores  <span class="ot">=</span> chains</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>seed <span class="ot">=</span> <span class="dv">1234</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="setting-starting-values" class="level2">
<h2 class="anchored" data-anchor-id="setting-starting-values">Setting starting values</h2>
<p>We’ll again set starting values, as we did for <code>ulam/rethinking</code>. Note that <code>brms</code> needs them in a somewhat different form, namely as list of lists for each model, one list for each chain.</p>
<p>I set different values for each chain, so I can check that each chain ends up at the same posterior. This is inspired by <a href="https://solomonkurz.netlify.app/blog/2021-06-05-don-t-forget-your-inits/">this post by Solomon Kurz</a>, though I keep it simpler and just use the <code>jitter</code> function.</p>
<p>Note that this approach not only jitters (adds noise/variation) between chains, but also between the individual-level parameters for each chain. That’s fine for our purpose, it might even be beneficial.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Setting starting values</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 1</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>startm1 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">a0 =</span> <span class="fu">rep</span>(<span class="dv">2</span>,Ntot), <span class="at">b0 =</span> <span class="fu">rep</span>(<span class="fl">0.5</span>,Ntot), <span class="at">a1 =</span> <span class="fl">0.5</span> , <span class="at">b1 =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 2a</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>startm2a <span class="ot">=</span> <span class="fu">list</span>(<span class="at">a0 =</span> <span class="dv">2</span>, <span class="at">b0 =</span> <span class="fl">0.5</span>, <span class="at">a1 =</span> <span class="fl">0.5</span> , <span class="at">b1 =</span> <span class="fl">0.5</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for model 3</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>startm3 <span class="ot">=</span> startm1</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">#starting values for models 4</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>startm4 <span class="ot">=</span> <span class="fu">list</span>(<span class="at">mu_a =</span> <span class="dv">2</span>, <span class="at">sigma_a =</span> <span class="dv">1</span>, <span class="at">mu_b =</span> <span class="dv">0</span>, <span class="at">sigma_b =</span> <span class="dv">1</span>, <span class="at">a1 =</span> <span class="fl">0.5</span> , <span class="at">b1 =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">sigma =</span> <span class="dv">1</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">#put different starting values in list</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">#need to be in same order as models below</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">#one list for each chain, thus a 3-leveled list structure</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">#for each chain, we add jitter so they start at different values</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>startlist <span class="ot">=</span> <span class="fu">list</span>( <span class="fu">rep</span>(<span class="fu">list</span>(<span class="fu">lapply</span>(startm1,jitter,<span class="dv">10</span>)),chains),</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">rep</span>(<span class="fu">list</span>(<span class="fu">lapply</span>(startm2a,jitter,<span class="dv">10</span>)),chains),</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">rep</span>(<span class="fu">list</span>(<span class="fu">lapply</span>(startm3,jitter,<span class="dv">10</span>)),chains),</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">rep</span>(<span class="fu">list</span>(<span class="fu">lapply</span>(startm4,jitter,<span class="dv">10</span>)),chains)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>                  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting">Model fitting</h2>
<p>We’ll use the same strategy to loop though all models and fit them. The fitting code looks very similar to the previous one for <code>rethinking/ulam</code>, only now the fitting is done calling the <code>brm</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fitting models</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#loop over all models and fit them using ulam</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(modellist))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'************** </span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'starting model'</span>, <span class="fu">names</span>(modellist[n]), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  tstart<span class="ot">=</span><span class="fu">proc.time</span>(); <span class="co">#capture current time</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  fl[[n]]<span class="sc">$</span>fit <span class="ot">&lt;-</span> <span class="fu">brm</span>(<span class="at">formula =</span> modellist[[n]],</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> fitdat,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">prior =</span> priorlist[[n]],</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">init =</span> startlist[[n]],</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>                   <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span>adapt_delta, <span class="at">max_treedepth =</span> max_td),</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sample_prior =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>                   <span class="at">chains=</span>chains, <span class="at">cores =</span> cores,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>                   <span class="at">warmup =</span> warmup, <span class="at">iter =</span> iter,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>                   <span class="at">seed =</span> seed,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>                   <span class="at">backend =</span> <span class="st">"cmdstanr"</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  )<span class="co"># end brm statement</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  tend<span class="ot">=</span><span class="fu">proc.time</span>(); <span class="co">#capture current time</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  tdiff<span class="ot">=</span>tend<span class="sc">-</span>tstart;</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  runtime_minutes<span class="ot">=</span>tdiff[[<span class="dv">3</span>]]<span class="sc">/</span><span class="dv">60</span>;</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'model fit took this many minutes:'</span>, runtime_minutes, <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">'************** </span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add some more things to the fit object</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  fl[[n]]<span class="sc">$</span>runtime <span class="ot">=</span> runtime_minutes</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  fl[[n]]<span class="sc">$</span>model <span class="ot">=</span> <span class="fu">names</span>(modellist)[n]</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="co"># saving the results so we can use them later</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">=</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="st">"D:"</span>,<span class="st">"Dropbox"</span>,<span class="st">"datafiles"</span>,<span class="st">"longitudinalbayes"</span>,<span class="st">"brmsfits"</span>, <span class="at">ext=</span><span class="st">"Rds"</span>)</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fl,filepath)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You’ll likely find that model 1 takes the longest, the other ones run faster. You can check the runtime for each model by looking at <code>fl[[n]]$runtime</code>. It’s useful to first run with few iterations (100s instead of 1000s), make sure everything works in principle, then do a “final” long run with longer chains.</p>
</section>
</section>
<section id="explore-model-fits" class="level1">
<h1>Explore model fits</h1>
<p>As before, fits are in the list called <code>fl</code>. For each model the actual fit is in <code>fit</code>, the model name is in <code>model</code> and the run time is in <code>runtime</code>. Note that the code chunks below come from <a href="brmsexploremodels.R">this second R script</a>, thus some things are repeated (e.g., loading of simulated data).</p>
<p>As we did after fitting with <code>ulam/rethinking</code>, let’s briefly inspect some of the models. I’m again only showing a few of those explorations to illustrate what I mean. For any real fitting, it is important to carefully look at all the output and make sure everything worked as expected and makes sense.</p>
<p>I’m again focusing on the simple model 2a, which has no individual-level parameters, thus only a total of 5.</p>
<p>We are using various additional packages here to get plots and output that looks similar to what <code>rethinking</code> produces. I’m getting most of the code snippets from the <a href="https://bookdown.org/content/4857/">Statistical Rethinking using <code>brms</code> book</a> by Solomon Kurz.</p>
<p>Need a few more packages for this part:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'dplyr'</span>) <span class="co"># for data manipulation</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'tidyr'</span>) <span class="co"># for data manipulation</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'ggplot2'</span>) <span class="co"># for plotting</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'cmdstanr'</span>) <span class="co">#for model fitting</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'brms'</span>) <span class="co"># for model fitting</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'posterior'</span>) <span class="co">#for post-processing</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'bayesplot'</span>) <span class="co">#for plots</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'fs'</span>) <span class="co">#for file path</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Loading the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loading list of previously saved fits.</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># useful if we don't want to re-fit</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># every time we want to explore the results.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># since the file is too large for GitHub</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># it is stored in a local folder</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># adjust accordingly for your setup</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>filepath <span class="ot">=</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="st">"D:"</span>,<span class="st">"Dropbox"</span>,<span class="st">"datafiles"</span>,<span class="st">"longitudinalbayes"</span>,<span class="st">"brmsfits"</span>, <span class="at">ext=</span><span class="st">"Rds"</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(filepath)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># also load data file used for fitting</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>simdat <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"simdat.Rds"</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">#pull our the data set we used for fitting</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">#if you fit a different one of the simulated datasets, change accordingly</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>fitdat <span class="ot">&lt;-</span> simdat<span class="sc">$</span>m3</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">#contains parameters used for fitting</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>pars <span class="ot">&lt;-</span> simdat<span class="sc">$</span>m3pars</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The summary output looks a bit different compared to <code>ulam</code>, but fairly similar.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2a summary</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co">#saving a bit of typing below</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> fl[[<span class="dv">2</span>]]<span class="sc">$</span>fit</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: outcome ~ exp(alpha) * log(time) - exp(beta) * time 
         alpha ~ 1 + dose_adj
         beta ~ 1 + dose_adj
   Data: fitdat (Number of observations: 264) 
  Draws: 5 chains, each with iter = 9000; warmup = 6000; thin = 1;
         total post-warmup draws = 15000

Population-Level Effects: 
                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
alpha_Intercept     2.98      0.02     2.94     3.02 1.00     6244     6691
alpha_dose_adj      0.10      0.01     0.08     0.12 1.00     6569     7301
beta_Intercept      0.99      0.02     0.95     1.03 1.00     6387     6724
beta_dose_adj      -0.10      0.01    -0.11    -0.08 1.00     6947     7786

Family Specific Parameters: 
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     6.88      0.30     6.32     7.49 1.00     8391     7850

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Here is the default trace plot. Note that <code>brms</code> only plots the post-warmup iterations, and also shows the posterior distributions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2a trace plots</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/traceplot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Since I want to see if the different initial conditions did something useful, I was trying to make a trace plot that shows warmup. Solomon Kurz has <a href="https://bookdown.org/content/4857/markov-chain-monte-carlo.html#visualization.">an example using the <code>ggmcmc</code> package</a>, but his code doesn’t work for me, it always ignores the warmup. I used 6000 warmup samples and 3000 post-warmup samples for each chain. Currently, the figure only shows post-warmup.</p>
<p>For now, it’s another trace plot using the <code>bayesplot</code> package - also which has an example of making the plot I want, but for some reason the <code>stanfit</code> object inside the <code>brms</code> output does not contain the warmups. So for now, what’s shown doesn’t actually include the warmups. Leaving this plot for now and moving on…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Another trace plot, using the bayesplot package</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>posterior <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(fit2<span class="sc">$</span>fit, <span class="at">inc_warmup =</span> <span class="cn">TRUE</span>, <span class="at">permuted =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_trace</span>(posterior, <span class="at">n_warmup =</span> <span class="dv">400</span>, <span class="at">pars =</span> <span class="fu">variables</span>(fit2)[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/traceplot-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here is a version of the trank plots. I’m pulling out the first 5 variables since the others are not that interesting for this plot, e.g., they contain prior samples. You can look at them if you want.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2a trank plots with bayesplot</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_rank_overlay</span>(fit2, <span class="at">pars =</span> <span class="fu">variables</span>(fit2)[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/trankplot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Another nice plot I saw was an autocorrelation plot. One wants little autocorrelation for parameters. This seems to be the case:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_acf</span>(fit2, <span class="at">pars =</span> <span class="fu">variables</span>(fit2)[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/autocorrelationplot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And finally a pair plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2a pair plot</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation between posterior samples of parameters</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/pairplot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>While the layout looks different - and I didn’t bother to try and make things look exactly the same between <code>brms</code> and <code>rethinking</code> - the overall results are similar. That’s encouraging.</p>
<p>Some of the plots already showed posterior distributions, but let’s look at those more carefully.</p>
<section id="models-1-and-3" class="level2">
<h2 class="anchored" data-anchor-id="models-1-and-3">Models 1 and 3</h2>
<p>Let’s explore those two models first. Recall that they are the same, apart from the prior definitions. As previously, the wider priors for model 1 make it less efficient. With the settings I used, run times were 417 minutes for model 1 versus 61 minutes for model 3.</p>
<p>Let’s see if the priors impact the results, i.e.&nbsp;the posterior distributions. We can actually do that by looking briefly at the summaries for both fits.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save some typing</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> fl[[<span class="dv">1</span>]]<span class="sc">$</span>fit</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> fl[[<span class="dv">3</span>]]<span class="sc">$</span>fit</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: outcome ~ exp(alpha) * log(time) - exp(beta) * time 
         alpha ~ 0 + id + dose_adj
         beta ~ 0 + id + dose_adj
   Data: fitdat (Number of observations: 264) 
  Draws: 5 chains, each with iter = 9000; warmup = 6000; thin = 1;
         total post-warmup draws = 15000

Population-Level Effects: 
               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
alpha_id1          3.50      1.67     0.26     6.80 1.00     2840     4734
alpha_id2          3.46      1.67     0.21     6.75 1.00     2839     4794
alpha_id3          3.26      1.67     0.02     6.56 1.00     2839     4760
alpha_id4          3.19      1.67    -0.05     6.49 1.00     2841     4760
alpha_id5          3.24      1.67    -0.01     6.53 1.00     2839     4760
alpha_id6          3.33      1.67     0.08     6.62 1.00     2839     4760
alpha_id7          3.28      1.67     0.03     6.58 1.00     2841     4796
alpha_id8          2.98      0.02     2.95     3.01 1.00    17885    10342
alpha_id9          2.91      0.02     2.88     2.94 1.00    17315    10942
alpha_id10         2.98      0.02     2.95     3.01 1.00    17656    10966
alpha_id11         2.94      0.02     2.91     2.97 1.00    18085    10133
alpha_id12         2.84      0.02     2.81     2.88 1.00    17692    11631
alpha_id13         2.97      0.02     2.94     3.00 1.00    18451    10345
alpha_id14         3.09      0.01     3.06     3.12 1.00    18387    10003
alpha_id15         2.95      0.02     2.91     2.98 1.00    17682    10963
alpha_id16         2.77      1.67    -0.52     6.01 1.00     2839     4781
alpha_id17         2.54      1.67    -0.76     5.79 1.00     2840     4750
alpha_id18         2.73      1.67    -0.57     5.97 1.00     2839     4798
alpha_id19         2.76      1.67    -0.53     6.01 1.00     2839     4820
alpha_id20         2.73      1.67    -0.56     5.98 1.00     2840     4771
alpha_id21         2.71      1.67    -0.59     5.96 1.00     2840     4751
alpha_id22         2.66      1.67    -0.64     5.91 1.00     2839     4807
alpha_id23         2.65      1.67    -0.64     5.90 1.00     2840     4764
alpha_id24         2.59      1.67    -0.70     5.84 1.00     2838     4762
alpha_dose_adj     0.22      0.73    -1.19     1.65 1.00     2839     4785
beta_id1           0.75      1.71    -2.66     4.10 1.00     2420     4179
beta_id2           0.65      1.71    -2.76     4.01 1.00     2420     4181
beta_id3           0.70      1.71    -2.72     4.04 1.00     2419     4158
beta_id4           0.71      1.71    -2.70     4.06 1.00     2419     4155
beta_id5           0.93      1.71    -2.48     4.28 1.00     2418     4167
beta_id6           0.68      1.71    -2.73     4.03 1.00     2419     4175
beta_id7           0.77      1.71    -2.64     4.13 1.00     2419     4155
beta_id8           1.01      0.01     0.99     1.04 1.00    16977    10323
beta_id9           0.91      0.02     0.88     0.94 1.00    17374    11382
beta_id10          0.98      0.01     0.96     1.01 1.00    18009    10155
beta_id11          1.15      0.01     1.13     1.18 1.00    18260    10293
beta_id12          1.05      0.01     1.02     1.07 1.00    17891    11580
beta_id13          1.01      0.01     0.98     1.04 1.00    18998    10824
beta_id14          0.95      0.01     0.92     0.98 1.00    18321    10396
beta_id15          0.79      0.02     0.75     0.82 1.00    17550    11046
beta_id16          1.36      1.71    -1.99     4.77 1.00     2418     4208
beta_id17          1.08      1.71    -2.27     4.49 1.00     2419     4159
beta_id18          1.36      1.71    -2.00     4.77 1.00     2421     4150
beta_id19          1.44      1.71    -1.92     4.85 1.00     2417     4173
beta_id20          1.09      1.71    -2.25     4.50 1.00     2420     4083
beta_id21          1.31      1.71    -2.04     4.73 1.00     2420     4118
beta_id22          1.24      1.71    -2.10     4.65 1.00     2421     4122
beta_id23          1.12      1.71    -2.23     4.53 1.00     2419     4157
beta_id24          1.09      1.71    -2.26     4.51 1.00     2419     4209
beta_dose_adj     -0.21      0.74    -1.69     1.24 1.00     2419     4163

Family Specific Parameters: 
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     1.06      0.05     0.97     1.17 1.00    16342    11307

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: outcome ~ exp(alpha) * log(time) - exp(beta) * time 
         alpha ~ 0 + id + dose_adj
         beta ~ 0 + id + dose_adj
   Data: fitdat (Number of observations: 264) 
  Draws: 5 chains, each with iter = 9000; warmup = 6000; thin = 1;
         total post-warmup draws = 15000

Population-Level Effects: 
               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
alpha_id1          3.31      0.25     2.83     3.80 1.00     2443     4189
alpha_id2          3.27      0.25     2.79     3.75 1.00     2418     4115
alpha_id3          3.07      0.25     2.59     3.55 1.00     2447     4120
alpha_id4          3.00      0.25     2.52     3.48 1.00     2433     4196
alpha_id5          3.05      0.25     2.56     3.53 1.00     2437     4206
alpha_id6          3.14      0.25     2.66     3.62 1.00     2465     4179
alpha_id7          3.09      0.25     2.61     3.57 1.00     2438     4311
alpha_id8          2.98      0.02     2.95     3.01 1.00    18493    10858
alpha_id9          2.91      0.02     2.87     2.94 1.00    18973    11242
alpha_id10         2.98      0.02     2.95     3.01 1.00    18479    10529
alpha_id11         2.94      0.02     2.91     2.97 1.00    18804    10454
alpha_id12         2.84      0.02     2.81     2.87 1.00    18873    11236
alpha_id13         2.97      0.02     2.94     3.00 1.00    19043    11438
alpha_id14         3.09      0.01     3.06     3.12 1.00    19247    10690
alpha_id15         2.95      0.02     2.91     2.98 1.00    19114    12099
alpha_id16         2.96      0.25     2.48     3.44 1.00     2432     4256
alpha_id17         2.73      0.25     2.25     3.21 1.00     2418     4214
alpha_id18         2.92      0.25     2.43     3.39 1.00     2433     4335
alpha_id19         2.95      0.25     2.47     3.43 1.00     2438     4308
alpha_id20         2.92      0.25     2.43     3.40 1.00     2427     4161
alpha_id21         2.90      0.25     2.41     3.37 1.00     2418     4311
alpha_id22         2.85      0.25     2.36     3.33 1.00     2439     4182
alpha_id23         2.84      0.25     2.36     3.32 1.00     2431     4213
alpha_id24         2.78      0.25     2.30     3.26 1.00     2438     4170
alpha_dose_adj     0.14      0.11    -0.07     0.35 1.00     2426     4307
beta_id1           1.05      0.24     0.58     1.53 1.00     2953     5165
beta_id2           0.96      0.24     0.49     1.43 1.00     2937     5242
beta_id3           1.00      0.24     0.53     1.47 1.00     2944     5168
beta_id4           1.01      0.24     0.54     1.49 1.00     2937     5142
beta_id5           1.24      0.24     0.76     1.71 1.00     2939     5218
beta_id6           0.99      0.24     0.52     1.46 1.00     2946     5117
beta_id7           1.08      0.24     0.60     1.55 1.00     2941     5223
beta_id8           1.01      0.01     0.99     1.04 1.00    18029    10844
beta_id9           0.91      0.02     0.88     0.93 1.00    18953    11005
beta_id10          0.98      0.01     0.96     1.01 1.00    18500    10509
beta_id11          1.15      0.01     1.13     1.17 1.00    18599    10418
beta_id12          1.05      0.01     1.02     1.07 1.00    19002    10853
beta_id13          1.01      0.01     0.98     1.04 1.00    18714    11040
beta_id14          0.95      0.01     0.92     0.98 1.00    19168    10286
beta_id15          0.79      0.02     0.75     0.82 1.00    18771    11344
beta_id16          1.06      0.24     0.58     1.53 1.00     2943     5165
beta_id17          0.78      0.25     0.30     1.25 1.00     2941     5155
beta_id18          1.05      0.24     0.58     1.53 1.00     2939     5207
beta_id19          1.14      0.24     0.66     1.61 1.00     2951     5251
beta_id20          0.79      0.25     0.31     1.26 1.00     2962     5253
beta_id21          1.00      0.24     0.52     1.47 1.00     2944     5222
beta_id22          0.94      0.24     0.46     1.41 1.00     2951     5207
beta_id23          0.82      0.25     0.34     1.29 1.00     2943     5263
beta_id24          0.79      0.25     0.31     1.26 1.00     2957     5311
beta_dose_adj     -0.08      0.11    -0.29     0.13 1.00     2939     5258

Family Specific Parameters: 
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     1.06      0.05     0.97     1.17 1.00    15961    10880

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Note the different naming of the parameters in <code>brms</code>. It’s unfortunately not possible (as far as I know) to get the names match the mathematical model. The parameters that have <code>dose</code> in their names are the ones we called <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> in our models. The many <code>_id</code> parameters are our previous <span class="math inline">\(a_0\)</span> and <span class="math inline">\(b_0\)</span> parameters. Conceptually, the latter are on the individual level. But we don’t have a nested/multi-level structure here, which seems to lead <code>brms</code> to consider every parameter on the same level, and thus labeling them all <em>population level</em>.</p>
<p>Now, let’s look at priors and posteriors somewhat more. First, we extract priors and posteriors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#get priors and posteriors for models 1 and 3</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>m1prior <span class="ot">&lt;-</span> <span class="fu">prior_draws</span>(fit1)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>m1post <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit1)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>m3prior <span class="ot">&lt;-</span> <span class="fu">prior_draws</span>(fit3)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>m3post <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can plot the distributions. I’m focusing on the <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> parameters since those are of more interest, and because I couldn’t figure out quickly how to get out and process all the individual level <span class="math inline">\(a_0\)</span> and <span class="math inline">\(b_0\)</span> parameters from <code>brms</code> 😁.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#showing density plots for a1</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">#make a data frame and get it in shape for ggplot</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>a1df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">m1_prior =</span> m1prior<span class="sc">$</span>b_alpha_dose_adj,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">m1_post =</span> m1post<span class="sc">$</span>b_alpha_dose_adj,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">m3_prior =</span> m3prior<span class="sc">$</span>b_alpha_dose_adj,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">m3_post =</span>  m3post<span class="sc">$</span>b_alpha_dose_adj) <span class="sc">%&gt;%</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"model"</span>,<span class="st">"type"</span>), <span class="at">names_pattern =</span> <span class="st">"(.*)_(.*)"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># make plot</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> a1df <span class="sc">%&gt;%</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> model, <span class="at">linetype =</span> type), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_prior_plots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save for display on post</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">"featured.png"</span>), p1, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">width =</span> <span class="dv">6</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">#showing density plots for b1</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>b1df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">m1_prior =</span> m1prior<span class="sc">$</span>b_beta_dose_adj,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">m1_post =</span> m1post<span class="sc">$</span>b_beta_dose_adj,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">m3_prior =</span> m3prior<span class="sc">$</span>b_beta_dose_adj,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">m3_post =</span>  m3post<span class="sc">$</span>b_beta_dose_adj) <span class="sc">%&gt;%</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"model"</span>,<span class="st">"type"</span>), <span class="at">names_pattern =</span> <span class="st">"(.*)_(.*)"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> b1df <span class="sc">%&gt;%</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> model, <span class="at">linetype =</span> type), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_prior_plots-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As before, the priors for the <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> parameters are the same. We only changed the <span class="math inline">\(a_0\)</span> and <span class="math inline">\(b_0\)</span> priors, but that change leads to different posteriors for <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>. It’s basically the same result we found with <code>ulam/rethinking</code>.</p>
<p>It would be surprising if we did NOT find the same correlation structure again in the parameters, let’s check it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a few parameters for each dose</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co">#low dose</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fit1, <span class="at">variable =</span> <span class="fu">variables</span>(fit1)[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="dv">25</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_pair_plots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#medium dose</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fit1, <span class="at">variable =</span> <span class="fu">variables</span>(fit1)[<span class="fu">c</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>,<span class="dv">25</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_pair_plots-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#high dose</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fit1, <span class="at">variable =</span> <span class="fu">variables</span>(fit1)[<span class="fu">c</span>(<span class="dv">16</span><span class="sc">:</span><span class="dv">19</span>,<span class="dv">25</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_1_3_pair_plots-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Apart from the unfortunate naming of parameters in <code>brms</code>, these are the same plots as we made for the <code>ulam</code> fits and show the same patterns.</p>
<p>Let’s look at the posteriors in numerical form.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model 1 first</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>fit1pars <span class="ot">=</span> posterior<span class="sc">::</span><span class="fu">summarize_draws</span>(m1post, <span class="st">"mean"</span>, <span class="st">"sd"</span>, <span class="st">"quantile2"</span>, <span class="fu">default_convergence_measures</span>())</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">#only entries for the a0 parameters</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>a0post <span class="ot">&lt;-</span> m1post <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">'b_alpha_id'</span>))</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>fit1a0mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">colMeans</span>(a0post))</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">#only entries for the b0 parameters</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>b0post <span class="ot">&lt;-</span> m1post <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">'b_beta_id'</span>))</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>fit1b0mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">colMeans</span>(b0post))</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>fit1otherpars <span class="ot">&lt;-</span> fit1pars <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">'_id'</span>,variable)) <span class="sc">%&gt;%</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">'prior'</span>,variable))</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit1otherpars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
  variable             mean     sd       q5     q95  rhat ess_bulk ess_tail
  &lt;chr&gt;               &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 b_alpha_dose_adj    0.224 0.726    -0.972    1.44  1.00    2839.    4785.
2 b_beta_dose_adj    -0.212 0.744    -1.44     1.01  1.00    2419.    4163.
3 sigma               1.06  0.0514    0.981    1.15  1.00   16342.   11307.
4 lp__             -549.    5.58   -559.    -540.    1.00    4974.    8286.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(fit1a0mean,fit1b0mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.960140 1.006334</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># repeat for model 3</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>fit3pars <span class="ot">=</span> posterior<span class="sc">::</span><span class="fu">summarize_draws</span>(m3post, <span class="st">"mean"</span>, <span class="st">"sd"</span>, <span class="st">"quantile2"</span>, <span class="fu">default_convergence_measures</span>())</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co">#only entries for the a0 parameters</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>a0post <span class="ot">&lt;-</span> m3post <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">'b_alpha_id'</span>))</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>fit3a0mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">colMeans</span>(a0post))</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co">#only entries for the b0 parameters</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>b0post <span class="ot">&lt;-</span> m3post <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">'b_beta_id'</span>))</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>fit3b0mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">colMeans</span>(b0post))</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>fit3otherpars <span class="ot">&lt;-</span> fit3pars <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">'_id'</span>,variable)) <span class="sc">%&gt;%</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">'prior'</span>,variable))</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit3otherpars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
  variable              mean     sd        q5       q95  rhat ess_bulk ess_tail
  &lt;chr&gt;                &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 b_alpha_dose_adj    0.142  0.107    -0.0334    0.316   1.00    2426.    4307.
2 b_beta_dose_adj    -0.0811 0.106    -0.254     0.0921  1.00    2939.    5258.
3 sigma               1.06   0.0515    0.982     1.15    1.00   15961.   10880.
4 lp__             -453.     5.60   -463.     -444.      1.00    4605.    7829.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(fit3a0mean,fit3b0mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.9756367 0.9808696</code></pre>
</div>
</div>
<p>Again, model 1 seems worse, with higher uncertainty intervals for the <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> parameters and the mean further away from the true value.</p>
<p>We can also compare the models as we did for <code>rethinking</code> using these lines of code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>fit13comp <span class="ot">&lt;-</span> <span class="fu">loo_compare</span>(<span class="fu">add_criterion</span>(fit1,<span class="st">"waic"</span>),</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>            <span class="fu">add_criterion</span>(fit3,<span class="st">"waic"</span>),</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">criterion =</span> <span class="st">"waic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 
30 (11.4%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 
29 (11.0%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit13comp, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                            elpd_diff se_diff elpd_waic se_elpd_waic p_waic
add_criterion(fit1, "waic")    0.0       0.0  -416.3      11.7         43.5
add_criterion(fit3, "waic")    0.0       0.2  -416.3      11.7         43.5
                            se_p_waic waic   se_waic
add_criterion(fit1, "waic")    4.3     832.5   23.4 
add_criterion(fit3, "waic")    4.3     832.6   23.4 </code></pre>
</div>
</div>
<p>Model performance is similar between models. The WAIC values are also close to those reported by <code>rethinking</code>.</p>
</section>
<section id="comparison-with-the-truth-and-ulam" class="level2">
<h2 class="anchored" data-anchor-id="comparison-with-the-truth-and-ulam">Comparison with the truth and <code>ulam</code></h2>
<p>The values used to generate the data are: <span class="math inline">\(\sigma =\)</span> 1, <span class="math inline">\(\mu_a =\)</span> 3, <span class="math inline">\(\mu_b =\)</span> 1, <span class="math inline">\(a_1 =\)</span> 0.1, <span class="math inline">\(b_1 =\)</span> -0.1.</p>
<p>Since the models are the same as those we previously fit with <code>ulam</code>, only a different <code>R</code> package is used to run them, we should expect very similar results. This is the case. We find that as for the <code>ulam</code> fits, the estimates for <span class="math inline">\(a_0\)</span>, <span class="math inline">\(b_0\)</span> and <span class="math inline">\(\sigma\)</span> are similar to the values used the generate the data, but estimates for <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span> are not that great. The agreement with <code>ulam</code> is good, because we should expect that if we fit the same models, results should - up to numerical/sampling differences - be the same, no matter what software implementation we use. It also suggests that we did things right - or made the same mistake in both implementations! 😁.</p>
<p>Why the WAIC estimates are different is currently not clear to me. It could be that the 2 packages use different definitions/ways to compute it. Or something more fundamental is still different. I’m not sure.</p>
</section>
<section id="model-2a-1" class="level2">
<h2 class="anchored" data-anchor-id="model-2a-1">Model 2a</h2>
<p>This is the model with only population-level estimates. We already explored it somewhat above when we looked at traceplots and trankplots and the like. Here is just another quick table for the posteriors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>m2post <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit2)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>fit2pars <span class="ot">=</span> posterior<span class="sc">::</span><span class="fu">summarize_draws</span>(m2post, <span class="st">"mean"</span>, <span class="st">"sd"</span>, <span class="st">"quantile2"</span>, <span class="fu">default_convergence_measures</span>())</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>fit2otherpars <span class="ot">&lt;-</span> fit2pars <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">'prior'</span>,variable))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit2otherpars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 8
  variable               mean      sd        q5       q95  rhat ess_bulk ess_t…¹
  &lt;chr&gt;                 &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
1 b_alpha_Intercept    2.98   0.0211     2.95      3.02    1.00    6244.   6691.
2 b_alpha_dose_adj     0.0960 0.00967    0.0802    0.112   1.00    6569.   7301.
3 b_beta_Intercept     0.992  0.0188     0.961     1.02    1.00    6387.   6724.
4 b_beta_dose_adj     -0.0971 0.00862   -0.111    -0.0829  1.00    6947.   7786.
5 sigma                6.88   0.302      6.39      7.39    1.00    8391.   7850.
6 lp__              -892.     1.59    -895.     -890.      1.00    4964.   7039.
# … with abbreviated variable name ¹​ess_tail</code></pre>
</div>
</div>
<p>The parameters that have <code>_Intercept</code> in their name are what we called <span class="math inline">\(\mu_a\)</span> and <span class="math inline">\(\mu_b\)</span>, the ones containing <code>_dose</code> are our <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>. We find pretty much the same results we found using <code>ulam</code>. Specifically, the main parameters are estimated well, but because the model is not very flexible, the estimate for <span class="math inline">\(\sigma\)</span> is much larger, since it needs to account for all the individual-level variation we ommitted from the model itself.</p>
</section>
<section id="model-4-1" class="level2">
<h2 class="anchored" data-anchor-id="model-4-1">Model 4</h2>
<p>This is what I consider the most interesting and conceptually best model. It performed best in the <code>ulam</code> fits. Let’s see how it looks here. It is worth pointing out that this model ran much faster compared to models 1 and 3, it only took 10.5518333 minutes.</p>
<p>We’ll start with the summary for the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>fit4 <span class="ot">&lt;-</span> fl[[<span class="dv">4</span>]]<span class="sc">$</span>fit</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>m4prior <span class="ot">&lt;-</span> <span class="fu">prior_draws</span>(fit4)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>m4post <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit4)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: outcome ~ exp(alpha) * log(time) - exp(beta) * time 
         alpha ~ (1 | id) + dose_adj
         beta ~ (1 | id) + dose_adj
   Data: fitdat (Number of observations: 264) 
  Draws: 5 chains, each with iter = 9000; warmup = 6000; thin = 1;
         total post-warmup draws = 15000

Group-Level Effects: 
~id (Number of levels: 24) 
                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(alpha_Intercept)     0.09      0.02     0.07     0.13 1.00     3685     6514
sd(beta_Intercept)      0.12      0.02     0.09     0.16 1.00     4048     5853

Population-Level Effects: 
                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
alpha_Intercept     2.99      0.02     2.95     3.03 1.00     3771     5404
alpha_dose_adj      0.09      0.01     0.07     0.11 1.00     3979     5040
beta_Intercept      0.99      0.02     0.94     1.03 1.00     3486     5134
beta_dose_adj      -0.11      0.01    -0.13    -0.08 1.00     3855     5732

Family Specific Parameters: 
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     1.06      0.05     0.97     1.17 1.00    10136    10314

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Next, the prior/posterior plots. To ensure one can see the priors, I’m cutting off the y-axis at 10, that’s why the posteriors look a bit weird. They do infected extend and peak like the distributions shown for models 1 and 3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">#showing density plots for a1 and b1</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co">#make a data frame and get it in shape for ggplot</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>m4df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">a1_prior =</span> m4prior<span class="sc">$</span>b_alpha_dose_adj,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">a1_post =</span> m4post<span class="sc">$</span>b_alpha_dose_adj,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">b1_prior =</span> m4prior<span class="sc">$</span>b_beta_dose_adj,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">b1_post =</span> m4post<span class="sc">$</span>b_beta_dose_adj) <span class="sc">%&gt;%</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"parameter"</span>,<span class="st">"type"</span>), <span class="at">names_pattern =</span> <span class="st">"(.*)_(.*)"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co"># make plot</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> m4df <span class="sc">%&gt;%</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">10</span>) <span class="sc">+</span> <span class="fu">xlim</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> parameter, <span class="at">linetype =</span> type), <span class="at">adjust =</span> <span class="dv">10</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">'model 4, parameters a1 and b1'</span>) <span class="sc">+</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_prior_plots-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Numerical output for the posterior:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>fit4pars <span class="ot">=</span> posterior<span class="sc">::</span><span class="fu">summarize_draws</span>(m4post, <span class="st">"mean"</span>, <span class="st">"sd"</span>, <span class="st">"quantile2"</span>, <span class="fu">default_convergence_measures</span>())</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>fit4otherpars <span class="ot">&lt;-</span> fit4pars <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">'_id'</span>,variable)) <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">'prior'</span>,variable)) <span class="sc">%&gt;%</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">'z_'</span>,variable))</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit4otherpars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 8
  variable               mean     sd        q5       q95  rhat ess_bulk ess_tail
  &lt;chr&gt;                 &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 b_alpha_Intercept    2.99   0.0197    2.95      3.02    1.00    3771.    5404.
2 b_alpha_dose_adj     0.0861 0.0106    0.0688    0.104   1.00    3979.    5040.
3 b_beta_Intercept     0.987  0.0247    0.946     1.03    1.00    3486.    5134.
4 b_beta_dose_adj     -0.106  0.0131   -0.127    -0.0844  1.00    3855.    5732.
5 sigma                1.06   0.0517    0.981     1.15    1.00   10136.   10314.
6 lp__              -468.     7.47   -481.     -457.      1.00    2720.    4987.</code></pre>
</div>
</div>
<p>These estimates look good, close to the truth.</p>
<p>Finishing with the pairs lots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a few parameters for each dose</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co">#low dose</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fit4, <span class="at">variable =</span> <span class="fu">variables</span>(fit4)[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="dv">25</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_pair_plots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">#medium dose</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fit4, <span class="at">variable =</span> <span class="fu">variables</span>(fit4)[<span class="fu">c</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>,<span class="dv">25</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_pair_plots-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">#high dose</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fit4, <span class="at">variable =</span> <span class="fu">variables</span>(fit4)[<span class="fu">c</span>(<span class="dv">16</span><span class="sc">:</span><span class="dv">19</span>,<span class="dv">25</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/mod_4_pair_plots-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The strong correlations between parameters are reduced, the same we say with the <code>ulam</code> models.</p>
<p>As was the case for the <code>ulam</code> fits, model 4 seems to perform overall best.</p>
</section>
<section id="comparing-all-models" class="level2">
<h2 class="anchored" data-anchor-id="comparing-all-models">Comparing all models</h2>
<p>We can repeat the model comparison we did above, now including all 4 models. I’m looking now at both WAIC and LOO (leave one out). Note the various warning messages. We got that as well when we computed PSIS (which is similar to LOO) with <code>rethinking</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>fit1a <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit1,<span class="fu">c</span>(<span class="st">"waic"</span>,<span class="st">"loo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 
30 (11.4%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 6 observations with a pareto_k &gt; 0.7 in model 'fit1'. It is
recommended to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>fit2a <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit2,<span class="fu">c</span>(<span class="st">"waic"</span>,<span class="st">"loo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 
5 (1.9%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>fit3a <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit3,<span class="fu">c</span>(<span class="st">"waic"</span>,<span class="st">"loo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 
29 (11.0%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 5 observations with a pareto_k &gt; 0.7 in model 'fit3'. It is
recommended to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>fit4a <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit4,<span class="fu">c</span>(<span class="st">"waic"</span>,<span class="st">"loo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 
27 (10.2%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 6 observations with a pareto_k &gt; 0.7 in model 'fit4'. It is
recommended to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>compall1 <span class="ot">&lt;-</span> <span class="fu">loo_compare</span>(fit1a,fit2a,fit3a,fit4a, <span class="at">criterion =</span> <span class="st">"waic"</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>compall2 <span class="ot">&lt;-</span> <span class="fu">loo_compare</span>(fit1a,fit2a,fit3a,fit4a, <span class="at">criterion =</span> <span class="st">"loo"</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(compall1, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
fit4a    0.0       0.0  -415.7      11.7         42.7    4.3     831.4   23.4 
fit1a   -0.6       1.2  -416.3      11.7         43.5    4.3     832.5   23.4 
fit3a   -0.6       1.3  -416.3      11.7         43.5    4.3     832.6   23.4 
fit2a -473.6      23.0  -889.4      22.4         10.3    3.0    1778.7   44.8 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(compall2, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      elpd_diff se_diff elpd_loo se_elpd_loo p_loo  se_p_loo looic  se_looic
fit4a    0.0       0.0  -419.8     12.1        46.8    5.0    839.6   24.2  
fit3a   -0.6       1.4  -420.4     12.1        47.6    5.0    840.7   24.2  
fit1a   -1.1       1.5  -421.0     12.2        48.2    5.1    841.9   24.4  
fit2a -469.6      23.0  -889.4     22.4        10.3    3.1   1778.9   44.8  </code></pre>
</div>
</div>
<p>Model 4 is considered best, though not by much. The above results, namely faster runtime and better estimates, speak more convincingly to the fact that model 4 is the best of these. The LOO is close to the PSIS metric reported by <code>rethinking</code>, even though I don’t think it’s defined and computed exactly the same.</p>
</section>
<section id="prior-exploration" class="level2">
<h2 class="anchored" data-anchor-id="prior-exploration">Prior exploration</h2>
<p>Since <code>brms</code> has a way of specifying the model and priors that makes direct mapping to the mathematical model a bit more opaque, it is useful to explore if the models we run are what we think we run. <code>brms</code> has two helpful functions for looking at priors. One can help set priors before fitting, the other shows priors after fitting. To make the output manageable, we look at the simplest model, model 2. This looks as follows</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">#defining model again</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>m2aeqs <span class="ot">&lt;-</span> <span class="fu">bf</span>(outcome <span class="sc">~</span> <span class="fu">exp</span>(alpha)<span class="sc">*</span><span class="fu">log</span>(time) <span class="sc">-</span> <span class="fu">exp</span>(beta)<span class="sc">*</span>time,</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  alpha <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> dose_adj,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  beta  <span class="sc">~</span>  <span class="dv">1</span> <span class="sc">+</span> dose_adj,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">nl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>preprior2 <span class="ot">&lt;-</span> <span class="fu">get_prior</span>(m2aeqs,<span class="at">data=</span>fitdat,<span class="at">family=</span><span class="fu">gaussian</span>())</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>postprior2 <span class="ot">&lt;-</span> <span class="fu">prior_summary</span>(fit2)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(preprior2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               prior class      coef group resp dpar nlpar lb ub       source
 student_t(3, 0, 23) sigma                                  0         default
              (flat)     b                           alpha            default
              (flat)     b  dose_adj                 alpha       (vectorized)
              (flat)     b Intercept                 alpha       (vectorized)
              (flat)     b                            beta            default
              (flat)     b  dose_adj                  beta       (vectorized)
              (flat)     b Intercept                  beta       (vectorized)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(postprior2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           prior class      coef group resp dpar nlpar lb ub  source
          (flat)     b                           alpha       default
  normal(0.3, 1)     b  dose_adj                 alpha          user
    normal(2, 2)     b Intercept                 alpha          user
          (flat)     b                            beta       default
 normal(-0.3, 1)     b  dose_adj                  beta          user
  normal(0.5, 2)     b Intercept                  beta          user
    cauchy(0, 1) sigma                                  0       user</code></pre>
</div>
</div>
<p>The first output shows the priors as the model sees them, before we apply any settings. It uses defaults. The second output shows the actual priors used when fitting the model, which are the ones we set. I find these functions and the information useful, but overall it’s still a bit confusing to me. For instance why are there those <code>flat</code> entries in there? I don’t know what they mean.</p>
<p>It gets worse for bigger models, and here things get confusing to me. This is looking at the priors for models 1,3 and 4. Recall that we expect <span class="math inline">\(2(N+1)+1\)</span> priors for models 1 and 3, and <span class="math inline">\(2(N+1+1)+1\)</span> for model 4. Since our data has 24 samples, we should find 51 and 53 priors. Here is what we get:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>postprior1 <span class="ot">&lt;-</span> <span class="fu">prior_summary</span>(fit1)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>postprior3 <span class="ot">&lt;-</span> <span class="fu">prior_summary</span>(fit3)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>postprior4 <span class="ot">&lt;-</span> <span class="fu">prior_summary</span>(fit4)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="fu">nrow</span>(postprior1),<span class="fu">nrow</span>(postprior3),<span class="fu">nrow</span>(postprior4)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "53 53 13"</code></pre>
</div>
</div>
<p>Closer inspection shows that for models 1 and 3, the priors include those strange <code>flat</code> ones that only have a class but no coefficient. My guess is those are not “real”, and thus we actually have the right number of priors/parameters. This can be checked by looking at the names of all the parameters for say model 1. Here they are:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(m1post)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] "b_alpha_id1"            "b_alpha_id2"            "b_alpha_id3"           
  [4] "b_alpha_id4"            "b_alpha_id5"            "b_alpha_id6"           
  [7] "b_alpha_id7"            "b_alpha_id8"            "b_alpha_id9"           
 [10] "b_alpha_id10"           "b_alpha_id11"           "b_alpha_id12"          
 [13] "b_alpha_id13"           "b_alpha_id14"           "b_alpha_id15"          
 [16] "b_alpha_id16"           "b_alpha_id17"           "b_alpha_id18"          
 [19] "b_alpha_id19"           "b_alpha_id20"           "b_alpha_id21"          
 [22] "b_alpha_id22"           "b_alpha_id23"           "b_alpha_id24"          
 [25] "b_alpha_dose_adj"       "b_beta_id1"             "b_beta_id2"            
 [28] "b_beta_id3"             "b_beta_id4"             "b_beta_id5"            
 [31] "b_beta_id6"             "b_beta_id7"             "b_beta_id8"            
 [34] "b_beta_id9"             "b_beta_id10"            "b_beta_id11"           
 [37] "b_beta_id12"            "b_beta_id13"            "b_beta_id14"           
 [40] "b_beta_id15"            "b_beta_id16"            "b_beta_id17"           
 [43] "b_beta_id18"            "b_beta_id19"            "b_beta_id20"           
 [46] "b_beta_id21"            "b_beta_id22"            "b_beta_id23"           
 [49] "b_beta_id24"            "b_beta_dose_adj"        "sigma"                 
 [52] "prior_b_alpha_id1"      "prior_b_alpha_id2"      "prior_b_alpha_id3"     
 [55] "prior_b_alpha_id4"      "prior_b_alpha_id5"      "prior_b_alpha_id6"     
 [58] "prior_b_alpha_id7"      "prior_b_alpha_id8"      "prior_b_alpha_id9"     
 [61] "prior_b_alpha_id10"     "prior_b_alpha_id11"     "prior_b_alpha_id12"    
 [64] "prior_b_alpha_id13"     "prior_b_alpha_id14"     "prior_b_alpha_id15"    
 [67] "prior_b_alpha_id16"     "prior_b_alpha_id17"     "prior_b_alpha_id18"    
 [70] "prior_b_alpha_id19"     "prior_b_alpha_id20"     "prior_b_alpha_id21"    
 [73] "prior_b_alpha_id22"     "prior_b_alpha_id23"     "prior_b_alpha_id24"    
 [76] "prior_b_alpha_dose_adj" "prior_b_beta_id1"       "prior_b_beta_id2"      
 [79] "prior_b_beta_id3"       "prior_b_beta_id4"       "prior_b_beta_id5"      
 [82] "prior_b_beta_id6"       "prior_b_beta_id7"       "prior_b_beta_id8"      
 [85] "prior_b_beta_id9"       "prior_b_beta_id10"      "prior_b_beta_id11"     
 [88] "prior_b_beta_id12"      "prior_b_beta_id13"      "prior_b_beta_id14"     
 [91] "prior_b_beta_id15"      "prior_b_beta_id16"      "prior_b_beta_id17"     
 [94] "prior_b_beta_id18"      "prior_b_beta_id19"      "prior_b_beta_id20"     
 [97] "prior_b_beta_id21"      "prior_b_beta_id22"      "prior_b_beta_id23"     
[100] "prior_b_beta_id24"      "prior_b_beta_dose_adj"  "prior_sigma"           
[103] "lprior"                 "lp__"                   ".chain"                
[106] ".iteration"             ".draw"                 </code></pre>
</div>
</div>
<p>We can see that there are the right number of both priors and posterior parameters, namely 2 times 24 for the individual level parameters, plus 2 dose parameters and <span class="math inline">\(\sigma\)</span>.</p>
<p>I find model 4 more confusing. Here is the full list of priors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(postprior4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           prior class      coef group resp dpar nlpar lb ub       source
          (flat)     b                           alpha            default
  normal(0.3, 1)     b  dose_adj                 alpha               user
    normal(2, 1)     b Intercept                 alpha               user
          (flat)     b                            beta            default
 normal(-0.3, 1)     b  dose_adj                  beta               user
  normal(0.5, 1)     b Intercept                  beta               user
    cauchy(0, 1)    sd                           alpha  0            user
    cauchy(0, 1)    sd                            beta  0            user
    cauchy(0, 1)    sd              id           alpha  0    (vectorized)
    cauchy(0, 1)    sd Intercept    id           alpha  0    (vectorized)
    cauchy(0, 1)    sd              id            beta  0    (vectorized)
    cauchy(0, 1)    sd Intercept    id            beta  0    (vectorized)
    cauchy(0, 1) sigma                                  0            user</code></pre>
</div>
</div>
<p>And this shows the names of all parameters</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(m4post)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] "b_alpha_Intercept"         "b_alpha_dose_adj"         
  [3] "b_beta_Intercept"          "b_beta_dose_adj"          
  [5] "sd_id__alpha_Intercept"    "sd_id__beta_Intercept"    
  [7] "sigma"                     "r_id__alpha[1,Intercept]" 
  [9] "r_id__alpha[2,Intercept]"  "r_id__alpha[3,Intercept]" 
 [11] "r_id__alpha[4,Intercept]"  "r_id__alpha[5,Intercept]" 
 [13] "r_id__alpha[6,Intercept]"  "r_id__alpha[7,Intercept]" 
 [15] "r_id__alpha[8,Intercept]"  "r_id__alpha[9,Intercept]" 
 [17] "r_id__alpha[10,Intercept]" "r_id__alpha[11,Intercept]"
 [19] "r_id__alpha[12,Intercept]" "r_id__alpha[13,Intercept]"
 [21] "r_id__alpha[14,Intercept]" "r_id__alpha[15,Intercept]"
 [23] "r_id__alpha[16,Intercept]" "r_id__alpha[17,Intercept]"
 [25] "r_id__alpha[18,Intercept]" "r_id__alpha[19,Intercept]"
 [27] "r_id__alpha[20,Intercept]" "r_id__alpha[21,Intercept]"
 [29] "r_id__alpha[22,Intercept]" "r_id__alpha[23,Intercept]"
 [31] "r_id__alpha[24,Intercept]" "r_id__beta[1,Intercept]"  
 [33] "r_id__beta[2,Intercept]"   "r_id__beta[3,Intercept]"  
 [35] "r_id__beta[4,Intercept]"   "r_id__beta[5,Intercept]"  
 [37] "r_id__beta[6,Intercept]"   "r_id__beta[7,Intercept]"  
 [39] "r_id__beta[8,Intercept]"   "r_id__beta[9,Intercept]"  
 [41] "r_id__beta[10,Intercept]"  "r_id__beta[11,Intercept]" 
 [43] "r_id__beta[12,Intercept]"  "r_id__beta[13,Intercept]" 
 [45] "r_id__beta[14,Intercept]"  "r_id__beta[15,Intercept]" 
 [47] "r_id__beta[16,Intercept]"  "r_id__beta[17,Intercept]" 
 [49] "r_id__beta[18,Intercept]"  "r_id__beta[19,Intercept]" 
 [51] "r_id__beta[20,Intercept]"  "r_id__beta[21,Intercept]" 
 [53] "r_id__beta[22,Intercept]"  "r_id__beta[23,Intercept]" 
 [55] "r_id__beta[24,Intercept]"  "prior_b_alpha_Intercept"  
 [57] "prior_b_alpha_dose_adj"    "prior_b_beta_Intercept"   
 [59] "prior_b_beta_dose_adj"     "prior_sigma"              
 [61] "prior_sd_id"               "prior_sd_id__1"           
 [63] "lprior"                    "lp__"                     
 [65] "z_1[1,1]"                  "z_1[1,2]"                 
 [67] "z_1[1,3]"                  "z_1[1,4]"                 
 [69] "z_1[1,5]"                  "z_1[1,6]"                 
 [71] "z_1[1,7]"                  "z_1[1,8]"                 
 [73] "z_1[1,9]"                  "z_1[1,10]"                
 [75] "z_1[1,11]"                 "z_1[1,12]"                
 [77] "z_1[1,13]"                 "z_1[1,14]"                
 [79] "z_1[1,15]"                 "z_1[1,16]"                
 [81] "z_1[1,17]"                 "z_1[1,18]"                
 [83] "z_1[1,19]"                 "z_1[1,20]"                
 [85] "z_1[1,21]"                 "z_1[1,22]"                
 [87] "z_1[1,23]"                 "z_1[1,24]"                
 [89] "z_2[1,1]"                  "z_2[1,2]"                 
 [91] "z_2[1,3]"                  "z_2[1,4]"                 
 [93] "z_2[1,5]"                  "z_2[1,6]"                 
 [95] "z_2[1,7]"                  "z_2[1,8]"                 
 [97] "z_2[1,9]"                  "z_2[1,10]"                
 [99] "z_2[1,11]"                 "z_2[1,12]"                
[101] "z_2[1,13]"                 "z_2[1,14]"                
[103] "z_2[1,15]"                 "z_2[1,16]"                
[105] "z_2[1,17]"                 "z_2[1,18]"                
[107] "z_2[1,19]"                 "z_2[1,20]"                
[109] "z_2[1,21]"                 "z_2[1,22]"                
[111] "z_2[1,23]"                 "z_2[1,24]"                
[113] ".chain"                    ".iteration"               
[115] ".draw"                    </code></pre>
</div>
</div>
<p>To compare directly, this is the model we want:</p>
<p><span class="math display">\[
\begin{aligned}
Y_{i,t}  &amp; \sim \mathrm{Normal}\left(\mu_{i,t}, \sigma\right) \\
\mu_{i,t} &amp;  =  \exp(\alpha_{i}) \log (t_{i}) -\exp(\beta_{i}) t_{i} \\
\alpha_{i} &amp;  =  a_{0,i} + a_1 \left(\log (D_i) - \log (D_m)\right)  \\
\beta_{i} &amp;  =  b_{0,i} + b_1 \left(\log (D_i) - \log (D_m)\right) \\
a_{0,i} &amp; \sim \mathrm{Normal}(\mu_a, \sigma_a) \\
b_{0,i} &amp; \sim \mathrm{Normal}(\mu_b, \sigma_a) \\
a_1 &amp; \sim \mathrm{Normal}(0.3, 1) \\
b_1 &amp; \sim \mathrm{Normal}(-0.3, 1) \\
\mu_a &amp; \sim \mathrm{Normal}(2, 1) \\
\mu_b &amp; \sim \mathrm{Normal}(0.5, 1) \\
\sigma &amp;  \sim \mathrm{HalfCauchy}(0,1)  \\
\sigma_a &amp; \sim \mathrm{HalfCauchy}(0,1)  \\
\sigma_b &amp; \sim \mathrm{HalfCauchy}(0,1)  
\end{aligned}
\]</span></p>
<p>If understand <code>brms</code> correctly, those <code>z_</code> parameters are internal adjustments to make things more efficient and can otherwise be ignored. That means we have 2 times 24 parameters for the individual levels that all start with <code>r_id</code>. Those correspond to the <span class="math inline">\(a_{0,i}\)</span> and <span class="math inline">\(b_{0,1}\)</span>, and they don’t have pre-defined priors, since they are computed based on other parameters. Then we have 2 dose parameters, which map to <span class="math inline">\(a_1\)</span> and <span class="math inline">\(b_1\)</span>, both come with priors. We have 2 <code>_Intercept</code> parameters, which correspond to <span class="math inline">\(\mu_a\)</span> and <span class="math inline">\(\mu_b\)</span>, again with priors. We have <span class="math inline">\(\sigma\)</span> with prior, and the two <code>sd_id</code> parameters seem to be those we call <span class="math inline">\(\sigma_a\)</span> and <span class="math inline">\(\sigma_b\)</span> in our equations.</p>
<p>So it looks like there is a match between our mathematical model we want, and the way we implemented it in <code>brms</code>. Still, I find the <code>brms</code> notation confusing and not that easy to follow. In that respect I much prefer <code>ulam/rethinking</code>.</p>
<p>In any case, I somewhat convinced myself that I’m fitting the same models here with <code>brms</code> that I’m fitting with <code>ulam</code>.</p>
</section>
</section>
<section id="computing-predictions" class="level1">
<h1>Computing predictions</h1>
<p>Looking at tables of estimates as we did so far is somewhat useful, but nothing can beat graphical inspection. So let’s plot the predictions implied by the fits for the models. The general strategy for that is to use the parameter estimates in the posterior, put them in the model, and compute the predictions. While the <code>rethinking</code> package had <code>sim</code> and <code>link</code>, for <code>brms</code> those functions are <code>fitted</code> and <code>predict</code>.</p>
<p>The code below produces predictions, both for the deterministic mean trajectory <span class="math inline">\(\mu\)</span>, and the actual outcome, <span class="math inline">\(Y\)</span>, which has added variation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co">#this will contain all the predictions from the different models</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>fitpred <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(fl))</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># load the data we used for fitting</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>simdat <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"simdat.Rds"</span>)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="co">#pull our the data set we used for fitting</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="co">#if you fit a different one of the simulated datasets, change accordingly</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>fitdat <span class="ot">&lt;-</span> simdat<span class="sc">$</span>m3</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="co">#small data adjustment for plotting</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>plotdat <span class="ot">&lt;-</span> fitdat <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">as.factor</span>(id)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">dose =</span> dose_cat)</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a><span class="co"># we are looping over each fitted model</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(fl))</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#get current model</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>  nowmodel <span class="ot">=</span> fl[[n]]<span class="sc">$</span>fit</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">#make new data for which we want predictions</span></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#specifically, more time points so the curves are smoother</span></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>  timevec <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.1</span>, <span class="at">to =</span> <span class="fu">max</span>(fitdat<span class="sc">$</span>time), <span class="at">length=</span><span class="dv">100</span>)</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>  Ntot <span class="ot">=</span> <span class="fu">max</span>(fitdat<span class="sc">$</span>id)</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#data used for predictions</span></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>  preddat <span class="ot">=</span> <span class="fu">data.frame</span>( <span class="at">id =</span> <span class="fu">sort</span>(<span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">1</span>,Ntot),<span class="fu">length</span>(timevec))),</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>                        <span class="at">time =</span> <span class="fu">rep</span>(timevec,Ntot),</span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>                        <span class="at">dose_adj =</span> <span class="dv">0</span></span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add right dose information for each individual</span></span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Ntot)</span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#dose for a given individual</span></span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>    nowdose <span class="ot">=</span> <span class="fu">unique</span>(fitdat<span class="sc">$</span>dose_adj[fitdat<span class="sc">$</span>id <span class="sc">==</span> k])</span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>    nowdose_cat <span class="ot">=</span> <span class="fu">unique</span>(fitdat<span class="sc">$</span>dose_cat[fitdat<span class="sc">$</span>id <span class="sc">==</span> k])</span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">#assign that dose</span></span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">#the categorical values are just for plotting</span></span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>    preddat[(preddat<span class="sc">$</span>id <span class="sc">==</span> k),<span class="st">"dose_adj"</span>] <span class="ot">=</span> nowdose</span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a>    preddat[(preddat<span class="sc">$</span>id <span class="sc">==</span> k),<span class="st">"dose_cat"</span>] <span class="ot">=</span> nowdose_cat</span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># estimate and CI for parameter variation</span></span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a>  <span class="co">#brms equivalent to rethinking::link</span></span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">#doing 89% CI</span></span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a>  meanpred <span class="ot">&lt;-</span> <span class="fu">fitted</span>(nowmodel, <span class="at">newdata =</span> preddat, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>) )</span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># estimate and CI for prediction intervals</span></span>
<span id="cb82-46"><a href="#cb82-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the predictions factor in additional uncertainty around the mean (mu)</span></span>
<span id="cb82-47"><a href="#cb82-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># as indicated by sigma</span></span>
<span id="cb82-48"><a href="#cb82-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this is equivalent to rethinking::sim()</span></span>
<span id="cb82-49"><a href="#cb82-49" aria-hidden="true" tabindex="-1"></a>  outpred <span class="ot">&lt;-</span> <span class="fu">predict</span>(nowmodel, <span class="at">newdata =</span> preddat, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.055</span>, <span class="fl">0.945</span>) )</span>
<span id="cb82-50"><a href="#cb82-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-51"><a href="#cb82-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-52"><a href="#cb82-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">#place all predictions into a data frame</span></span>
<span id="cb82-53"><a href="#cb82-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">#and store in a list for each model</span></span>
<span id="cb82-54"><a href="#cb82-54" aria-hidden="true" tabindex="-1"></a>  fitpred[[n]] <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">id =</span> <span class="fu">as.factor</span>(preddat<span class="sc">$</span>id),</span>
<span id="cb82-55"><a href="#cb82-55" aria-hidden="true" tabindex="-1"></a>                            <span class="at">dose =</span> <span class="fu">as.factor</span>(preddat<span class="sc">$</span>dose_cat),</span>
<span id="cb82-56"><a href="#cb82-56" aria-hidden="true" tabindex="-1"></a>                            <span class="at">predtime =</span> preddat<span class="sc">$</span>time,</span>
<span id="cb82-57"><a href="#cb82-57" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Estimate =</span> meanpred[,<span class="st">"Estimate"</span>],</span>
<span id="cb82-58"><a href="#cb82-58" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Q89lo =</span> meanpred[,<span class="st">"Q5.5"</span>],</span>
<span id="cb82-59"><a href="#cb82-59" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Q89hi =</span> meanpred[,<span class="st">"Q94.5"</span>],</span>
<span id="cb82-60"><a href="#cb82-60" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Qsimlo =</span> outpred[,<span class="st">"Q5.5"</span>],</span>
<span id="cb82-61"><a href="#cb82-61" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Qsimhi =</span> outpred[,<span class="st">"Q94.5"</span>]</span>
<span id="cb82-62"><a href="#cb82-62" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb82-63"><a href="#cb82-63" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-64"><a href="#cb82-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-65"><a href="#cb82-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-66"><a href="#cb82-66" aria-hidden="true" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb82-67"><a href="#cb82-67" aria-hidden="true" tabindex="-1"></a><span class="co"># generate plots showing data and model predictions</span></span>
<span id="cb82-68"><a href="#cb82-68" aria-hidden="true" tabindex="-1"></a><span class="do">#########################</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-plots-of-the-results" class="level1">
<h1>Creating plots of the results</h1>
<p>Now that we got the predictions computed, we can plot them and compare with the data. I’m showing the same uncertainty intervals I used for <code>rethinking</code> to make comparison easy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co">#storing all plots</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>plotlist <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(fl))</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co">#adding titles to plots</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>titles <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'model 1'</span>,<span class="st">'model 2a'</span>,<span class="st">'model 3'</span>,<span class="st">'model 4'</span>)</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co">#again looping over all models, making a plot for each</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(fl))</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ===============================================</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>  plotlist[[n]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> fitpred[[n]], <span class="fu">aes</span>(<span class="at">x =</span> predtime, <span class="at">y =</span> Estimate, <span class="at">group =</span> id, <span class="at">color =</span> dose ) ) <span class="sc">+</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>predtime, <span class="at">ymin=</span>Q89lo, <span class="at">ymax=</span>Q89hi, <span class="at">fill =</span> dose, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">alpha=</span><span class="fl">0.3</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>predtime, <span class="at">ymin=</span>Qsimlo, <span class="at">ymax=</span>Qsimhi, <span class="at">fill =</span> dose, <span class="at">color =</span> <span class="cn">NULL</span>), <span class="at">alpha=</span><span class="fl">0.1</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> plotdat, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> outcome, <span class="at">group =</span> id, <span class="at">color =</span> dose), <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">30</span>,<span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Virus load"</span>,</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"days post infection"</span>) <span class="sc">+</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(titles[n])</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="at">file =</span> <span class="fu">paste0</span>(titles[n],<span class="st">".png"</span>), plotlist[[n]], <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">width =</span> <span class="dv">7</span>, <span class="at">height =</span> <span class="dv">7</span>)</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a><span class="co"># show the plots</span></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a><span class="do">#########################</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="showing-the-plots" class="level1">
<h1>Showing the plots</h1>
<p>Here are the plots for all models we considered.</p>
<p>It’s a bit hard to see, but each plot contains for each individual the data as symbols, the estimated mean as line, and the 89% credible interval and prediction interval as shaded areas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/showplots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">3</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/showplots-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">2</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/showplots-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(plotlist[[<span class="dv">4</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/showplots-4.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Mirroring the findings from above, the models produce very similar results, especially models 1,3 and 4. Model 2a shows the feature of having very wide prediction intervals, due to the fact that it can’t account for individual-level variation in the main model.</p>
</section>
<section id="summary-and-continuation" class="level1">
<h1>Summary and continuation</h1>
<p>To sum it up, we repeated our previous fitting, now using the <code>brms</code> package instead of <code>rethinking</code>. While the two packages have different syntax, the models we fit are the same and thus the results are very close too. That’s comforting. If one approach had produced very different results, it would have meant something was wrong. Of course, as I was writing this series of posts, that happened many times and it took me a while to figure out how to get <code>brms</code> to do what I wanted it to 😁.</p>
<p>As of this writing, the one issue I’m almost but not yet fully certain about is if I really have a full match between my mathematical models and the <code>brms</code> implementations (I’m fairly certain the math and <code>ulam</code> implementations match). Though the comparison between <code>ulam</code> and <code>brms</code> results do suggest that I’m running the same models.</p>
<p>Overall, I like the approach of using both packages. It adds an extra layer of robustness. The <code>rethinking</code> code is very close to the math and thus quickly implemented and probably a good first step. <code>brms</code> has some features that go beyond what <code>rethinking</code> can (easily) do, so moving on to re-implementing models in <code>brms</code> and using that code for producing the final results can make sense.</p>
<p>This ends the main part of the tutorial (for now). There were several topics I wanted to discuss that didn’t fit here. If you are interested in some further musings, you can hop to <a href="../../posts/longitudinal-multilevel-bayesian-analysis-4/">this post</a>, where I discuss a few further topics and variations.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{handel2022,
  author = {Andreas Handel},
  title = {Bayesian Analysis of Longitudinal Multilevel Data Using Brms
    and Rethinking - Part 3},
  date = {2022-02-24},
  url = {https://www.andreashandel.com/posts/2022-02-24-longitudinal-multilevel-bayes-3},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-handel2022" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Andreas Handel. 2022. <span>“Bayesian Analysis of Longitudinal
Multilevel Data Using Brms and Rethinking - Part 3.”</span> February 24,
2022. <a href="https://www.andreashandel.com/posts/2022-02-24-longitudinal-multilevel-bayes-3">https://www.andreashandel.com/posts/2022-02-24-longitudinal-multilevel-bayes-3</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="andreashandel/andreashandelwebsite" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left"><i class="fa-regular fa-copyright" aria-hidden="true"></i> Andreas Handel, 2022<br> All content licensed under <i class="fa-brands fa-creative-commons" aria-hidden="true"></i> <i class="fa-brands fa-creative-commons-by" aria-hidden="true"></i> <i class="fa-brands fa-creative-commons-sa" aria-hidden="true"></i> <i class="fa-brands fa-creative-commons-nc" aria-hidden="true"></i> <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">(CC BY-NC-SA 4.0)</a></div>   
      <div class="nav-footer-center"><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">Made with <i class="fa-brands fa-r-project" aria-hidden="true"></i> and <a href="https://quarto.org/">Quarto</a><br> Inspiration and code snippets taken from <a href="../../posts/quarto-website-migration.html">these folks.</a><br> <a href="https://github.com/andreashandel/andreashandelwebsite">Source at <i class="fa-brands fa-github" aria-hidden="true"></i> GitHub</a></div>
  </div>
</footer>



</body></html>