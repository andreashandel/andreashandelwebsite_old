{
  "hash": "222867f667b5d5569a6ebc0d684bf44c",
  "result": {
    "markdown": "---\ntitle: Exploring the `flowdiagramr` R package  \ndescription: A brief post showing how to use the `flowdiagramr` R package to make flowcharts.\nauthor: Andreas Handel\ndate: '2022-06-11'\naliases: \n  - ../flowdiagramr-R-package/\ncategories: \n- R Package\n- Visualization\nfeatured: no\nimage: \"featured.png\"\n---\n\n\n\n\n\n# Motivation\n\nFor a while now, we've been working on an R package called [`flowdiagramr`](https://andreashandel.github.io/flowdiagramr/) which lets you create flow diagrams in `R`. The main reason we wrote this package is because while there are other `R` packages that can generate diagrams, I couldn't find one that allowed me to create flow diagrams for the kind of compartmental simulation models that I often use in research and teaching. For instance right now, all model diagrams in my population-level and within-host modeling packages [DSAIDE](https://ahgroup.github.io/DSAIDE/) and [DSAIRM](https://ahgroup.github.io/DSAIRM/) are drawn by hand.\n\nWhile the main focus of `flowdiagramr` is to produce diagrams for those kind of dynamical process models with feedback loops, it can also be used to create other flow diagrams.\n\nAs of this writing, we are preparing for an initial CRAN submission. I've been updating the package vignettes with hopefully useful examples. By chance, I recently came across a tweet by [Nicola Rennie](https://nrennie.rbind.io/) pointing to [this blog post](https://nrennie.rbind.io/blog/2022-06-06-creating-flowcharts-with-ggplot2/) she wrote. The blog post shows how to make a nice flow diagram using `ggplot2()`. \n\nI figured it would be fun to try and redo this using `flowdiagramr`. The following post shows that attempt.\n\n\n# Who this is (not) for\n\nIf you are interested in making diagrams using R and are looking for an option that might do things that current packages such as `diagrammR` or others can't do, you might want to follow along. \n\nThe [`flowdiagramr` package](https://andreashandel.github.io/flowdiagramr/) has (in my biased opinion) fairly decent documentation and vignettes. I'm not going to repeat all that here. I basically assume that if you want to try this out, you go to the package website and skim through the first few vignettes to get an idea of how things work. Then come back here. Or first skim through this post, then if you want, go and explore the package vignettes more.\n\n\n# General setup\n\nThe following shows code and my comments mixed together. It's often useful to go slow and type your own code, or copy and paste the code chunks below and execute one at a time. However, if you are in a hurry, you can find all the code shown below in [this file](flowdiagramr-exploration.R).\n\n\nFirst we load all needed packages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary('ggplot2')\nlibrary('flowdiagramr')\nlibrary('sysfonts') #for extra fonts\nlibrary('showtext') #for extra fonts\n```\n:::\n\n\n\n# Diagram setup\n\nNow we specify the model. Generally, a model consists of variables/compartments/boxes and flows/arrows connecting the boxes. \nThis code chunk defines the variables/boxes, gives them names (used later), and provides the box grid layout as a matrix.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# the unique internal labels, just abbreviations of the full names\nvariables = c(\"GL\",\"P\",\"PTH\",\"PTC\",\"PJR\",\n              \"C\",\"CTB\",\"CTS\",\"CJR\",\n              \"B\",\"BTH\",\"BTS\",\"BJR\",\n              \"BE\")\n# the eventual names for all boxes\n# we'll use that later to label the boxes\nvarnames = c(\"Goldilocks\",\n             \"Porridge\",\n             \"Too hot\",\"Too cold\",\"Just right\",\n             \"Chairs\",\n             \"Too big\", \"Too small\", \"Just right\",\n             \"Beds\",\n             \"Too hard\",\"Too soft\",\"Just right\",\n             \"Bears!\")\n# assigning the varnames the variable labels\n# needed later\nnames(varnames) <- variables\n# a matrix specifying the locations on a matrix grid layout\n# this mimics the look of the original blog post\nvarlocations = matrix(data = c(\"\",\"GL\", \"\", \"\", \"\",\n                               \"\",\"P\", \"\", \"\", \"\",\n                               \"PTH\",\"PTC\", \"PJR\", \"\", \"\",\n                               \"\",   \"\",    \"C\", \"\", \"\",\n                               \"\",\"CTB\",  \"CTS\", \"CJR\", \"\",\n                               \"\",   \"\",   \"\",   \"B\", \"\",\n                               \"\",   \"\", \"BTH\", \"BTS\", \"BJR\",\n                               \"\",   \"\", \"\",     \"\", \"BE\"\n                      ), ncol = 5, byrow = TRUE)\n```\n:::\n\n\nThe second component of every model are the flows between compartments/variables/boxes. Since `flowdiagramr` has as underlying logic the idea that flows occur between compartments, one needs to set up things as processes in such a way.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# setting up the inflows and outflows (arrows) for each box\nflows = list( GL_flows = c(\"-k1*GL\"),\n              P_flows = c(\"k1*GL\",\"-k2*P\",\"-k3*P\",\"-k4*P\"),\n              PTH_flows = c(\"k2*P\"),\n              PTC_flows = c(\"k3*P\"),\n              PJR_flows = c(\"k4*P\",\"-k5*PJR\"),\n              C_flows = c(\"k5*PJR\",\"-k6*C\",\"-k7*C\",\"-k8*C\"),\n              CTB_flows = c(\"k6*C\"),\n              CTS_flows = c(\"k7*C\"),\n              CJR_flows = c(\"k8*C\",\"-k9*CJR\"),\n              B_flows = c(\"k9*CJR\",\"-k10*B\",\"-k11*B\",\"-k12*B\"),\n              BTH_flows = c(\"k10*B\"),\n              BTS_flows = c(\"k11*B\"),\n              BJR_flows = c(\"k12*B\",\"-k13*BJR\"),\n              BE_flows = c(\"k13*BJR\")\n)\n```\n:::\n\n\n\n# Diagram preparation\n\nThe first step for each `flowdiagramr` diagram is the preparation stage using the `prepare_diagram()` function. For that, one needs to supply the model as a list of variables and flows (boxes and arrows) and optional layout specifications.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# model object\ngl_model = list(variables = variables, flows = flows)\n# model layout\nmodel_settings = list(varlocations=varlocations,\n                      varbox_x_size = 3)\n# prepare model\ngl_list = flowdiagramr::prepare_diagram(gl_model, model_settings)\n```\n:::\n\n\n# Diagram styling\n\nThe return from `prepare_diagram` is a list of data frames containing information about the variables and flows needed for plotting. One could go straight to making the diagram with `make_diagram`. But we already know the default doesn't look like the blog post, therefore we apply some styling, which is done with the `update_diagram` function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#set colors that are similar to original blog post\nvarcolors = c(\"#b59dac\", rep(c(\"#D9AF6B\", \"#ACACAC\",\"#ACACAC\",\"#ACACAC\"),3), \"#b59dac\")\n# make them a named vector since that's required by update_diagram\nnames(varcolors) = variables\n# list of all style updates we want\ndiagram_settings = list(var_fill_color = varcolors,\n                        var_label_text = varnames,\n                        var_label_color = c(all =  \"#585c45\"),\n                        flow_show_label = c(all = FALSE),\n                        var_label_size = c(all = 4))\n\n# update the look\ngl_list2 <- flowdiagramr::update_diagram(gl_list,diagram_settings)\n```\n:::\n\n\n\n# Diagram generation\n\nNow we can make and plot the diagram\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create and plot diagram\ngl_diag <- flowdiagramr::make_diagram(gl_list2)\nplot(gl_diag)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/makediag-1.png){width=672}\n:::\n:::\n\n\nThe result looks somewhat similar to the original, but not quite yet.\n\n\n# More diagram styling\n\nThe above is as far as we can get with `flowdiagramr`. The good news is that the created object is a a regular `ggplot` object and thus we can modify it further using `ggplot2` code. A lot of this follows the original blog post, see there for details.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get different fonts\nsysfonts::font_add_google(name = \"Henny Penny\", family = \"henny\")\nshowtext::showtext_auto()\n\n# update the plot by adding ggplot2 commands\ngl_diag2 <- gl_diag  +\n       labs(title = \"The Goldilocks Decision Tree\",\n            caption = \"Made with flowdiagramr:\\n https://andreashandel.github.io/flowdiagramr/\") +\n       theme_void() +\n        theme(plot.margin = unit(c(1, 1, 0.5, 1), \"cm\"),\n        legend.position = \"none\",\n        plot.background = element_rect(colour = \"#f2e4c1\", fill = \"#f2e4c1\"),\n        panel.background = element_rect(colour = \"#f2e4c1\", fill = \"#f2e4c1\"),\n        plot.title = element_text(family = \"henny\", hjust = 0, face = \"bold\",\n                                  size = 45, color = \"#585c45\",\n                                  margin = margin(t = 10, r = 0, b = 10, l = 0)),\n        plot.caption = element_text(family = \"henny\", hjust = 0,\n                                    size = 16, color = \"#585c45\",\n                                    margin = margin(t = 10)),\n       text = element_text(family = \"henny\")\n       )\n```\n:::\n\n\nNow we can plot it again\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(gl_diag2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plotupdate-1.png){width=672}\n:::\n:::\n\n\nThis plot is fairly close. I'm skipping the addition of the image since that was done manually.\n\nOne aspect that isn't working is having the font in the boxes be the the `henry` style. I did try to supply it by setting `text = element_text(family = \"henny\")`, but it seems that doesn't work after one has already written the text. I'm not aware of a way to update text in an ggplot once it's already placed (I wouldn't be surprised if that's possible, I just don't know how.) Fortunately, we can fix that in a different way.\n\n\n# Even more diagram styling\n\nLet's see if we can fix the font issue. While setting the font through `update_diagram` is on the to-do list, as of this writing, this feature does not yet exist (contributions welcome 😁).\n\nWe can however ask `flowdiagramr` to write all the `ggplot2` code that produces the diagram into a file, then modify ourselves.\n\nThis writes the full ggplot code to an R script file:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_diagram(gl_list2,filename = \"gl_diag.R\", always_overwrite = TRUE)\n```\n:::\n\n\nNow we can open that file, find the part that creates the text for the boxes (that part starts with \"add label text\") and simply add this part `family = \"henny\"` into the `geom_text()` statement. We'll also copy the commands from above to the end of the script to update the `diagram_plot` object. Then we'll save the updated file, source it, and thus have an updated diagram. [Here](gl_diag_mod.R) is the updated script if it's not clear what I'm doing.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsource(\"gl_diag_mod.R\")\n# plot new diagram\nplot(diagram_plot)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/newdiagcode-1.png){width=672}\n:::\n:::\n\n\nSo that worked, very close to the original!\n\n\n\n# A bit more exploration\n\nFor this specific diagram, using `flowdiagramr` is maybe not that much better than the original version. However, once one wants to include further features, including loops, `flowdiagramr` shows its strength. To illustrate this, let's add a flows that shows that after Goldilock sits in the right chair, it induces hunger and she eats more porridge. (Yes, it's silly, but I want to show how that can easily be implemented with `flowdiagramr`). \n\nTo show that, we update the flows as follows\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# need to define again since the above file overwrote it\nvariables = c(\"GL\",\"P\",\"PTH\",\"PTC\",\"PJR\",\n              \"C\",\"CTB\",\"CTS\",\"CJR\",\n              \"B\",\"BTH\",\"BTS\",\"BJR\",\n              \"BE\")\n\n# more complex flows\nflowsnew = list( GL_flows = c(\"-k1*GL\"),\n              P_flows = c(\"k1*GL\",\"-k2*P\",\"-k3*P\",\"-k4*P\",\"-kk1*P*CJR\"),\n              PTH_flows = c(\"k2*P\",\"k3a*PTC\"),\n              PTC_flows = c(\"k3*P\",\"-k3a*PTC\"),\n              PJR_flows = c(\"k4*P\",\"-k5*PJR\",\"kk1*P*CJR\"),\n              C_flows = c(\"k5*PJR\",\"-k6*C\",\"-k7*C\",\"-k8*C\"),\n              CTB_flows = c(\"k6*C\"),\n              CTS_flows = c(\"k7*C\"),\n              CJR_flows = c(\"k8*C\",\"-k9*CJR\"),\n              B_flows = c(\"k9*CJR\",\"-k10*B\",\"-k11*B\",\"-k12*B\"),\n              BTH_flows = c(\"k10*B\"),\n              BTS_flows = c(\"k11*B\"),\n              BJR_flows = c(\"k12*B\",\"-k13*BJR\"),\n              BE_flows = c(\"k13*BJR\")\n)\n```\n:::\n\n\n\nThen we do the above steps to create the diagram:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# model object\ngl_model_new = list(variables = variables, flows = flowsnew)\n# model layout\nmodel_settings = list(varlocations=varlocations,\n                      varbox_x_size = 3)\n# prepare model\ngl_list_new = flowdiagramr::prepare_diagram(gl_model_new, model_settings)\n# update the look\ngl_list_new2 <- flowdiagramr::update_diagram(gl_list_new,diagram_settings)\n# create and plot diagram\ngl_diag_new <- flowdiagramr::make_diagram(gl_list_new2)\nplot(gl_diag_new)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/preparemakenew-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggsave('featured.png',diagram_plot)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSaving 7 x 5 in image\n```\n:::\n:::\n\n\nI'm skipping the font adjustment and other parts, but of course you can apply that again. This ability to create feedback loops - which are very common in scientific process/simulation/mechanistic models - is the reason we built `flowdiagramr`. But as you saw, it can be used for all kinds of diagrams.\n\n\n# Further resources\n\nThe [`flowdiagramr` website](https://andreashandel.github.io/flowdiagramr/) has a bunch of vignettes/tutorials with lots of examples and further use cases. If you are intrigued by this post, go check it out 😄.\n\n\n# Acknowledgments\n\nDevelopment of `flowdiagramr` is a joint effort between myself and [Andrew Tredennick](https://atredennick.github.io/), who did the majority of the actual coding work.\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}